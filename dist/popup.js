(()=>{"use strict";const e={WS:{URL:"wss://watch.toper.dev/ws",MAX_RECONNECT_ATTEMPTS:10,RECONNECT_DELAY_MS:3e3},FEATURES:{DEBUG_LOGGING:!0,AUTO_SYNC:!0,P2P_FALLBACK:!0},LOG_LEVEL:"info"};e.WS.URL;let t,n,o,s,r,i,a,d,c,l,m,u,p,g,f,y,h,E,v,I,b,L,w,C,x,T,P,R,S,B,$,U,k={isConnected:!1,roomId:null,userId:null,hasLocalStream:!1},A=null;async function M(){return new Promise(e=>{if(chrome?.storage?.local)return void chrome.storage.local.get(["tandemUsername"],t=>{A=t.tandemUsername||"",A||(A=_(),chrome.storage.local.set({tandemUsername:A},()=>{})),T&&"true"!==T.contentEditable&&(T.textContent=A),e(A)});const t=localStorage.getItem("tandemUsername")||"";A=t||_(),localStorage.setItem("tandemUsername",A),T&&"true"!==T.contentEditable&&(T.textContent=A),e(A)})}function _(){const e=new Uint32Array(1);return crypto.getRandomValues(e),`user-${e[0].toString(36).slice(0,4)}`}async function N(){const e=(T?.textContent||"").trim()||_();return A=e,new Promise(t=>{const n=()=>{C&&C.classList.add("hidden"),R&&R.classList.remove("hidden"),T&&(T.contentEditable="false",T.textContent=e),chrome.runtime.sendMessage({type:"UPDATE_USERNAME",username:e},()=>{}),t(e)};chrome?.storage?.local?chrome.storage.local.set({tandemUsername:e},n):(localStorage.setItem("tandemUsername",e),n())})}let j=!1;function O(){t=document.getElementById("status"),n=document.getElementById("status-text"),o=document.getElementById("status-controls"),s=document.getElementById("controls-section"),r=document.getElementById("join-section"),i=document.getElementById("party-info"),a=document.getElementById("stats-section"),d=document.getElementById("video-section"),c=document.getElementById("start-btn"),l=document.getElementById("stop-btn"),m=document.getElementById("share-link"),u=document.getElementById("room-code-display"),p=document.getElementById("room-code-input"),g=document.getElementById("join-room-btn"),f=document.getElementById("user-display"),y=document.getElementById("local-time"),h=document.getElementById("sync-status"),E=document.getElementById("remote-users-list"),v=document.getElementById("local-video"),I=document.getElementById("remote-video"),b=document.getElementById("copy-link-btn"),L=document.getElementById("copy-code-btn"),w=document.getElementById("copy-pin-btn"),C=document.getElementById("save-username-btn"),x=document.getElementById("server-url"),T=document.getElementById("user-display"),P=document.getElementById("username-container"),R=document.getElementById("edit-username-btn"),S=document.getElementById("toggle-mic-btn"),B=document.getElementById("toggle-video-btn"),$=document.getElementById("room-pin-input"),U=document.getElementById("room-pin-display")}try{console.log("[Popup] Signaling server configured at:",e.WS.URL)}catch(e){console.warn("[Popup] Could not load config:",e)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{O(),X(),Y(),M().then(()=>{K(),te()})}):(O(),X(),Y(),M().then(()=>{K(),te()}));let D=null,G=null,z=null;function F(t,n){return new Promise(async o=>{try{const s=e.WS.URL.replace("wss://","https://").replace("/ws",""),r=await async function(t){try{const n=e.WS.URL.replace("wss://","https://").replace("/ws",""),o=await fetch(`${n}/api/short-id/${encodeURIComponent(t)}`);if(!o.ok)throw new Error(`Failed to get short ID: ${o.statusText}`);return(await o.json()).shortId}catch(e){return console.warn("[Popup] Could not get short ID from server, using fallback:",e),t.substring(0,8)}}(t);o(`${s}/room/${r}${n?"/"+n:""}`)}catch(e){console.error("[Popup] Error building share link:",e),o("https://watch.toper.dev/room/unknown")}})}async function W(){const t=p.value.trim();if(!t)return void alert("Please enter a room code");const n=function(e){if(!e)return{type:"empty"};const t=e.trim(),n=t.match(/[?&]tandemRoom=([^&]+)/i);if(n)return{type:"roomId",roomId:decodeURIComponent(n[1])};const o=t.match(/\/room\/([a-z0-9]+)/i);if(o)return{type:"shortId",shortId:o[1]};if(t.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i))return{type:"roomId",roomId:t};const s=t.match(/^([a-z0-9]{3,})$/i);return s?{type:"shortId",shortId:s[1]}:{type:"invalid"}}(t);if("invalid"!==n.type&&"empty"!==n.type){g.disabled=!0;try{let t=null;if("roomId"===n.type)t=n.roomId;else{const o=e.WS.URL.replace(/^wss?:\/\//,"https://").replace(/\/ws$/,"");t=await async function(e,t){try{const n=await fetch(`${e}/api/room/${encodeURIComponent(t)}`);if(!n.ok)throw new Error("Room code not found");if((n.headers.get("content-type")||"").includes("application/json")){const e=await n.json();if(e&&e.roomId)return e.roomId}else{const e=await n.text();if(!e.includes("Signaling server running"))throw new Error(`Unexpected response from server: ${e.slice(0,160)}`)}}catch(e){if("Room code not found"===e?.message)throw e}const n=(await fetch(`${e}/room/${encodeURIComponent(t)}`,{redirect:"manual"})).headers.get("location");if(n){const e=n.match(/[?&]tandemRoom=([^&]+)/i);if(e)return decodeURIComponent(e[1])}throw new Error("Room codes are not supported on this server. Ask the host for a full Netflix link with ?tandemRoom=... or update the signaling server.")}(o,n.shortId)}const o=$?.value?.trim()||null;chrome.runtime.sendMessage({type:"START_PARTY",roomId:t,username:A,pin:o},e=>{g.disabled=!1,e&&e.success?(p.value="",$&&($.value=""),setTimeout(K,500)):alert("Error: "+(e&&e.error?e.error:"Failed to join party"))})}catch(e){console.error("[Popup] Error joining room:",e),alert("Failed to join room: "+e.message),g.disabled=!1}}else alert("Please enter a valid room code or share link")}function Y(){j||(j=!0,c&&c.addEventListener("click",J),l&&l.addEventListener("click",Q),b&&b.addEventListener("click",Z),L&&L.addEventListener("click",()=>{z&&(navigator.clipboard.writeText(z),L.textContent="‚úì",setTimeout(()=>{L.textContent="Copy"},1500))}),w&&w.addEventListener("click",()=>{k.pin&&(navigator.clipboard.writeText(k.pin),w.textContent="‚úì",setTimeout(()=>{w.textContent="Copy"},1500))}),g&&g.addEventListener("click",W),p&&p.addEventListener("keypress",e=>{"Enter"===e.key&&W()}),C&&C.addEventListener("click",N),S&&S.addEventListener("click",()=>q("audio")),B&&B.addEventListener("click",()=>q("video")),R&&R.addEventListener("click",()=>{if(T){T.contentEditable="true",T.focus();const e=document.createRange();e.selectNodeContents(T);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}R&&R.classList.add("hidden"),C&&C.classList.remove("hidden")}),C&&C.addEventListener("click",N),T&&T.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),N()),"Escape"===e.key&&(T.contentEditable="false",T.textContent=A,C&&C.classList.add("hidden"),R&&R.classList.remove("hidden"))}))}function V(e,t){chrome.tabs.query({url:"https://www.netflix.com/*"},n=>{n&&0!==n.length?chrome.tabs.sendMessage(n[0].id,e,e=>{chrome.runtime.lastError?t&&t({success:!1,error:chrome.runtime.lastError.message}):t&&t(e)}):t&&t({success:!1,error:"No Netflix tab found"})})}function H(e){if(e){if(S){const t=e.audioEnabled;S.textContent=t?"üé§":"üîá",S.setAttribute("aria-label",t?"Mute mic":"Unmute mic"),S.setAttribute("title",t?"Mute mic":"Unmute mic"),S.classList.toggle("active",!t)}if(B){const t=e.videoEnabled;B.textContent=t?"üì∑":"üö´üì∑",B.setAttribute("aria-label",t?"Turn off camera":"Turn on camera"),B.setAttribute("title",t?"Turn off camera":"Turn on camera"),B.classList.toggle("active",!t)}}}function q(e){V({type:"audio"===e?"TOGGLE_MIC":"TOGGLE_CAMERA"},e=>{e&&e.success?H(e.state):console.warn("[Popup] Media toggle failed:",e?.error)})}function K(){chrome.runtime.sendMessage({type:"GET_STATUS"},e=>{chrome.runtime.lastError||e&&(k=e,X())})}function X(){if(!(t&&n&&o&&r&&c&&l&&i&&a&&d&&f))return void console.warn("[Popup] UI elements not ready, skipping update");const{isConnected:e,roomId:p,userId:g}=k;if(e){t&&(t.classList.remove("hidden"),t.className="status connected status-minimal"),n.textContent="üü¢ Connected",o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden"),r.classList.add("hidden"),c.classList.add("hidden"),l.classList.remove("hidden"),i.classList.remove("hidden"),a.classList.remove("hidden");const e=A||g;f&&"true"!==f.contentEditable&&(f.textContent=e),m&&k.roomId&&(k.roomId===D&&G?(m.textContent=G,u&&z&&(u.textContent=z),U&&k.pin&&(U.textContent=k.pin)):F(k.roomId,k.pin).then(e=>{D=k.roomId,G=e,m.textContent=e;const t=e.match(/\/room\/([a-z0-9]+)/i);t&&u&&(z=t[1],u.textContent=z),U&&k.pin&&(U.textContent=k.pin)})),ne(),V({type:"GET_MEDIA_STATE"},e=>{e&&e.success&&H(e.state)})}else t&&(t.classList.add("hidden"),t.className="status disconnected status-minimal"),n.textContent="üî¥ Disconnected",o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden"),r.classList.remove("hidden"),c.classList.remove("hidden"),l.classList.add("hidden"),i.classList.add("hidden"),a.classList.add("hidden"),d.classList.add("hidden"),v.srcObject=null,I.srcObject=null}async function J(){c.disabled=!0,n.textContent="‚è≥ Connecting...";const e=Math.floor(1e5+9e5*Math.random()).toString();chrome.runtime.sendMessage({type:"START_PARTY",username:A,pin:e},e=>{e.success?setTimeout(K,500):(alert("Error: "+e.error),n.textContent="üî¥ Disconnected",c.disabled=!1)})}function Q(){chrome.runtime.sendMessage({type:"STOP_PARTY"},()=>{K()})}function Z(){k.roomId&&F(k.roomId,k.pin).then(e=>{navigator.clipboard.writeText(e),b&&(b.textContent="‚úì",setTimeout(()=>{b.textContent="Copy"},2e3))})}const ee=e=>{if(null==e)return"--:--";const t=Math.floor(e);return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`};function te(){K(),setInterval(K,2e3),setInterval(()=>{k.isConnected&&ne()},1e3)}async function ne(){if(k.isConnected&&k.roomId)try{const t=e.WS.URL.replace(/^ws:\/\//,"http://").replace(/^wss:\/\//,"https://").replace(/\/ws$/,"")+"/status";console.log("[Popup] Fetching stats from server:",t,"at",(new Date).toISOString());const n=await fetch(t);if(!n.ok)return void console.error("[Popup] Failed to fetch server status:",n.status,n.statusText);const o=await n.json();console.log("[Popup] Server status received at",(new Date).toISOString(),":",o),console.log("[Popup] Looking for room:",k.roomId);const s=o.rooms?.find(e=>e.roomId===k.roomId);if(!s)return console.log("[Popup] Room not found on server. Available rooms:",o.rooms?.map(e=>e.roomId)),void(h&&(h.textContent="Not Found",h.style.color="#ef4444"));if(console.log("[Popup] Room found:",s),console.log("[Popup] Room currentTime:",s.currentTime,"isPlaying:",s.isPlaying),console.log("[Popup] Room users:",s.users),y){const e=ee(s.currentTime);console.log("[Popup] Updating local time from",y.textContent,"to",e),y.textContent=e}else console.log("[Popup] localTimeEl not found!");if(h){const e=s.isPlaying?"Playing":"Paused";console.log("[Popup] Setting sync status to:",e),h.textContent=e,h.style.color=s.isPlaying?"#4ade80":"#fbbf24"}else console.log("[Popup] syncStatusEl not found!");if(E){const e=s.users||[];if(0===e.length)E.innerHTML='<div style="color: rgba(255,255,255,0.5); font-size: 12px; font-style: italic;">No users in party</div>';else{const t=e.map((e,t)=>{const n=Math.abs(e.currentTime-s.currentTime),o=n>2,r=e.isPlaying?"#4ade80":"#fbbf24",i=o?"#ef4444":"#4ade80",a=e.userId===k.userId;return`\n            <div style="padding: 8px; border-top: ${a?"1px solid rgba(167, 139, 250, 0.3)":"1px solid rgba(255,255,255,0.1)"}; background-color: ${a?"rgba(167, 139, 250, 0.1)":"transparent"}; ${0===t?"border-top: none;":""}">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <div style="font-weight: 600; font-size: 12px; color: rgba(82, 82, 82, 0.9);">\n                  ${a?A||e.username||"You":e.username||`${e.userId.substring(0,8)}...`}${a?" (You)":""}\n                </div>\n                <div style="font-size: 10px; color: ${r};">\n                  ${e.isPlaying?"‚ñ∂":"‚è∏"}\n                </div>\n              </div>\n              <div style="display: flex; justify-content: space-between; align-items: center;">\n                <div style="font-size: 13px; font-weight: 600; color: #a78bfa;">\n                  ${ee(e.currentTime)}\n                </div>\n                <div style="font-size: 10px; color: ${i}; font-weight: 600;">\n                  ${o?`¬±${n.toFixed(1)}s`:"‚úì synced"}\n                </div>\n              </div>\n            </div>\n          `}).join("");E.innerHTML=`\n          <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px; color: rgba(255,255,255,0.7);">\n            ${e.length} user${1===e.length?"":"s"} in party\n          </div>\n          ${t}\n        `}}}catch(e){console.error("[Popup] Error fetching stats:",e)}else console.log("[Popup] Not connected or no room ID",{isConnected:k.isConnected,roomId:k.roomId})}chrome.runtime.onMessage.addListener(e=>{"REMOTE_STREAM_RECEIVED"===e.type&&(I.srcObject=e.stream)})})();
//# sourceMappingURL=popup.js.map