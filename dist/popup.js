(()=>{"use strict";const e={WS:{URL:"wss://watch.toper.dev/ws",MAX_RECONNECT_ATTEMPTS:10,RECONNECT_DELAY_MS:3e3},FEATURES:{DEBUG_LOGGING:!0,AUTO_SYNC:!0,P2P_FALLBACK:!0},LOG_LEVEL:"info"};e.WS.URL;let t,n,o,s,r,i,d,a,c,l,m,u,g,p,f,y,h,E,v,I,b,L,w,C,T,x,P,R,S,$,B={isConnected:!1,roomId:null,userId:null,hasLocalStream:!1},k=null;async function U(){return new Promise(e=>{if(chrome?.storage?.local)return void chrome.storage.local.get(["tandemUsername"],t=>{k=t.tandemUsername||"",k||(k=A(),chrome.storage.local.set({tandemUsername:k},()=>{})),x&&"true"!==x.contentEditable&&(x.textContent=k),e(k)});const t=localStorage.getItem("tandemUsername")||"";k=t||A(),localStorage.setItem("tandemUsername",k),x&&"true"!==x.contentEditable&&(x.textContent=k),e(k)})}function A(){return`user-${Math.random().toString(36).slice(2,6)}`}async function M(){const e=(x?.textContent||"").trim()||A();return k=e,new Promise(t=>{const n=()=>{C&&C.classList.add("hidden"),R&&R.classList.remove("hidden"),x&&(x.contentEditable="false",x.textContent=e),chrome.runtime.sendMessage({type:"UPDATE_USERNAME",username:e},()=>{}),t(e)};chrome?.storage?.local?chrome.storage.local.set({tandemUsername:e},n):(localStorage.setItem("tandemUsername",e),n())})}let _=!1;function N(){t=document.getElementById("status"),n=document.getElementById("status-text"),o=document.getElementById("status-controls"),s=document.getElementById("controls-section"),r=document.getElementById("join-section"),i=document.getElementById("party-info"),d=document.getElementById("stats-section"),a=document.getElementById("video-section"),c=document.getElementById("start-btn"),l=document.getElementById("stop-btn"),m=document.getElementById("reset-btn"),u=document.getElementById("share-link"),g=document.getElementById("room-code-display"),p=document.getElementById("room-code-input"),f=document.getElementById("join-room-btn"),y=document.getElementById("user-display"),h=document.getElementById("local-time"),E=document.getElementById("sync-status"),v=document.getElementById("remote-users-list"),I=document.getElementById("local-video"),b=document.getElementById("remote-video"),L=document.getElementById("copy-link-btn"),w=document.getElementById("copy-code-btn"),C=document.getElementById("save-username-btn"),T=document.getElementById("server-url"),x=document.getElementById("user-display"),P=document.getElementById("username-container"),R=document.getElementById("edit-username-btn"),S=document.getElementById("toggle-mic-btn"),$=document.getElementById("toggle-video-btn")}try{console.log("[Popup] Signaling server configured at:",e.WS.URL)}catch(e){console.warn("[Popup] Could not load config:",e)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{N(),q(),F(),U().then(()=>{V(),ee()})}):(N(),q(),F(),U().then(()=>{V(),ee()}));let O=null,j=null,D=null;function G(t){return new Promise(async n=>{try{const o=e.WS.URL.replace("wss://","https://").replace("/ws",""),s=await async function(t){try{const n=e.WS.URL.replace("wss://","https://").replace("/ws",""),o=await fetch(`${n}/api/short-id/${encodeURIComponent(t)}`);if(!o.ok)throw new Error(`Failed to get short ID: ${o.statusText}`);return(await o.json()).shortId}catch(e){return console.warn("[Popup] Could not get short ID from server, using fallback:",e),t.substring(0,8)}}(t);n(`${o}/room/${s}`)}catch(e){console.error("[Popup] Error building share link:",e),n("https://watch.toper.dev/room/unknown")}})}async function z(){const t=p.value.trim();if(!t)return void alert("Please enter a room code");const n=function(e){if(!e)return{type:"empty"};const t=e.trim(),n=t.match(/[?&]tandemRoom=([^&]+)/i);if(n)return{type:"roomId",roomId:decodeURIComponent(n[1])};const o=t.match(/\/room\/([a-z0-9]+)/i);if(o)return{type:"shortId",shortId:o[1]};if(t.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i))return{type:"roomId",roomId:t};const s=t.match(/^([a-z0-9]{3,})$/i);return s?{type:"shortId",shortId:s[1]}:{type:"invalid"}}(t);if("invalid"!==n.type&&"empty"!==n.type){f.disabled=!0;try{let t=null;if("roomId"===n.type)t=n.roomId;else{const o=e.WS.URL.replace(/^wss?:\/\//,"https://").replace(/\/ws$/,"");t=await async function(e,t){try{const n=await fetch(`${e}/api/room/${encodeURIComponent(t)}`);if(!n.ok)throw new Error("Room code not found");if((n.headers.get("content-type")||"").includes("application/json")){const e=await n.json();if(e&&e.roomId)return e.roomId}else{const e=await n.text();if(!e.includes("Signaling server running"))throw new Error(`Unexpected response from server: ${e.slice(0,160)}`)}}catch(e){if("Room code not found"===e?.message)throw e}const n=(await fetch(`${e}/room/${encodeURIComponent(t)}`,{redirect:"manual"})).headers.get("location");if(n){const e=n.match(/[?&]tandemRoom=([^&]+)/i);if(e)return decodeURIComponent(e[1])}throw new Error("Room codes are not supported on this server. Ask the host for a full Netflix link with ?tandemRoom=... or update the signaling server.")}(o,n.shortId)}chrome.runtime.sendMessage({type:"START_PARTY",roomId:t,username:k},e=>{f.disabled=!1,e&&e.success?(p.value="",setTimeout(V,500)):alert("Error: "+(e&&e.error?e.error:"Failed to join party"))})}catch(e){console.error("[Popup] Error joining room:",e),alert("Failed to join room: "+e.message),f.disabled=!1}}else alert("Please enter a valid room code or share link")}function F(){_||(_=!0,c&&c.addEventListener("click",K),l&&l.addEventListener("click",X),m&&m.addEventListener("click",J),L&&L.addEventListener("click",Q),w&&w.addEventListener("click",()=>{D&&(navigator.clipboard.writeText(D),w.textContent="‚úì",setTimeout(()=>{w.textContent="Copy"},1500))}),f&&f.addEventListener("click",z),p&&p.addEventListener("keypress",e=>{"Enter"===e.key&&z()}),C&&C.addEventListener("click",M),S&&S.addEventListener("click",()=>H("audio")),$&&$.addEventListener("click",()=>H("video")),R&&R.addEventListener("click",()=>{if(x){x.contentEditable="true",x.focus();const e=document.createRange();e.selectNodeContents(x);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}R&&R.classList.add("hidden"),C&&C.classList.remove("hidden")}),C&&C.addEventListener("click",M),x&&x.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),M()),"Escape"===e.key&&(x.contentEditable="false",x.textContent=k,C&&C.classList.add("hidden"),R&&R.classList.remove("hidden"))}))}function Y(e,t){chrome.tabs.query({url:"https://www.netflix.com/*"},n=>{n&&0!==n.length?chrome.tabs.sendMessage(n[0].id,e,e=>{chrome.runtime.lastError?t&&t({success:!1,error:chrome.runtime.lastError.message}):t&&t(e)}):t&&t({success:!1,error:"No Netflix tab found"})})}function W(e){if(e){if(S){const t=e.audioEnabled;S.textContent=t?"üé§":"üîá",S.setAttribute("aria-label",t?"Mute mic":"Unmute mic"),S.setAttribute("title",t?"Mute mic":"Unmute mic"),S.classList.toggle("active",!t)}if($){const t=e.videoEnabled;$.textContent=t?"üì∑":"üö´üì∑",$.setAttribute("aria-label",t?"Turn off camera":"Turn on camera"),$.setAttribute("title",t?"Turn off camera":"Turn on camera"),$.classList.toggle("active",!t)}}}function H(e){Y({type:"audio"===e?"TOGGLE_MIC":"TOGGLE_CAMERA"},e=>{e&&e.success?W(e.state):console.warn("[Popup] Media toggle failed:",e?.error)})}function V(){chrome.runtime.sendMessage({type:"GET_STATUS"},e=>{chrome.runtime.lastError||e&&(B=e,q())})}function q(){if(!(t&&n&&o&&r&&c&&l&&m&&i&&d&&a&&y))return void console.warn("[Popup] UI elements not ready, skipping update");const{isConnected:e,roomId:p,userId:f}=B;if(e){t&&(t.classList.remove("hidden"),t.className="status connected status-minimal"),n.textContent="üü¢ Connected",o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden"),r.classList.add("hidden"),c.classList.add("hidden"),l.classList.remove("hidden"),m.classList.remove("hidden"),i.classList.remove("hidden"),d.classList.remove("hidden");const e=k||f;y&&"true"!==y.contentEditable&&(y.textContent=e),u&&B.roomId&&(B.roomId===O&&j?(u.textContent=j,g&&D&&(g.textContent=D)):G(B.roomId).then(e=>{O=B.roomId,j=e,u.textContent=e;const t=e.match(/\/room\/([a-z0-9]+)$/i);t&&g&&(D=t[1],g.textContent=D)})),te(),Y({type:"GET_MEDIA_STATE"},e=>{e&&e.success&&W(e.state)})}else t&&(t.classList.add("hidden"),t.className="status disconnected status-minimal"),n.textContent="üî¥ Disconnected",o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden"),r.classList.remove("hidden"),c.classList.remove("hidden"),l.classList.add("hidden"),m.classList.add("hidden"),i.classList.add("hidden"),d.classList.add("hidden"),a.classList.add("hidden"),I.srcObject=null,b.srcObject=null}async function K(){c.disabled=!0,n.textContent="‚è≥ Connecting...",chrome.runtime.sendMessage({type:"START_PARTY",username:k},e=>{e.success?setTimeout(V,500):(alert("Error: "+e.error),n.textContent="üî¥ Disconnected",c.disabled=!1)})}function X(){chrome.runtime.sendMessage({type:"STOP_PARTY"},()=>{V()})}function J(){m.disabled=!0,n.textContent="‚ôªÔ∏è Resetting...",chrome.runtime.sendMessage({type:"STOP_PARTY"},()=>{chrome.runtime.sendMessage({type:"START_PARTY",username:k},e=>{m.disabled=!1,e&&e.success?setTimeout(V,500):(alert("Error resetting party: "+(e&&e.error?e.error:"Unknown error")),n.textContent="üî¥ Disconnected")})})}function Q(){B.roomId&&G(B.roomId).then(e=>{navigator.clipboard.writeText(e),L&&(L.textContent="‚úì",setTimeout(()=>{L.textContent="Copy"},2e3))})}const Z=e=>{if(null==e)return"--:--";const t=Math.floor(e);return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`};function ee(){V(),setInterval(V,2e3),setInterval(()=>{B.isConnected&&te()},1e3)}async function te(){if(B.isConnected&&B.roomId)try{const t=e.WS.URL.replace(/^wss?:\/\//,"http://").replace(/\/ws$/,"")+"/status";console.log("[Popup] Fetching stats from server:",t,"at",(new Date).toISOString());const n=await fetch(t);if(!n.ok)return void console.error("[Popup] Failed to fetch server status:",n.status,n.statusText);const o=await n.json();console.log("[Popup] Server status received at",(new Date).toISOString(),":",o),console.log("[Popup] Looking for room:",B.roomId);const s=o.rooms?.find(e=>e.roomId===B.roomId);if(!s)return console.log("[Popup] Room not found on server. Available rooms:",o.rooms?.map(e=>e.roomId)),void(E&&(E.textContent="Not Found",E.style.color="#ef4444"));if(console.log("[Popup] Room found:",s),console.log("[Popup] Room currentTime:",s.currentTime,"isPlaying:",s.isPlaying),console.log("[Popup] Room users:",s.users),h){const e=Z(s.currentTime);console.log("[Popup] Updating local time from",h.textContent,"to",e),h.textContent=e}else console.log("[Popup] localTimeEl not found!");if(E){const e=s.isPlaying?"Playing":"Paused";console.log("[Popup] Setting sync status to:",e),E.textContent=e,E.style.color=s.isPlaying?"#4ade80":"#fbbf24"}else console.log("[Popup] syncStatusEl not found!");if(v){const e=s.users||[];if(0===e.length)v.innerHTML='<div style="color: rgba(255,255,255,0.5); font-size: 12px; font-style: italic;">No users in party</div>';else{const t=e.map((e,t)=>{const n=Math.abs(e.currentTime-s.currentTime),o=n>2,r=e.isPlaying?"#4ade80":"#fbbf24",i=o?"#ef4444":"#4ade80",d=e.userId===B.userId;return`\n            <div style="padding: 8px; border-top: ${d?"1px solid rgba(167, 139, 250, 0.3)":"1px solid rgba(255,255,255,0.1)"}; background-color: ${d?"rgba(167, 139, 250, 0.1)":"transparent"}; ${0===t?"border-top: none;":""}">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <div style="font-weight: 600; font-size: 12px; color: rgba(82, 82, 82, 0.9);">\n                  ${d?k||e.username||"You":e.username||`${e.userId.substring(0,8)}...`}${d?" (You)":""}\n                </div>\n                <div style="font-size: 10px; color: ${r};">\n                  ${e.isPlaying?"‚ñ∂":"‚è∏"}\n                </div>\n              </div>\n              <div style="display: flex; justify-content: space-between; align-items: center;">\n                <div style="font-size: 13px; font-weight: 600; color: #a78bfa;">\n                  ${Z(e.currentTime)}\n                </div>\n                <div style="font-size: 10px; color: ${i}; font-weight: 600;">\n                  ${o?`¬±${n.toFixed(1)}s`:"‚úì synced"}\n                </div>\n              </div>\n            </div>\n          `}).join("");v.innerHTML=`\n          <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px; color: rgba(255,255,255,0.7);">\n            ${e.length} user${1===e.length?"":"s"} in party\n          </div>\n          ${t}\n        `}}}catch(e){console.error("[Popup] Error fetching stats:",e)}else console.log("[Popup] Not connected or no room ID",{isConnected:B.isConnected,roomId:B.roomId})}chrome.runtime.onMessage.addListener(e=>{"REMOTE_STREAM_RECEIVED"===e.type&&(b.srcObject=e.stream)})})();
//# sourceMappingURL=popup.js.map