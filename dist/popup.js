(()=>{"use strict";const e={WS:{URL:"wss://watch.toper.dev/ws",MAX_RECONNECT_ATTEMPTS:10,RECONNECT_DELAY_MS:3e3},FEATURES:{DEBUG_LOGGING:!0,AUTO_SYNC:!0,P2P_FALLBACK:!0},LOG_LEVEL:"info"};e.WS.URL;let t,n,o,s,r,i,a,d,c,l,m,u,p,g,f,y,h,E,v,I,b,L,w,C,x,T,P,R,S,$={isConnected:!1,roomId:null,userId:null,hasLocalStream:!1},B=null;async function U(){return new Promise(e=>{if(chrome?.storage?.local)return void chrome.storage.local.get(["tandemUsername"],t=>{B=t.tandemUsername||"",B||(B=k(),chrome.storage.local.set({tandemUsername:B},()=>{})),x&&"true"!==x.contentEditable&&(x.textContent=B),e(B)});const t=localStorage.getItem("tandemUsername")||"";B=t||k(),localStorage.setItem("tandemUsername",B),x&&"true"!==x.contentEditable&&(x.textContent=B),e(B)})}function k(){return`user-${Math.random().toString(36).slice(2,6)}`}async function A(){const e=(x?.textContent||"").trim()||k();return B=e,new Promise(t=>{const n=()=>{w&&w.classList.add("hidden"),P&&P.classList.remove("hidden"),x&&(x.contentEditable="false",x.textContent=e),chrome.runtime.sendMessage({type:"UPDATE_USERNAME",username:e},()=>{}),t(e)};chrome?.storage?.local?chrome.storage.local.set({tandemUsername:e},n):(localStorage.setItem("tandemUsername",e),n())})}let M=!1;function _(){t=document.getElementById("status"),n=document.getElementById("status-text"),o=document.getElementById("status-controls"),s=document.getElementById("controls-section"),r=document.getElementById("join-section"),i=document.getElementById("party-info"),a=document.getElementById("stats-section"),d=document.getElementById("video-section"),c=document.getElementById("start-btn"),l=document.getElementById("stop-btn"),m=document.getElementById("share-link"),u=document.getElementById("room-code-display"),p=document.getElementById("room-code-input"),g=document.getElementById("join-room-btn"),f=document.getElementById("user-display"),y=document.getElementById("local-time"),h=document.getElementById("sync-status"),E=document.getElementById("remote-users-list"),v=document.getElementById("local-video"),I=document.getElementById("remote-video"),b=document.getElementById("copy-link-btn"),L=document.getElementById("copy-code-btn"),w=document.getElementById("save-username-btn"),C=document.getElementById("server-url"),x=document.getElementById("user-display"),T=document.getElementById("username-container"),P=document.getElementById("edit-username-btn"),R=document.getElementById("toggle-mic-btn"),S=document.getElementById("toggle-video-btn")}try{console.log("[Popup] Signaling server configured at:",e.WS.URL)}catch(e){console.warn("[Popup] Could not load config:",e)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{_(),V(),z(),U().then(()=>{H(),Q()})}):(_(),V(),z(),U().then(()=>{H(),Q()}));let N=null,j=null,O=null;function D(t){return new Promise(async n=>{try{const o=e.WS.URL.replace("wss://","https://").replace("/ws",""),s=await async function(t){try{const n=e.WS.URL.replace("wss://","https://").replace("/ws",""),o=await fetch(`${n}/api/short-id/${encodeURIComponent(t)}`);if(!o.ok)throw new Error(`Failed to get short ID: ${o.statusText}`);return(await o.json()).shortId}catch(e){return console.warn("[Popup] Could not get short ID from server, using fallback:",e),t.substring(0,8)}}(t);n(`${o}/room/${s}`)}catch(e){console.error("[Popup] Error building share link:",e),n("https://watch.toper.dev/room/unknown")}})}async function G(){const t=p.value.trim();if(!t)return void alert("Please enter a room code");const n=function(e){if(!e)return{type:"empty"};const t=e.trim(),n=t.match(/[?&]tandemRoom=([^&]+)/i);if(n)return{type:"roomId",roomId:decodeURIComponent(n[1])};const o=t.match(/\/room\/([a-z0-9]+)/i);if(o)return{type:"shortId",shortId:o[1]};if(t.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i))return{type:"roomId",roomId:t};const s=t.match(/^([a-z0-9]{3,})$/i);return s?{type:"shortId",shortId:s[1]}:{type:"invalid"}}(t);if("invalid"!==n.type&&"empty"!==n.type){g.disabled=!0;try{let t=null;if("roomId"===n.type)t=n.roomId;else{const o=e.WS.URL.replace(/^wss?:\/\//,"https://").replace(/\/ws$/,"");t=await async function(e,t){try{const n=await fetch(`${e}/api/room/${encodeURIComponent(t)}`);if(!n.ok)throw new Error("Room code not found");if((n.headers.get("content-type")||"").includes("application/json")){const e=await n.json();if(e&&e.roomId)return e.roomId}else{const e=await n.text();if(!e.includes("Signaling server running"))throw new Error(`Unexpected response from server: ${e.slice(0,160)}`)}}catch(e){if("Room code not found"===e?.message)throw e}const n=(await fetch(`${e}/room/${encodeURIComponent(t)}`,{redirect:"manual"})).headers.get("location");if(n){const e=n.match(/[?&]tandemRoom=([^&]+)/i);if(e)return decodeURIComponent(e[1])}throw new Error("Room codes are not supported on this server. Ask the host for a full Netflix link with ?tandemRoom=... or update the signaling server.")}(o,n.shortId)}chrome.runtime.sendMessage({type:"START_PARTY",roomId:t,username:B},e=>{g.disabled=!1,e&&e.success?(p.value="",setTimeout(H,500)):alert("Error: "+(e&&e.error?e.error:"Failed to join party"))})}catch(e){console.error("[Popup] Error joining room:",e),alert("Failed to join room: "+e.message),g.disabled=!1}}else alert("Please enter a valid room code or share link")}function z(){M||(M=!0,c&&c.addEventListener("click",q),l&&l.addEventListener("click",K),b&&b.addEventListener("click",X),L&&L.addEventListener("click",()=>{O&&(navigator.clipboard.writeText(O),L.textContent="‚úì",setTimeout(()=>{L.textContent="Copy"},1500))}),g&&g.addEventListener("click",G),p&&p.addEventListener("keypress",e=>{"Enter"===e.key&&G()}),w&&w.addEventListener("click",A),R&&R.addEventListener("click",()=>Y("audio")),S&&S.addEventListener("click",()=>Y("video")),P&&P.addEventListener("click",()=>{if(x){x.contentEditable="true",x.focus();const e=document.createRange();e.selectNodeContents(x);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}P&&P.classList.add("hidden"),w&&w.classList.remove("hidden")}),w&&w.addEventListener("click",A),x&&x.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),A()),"Escape"===e.key&&(x.contentEditable="false",x.textContent=B,w&&w.classList.add("hidden"),P&&P.classList.remove("hidden"))}))}function F(e,t){chrome.tabs.query({url:"https://www.netflix.com/*"},n=>{n&&0!==n.length?chrome.tabs.sendMessage(n[0].id,e,e=>{chrome.runtime.lastError?t&&t({success:!1,error:chrome.runtime.lastError.message}):t&&t(e)}):t&&t({success:!1,error:"No Netflix tab found"})})}function W(e){if(e){if(R){const t=e.audioEnabled;R.textContent=t?"üé§":"üîá",R.setAttribute("aria-label",t?"Mute mic":"Unmute mic"),R.setAttribute("title",t?"Mute mic":"Unmute mic"),R.classList.toggle("active",!t)}if(S){const t=e.videoEnabled;S.textContent=t?"üì∑":"üö´üì∑",S.setAttribute("aria-label",t?"Turn off camera":"Turn on camera"),S.setAttribute("title",t?"Turn off camera":"Turn on camera"),S.classList.toggle("active",!t)}}}function Y(e){F({type:"audio"===e?"TOGGLE_MIC":"TOGGLE_CAMERA"},e=>{e&&e.success?W(e.state):console.warn("[Popup] Media toggle failed:",e?.error)})}function H(){chrome.runtime.sendMessage({type:"GET_STATUS"},e=>{chrome.runtime.lastError||e&&($=e,V())})}function V(){if(!(t&&n&&o&&r&&c&&l&&i&&a&&d&&f))return void console.warn("[Popup] UI elements not ready, skipping update");const{isConnected:e,roomId:p,userId:g}=$;if(e){t&&(t.classList.remove("hidden"),t.className="status connected status-minimal"),n.textContent="üü¢ Connected",o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden"),r.classList.add("hidden"),c.classList.add("hidden"),l.classList.remove("hidden"),i.classList.remove("hidden"),a.classList.remove("hidden");const e=B||g;f&&"true"!==f.contentEditable&&(f.textContent=e),m&&$.roomId&&($.roomId===N&&j?(m.textContent=j,u&&O&&(u.textContent=O)):D($.roomId).then(e=>{N=$.roomId,j=e,m.textContent=e;const t=e.match(/\/room\/([a-z0-9]+)$/i);t&&u&&(O=t[1],u.textContent=O)})),Z(),F({type:"GET_MEDIA_STATE"},e=>{e&&e.success&&W(e.state)})}else t&&(t.classList.add("hidden"),t.className="status disconnected status-minimal"),n.textContent="üî¥ Disconnected",o&&o.classList.remove("hidden"),s&&s.classList.remove("hidden"),r.classList.remove("hidden"),c.classList.remove("hidden"),l.classList.add("hidden"),i.classList.add("hidden"),a.classList.add("hidden"),d.classList.add("hidden"),v.srcObject=null,I.srcObject=null}async function q(){c.disabled=!0,n.textContent="‚è≥ Connecting...",chrome.runtime.sendMessage({type:"START_PARTY",username:B},e=>{e.success?setTimeout(H,500):(alert("Error: "+e.error),n.textContent="üî¥ Disconnected",c.disabled=!1)})}function K(){chrome.runtime.sendMessage({type:"STOP_PARTY"},()=>{H()})}function X(){$.roomId&&D($.roomId).then(e=>{navigator.clipboard.writeText(e),b&&(b.textContent="‚úì",setTimeout(()=>{b.textContent="Copy"},2e3))})}const J=e=>{if(null==e)return"--:--";const t=Math.floor(e);return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`};function Q(){H(),setInterval(H,2e3),setInterval(()=>{$.isConnected&&Z()},1e3)}async function Z(){if($.isConnected&&$.roomId)try{const t=e.WS.URL.replace(/^ws:\/\//,"http://").replace(/^wss:\/\//,"https://").replace(/\/ws$/,"")+"/status";console.log("[Popup] Fetching stats from server:",t,"at",(new Date).toISOString());const n=await fetch(t);if(!n.ok)return void console.error("[Popup] Failed to fetch server status:",n.status,n.statusText);const o=await n.json();console.log("[Popup] Server status received at",(new Date).toISOString(),":",o),console.log("[Popup] Looking for room:",$.roomId);const s=o.rooms?.find(e=>e.roomId===$.roomId);if(!s)return console.log("[Popup] Room not found on server. Available rooms:",o.rooms?.map(e=>e.roomId)),void(h&&(h.textContent="Not Found",h.style.color="#ef4444"));if(console.log("[Popup] Room found:",s),console.log("[Popup] Room currentTime:",s.currentTime,"isPlaying:",s.isPlaying),console.log("[Popup] Room users:",s.users),y){const e=J(s.currentTime);console.log("[Popup] Updating local time from",y.textContent,"to",e),y.textContent=e}else console.log("[Popup] localTimeEl not found!");if(h){const e=s.isPlaying?"Playing":"Paused";console.log("[Popup] Setting sync status to:",e),h.textContent=e,h.style.color=s.isPlaying?"#4ade80":"#fbbf24"}else console.log("[Popup] syncStatusEl not found!");if(E){const e=s.users||[];if(0===e.length)E.innerHTML='<div style="color: rgba(255,255,255,0.5); font-size: 12px; font-style: italic;">No users in party</div>';else{const t=e.map((e,t)=>{const n=Math.abs(e.currentTime-s.currentTime),o=n>2,r=e.isPlaying?"#4ade80":"#fbbf24",i=o?"#ef4444":"#4ade80",a=e.userId===$.userId;return`\n            <div style="padding: 8px; border-top: ${a?"1px solid rgba(167, 139, 250, 0.3)":"1px solid rgba(255,255,255,0.1)"}; background-color: ${a?"rgba(167, 139, 250, 0.1)":"transparent"}; ${0===t?"border-top: none;":""}">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <div style="font-weight: 600; font-size: 12px; color: rgba(82, 82, 82, 0.9);">\n                  ${a?B||e.username||"You":e.username||`${e.userId.substring(0,8)}...`}${a?" (You)":""}\n                </div>\n                <div style="font-size: 10px; color: ${r};">\n                  ${e.isPlaying?"‚ñ∂":"‚è∏"}\n                </div>\n              </div>\n              <div style="display: flex; justify-content: space-between; align-items: center;">\n                <div style="font-size: 13px; font-weight: 600; color: #a78bfa;">\n                  ${J(e.currentTime)}\n                </div>\n                <div style="font-size: 10px; color: ${i}; font-weight: 600;">\n                  ${o?`¬±${n.toFixed(1)}s`:"‚úì synced"}\n                </div>\n              </div>\n            </div>\n          `}).join("");E.innerHTML=`\n          <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px; color: rgba(255,255,255,0.7);">\n            ${e.length} user${1===e.length?"":"s"} in party\n          </div>\n          ${t}\n        `}}}catch(e){console.error("[Popup] Error fetching stats:",e)}else console.log("[Popup] Not connected or no room ID",{isConnected:$.isConnected,roomId:$.roomId})}chrome.runtime.onMessage.addListener(e=>{"REMOTE_STREAM_RECEIVED"===e.type&&(I.srcObject=e.stream)})})();
//# sourceMappingURL=popup.js.map