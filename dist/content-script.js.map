{"version":3,"file":"content-script.js","mappings":"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","sources":["webpack://toperparty/./chrome-extension/src/managers/sync/lock.js","webpack://toperparty/./chrome-extension/src/managers/sync/SyncManager.js","webpack://toperparty/./chrome-extension/src/services/webrtc/peerConnection.js","webpack://toperparty/./chrome-extension/src/content/main.js","webpack://toperparty/./chrome-extension/src/managers/state/StateManager.js","webpack://toperparty/./chrome-extension/src/ui/UIManager.js","webpack://toperparty/./chrome-extension/src/content/netflix/NetflixController.js","webpack://toperparty/./chrome-extension/src/managers/sync/remoteHandlers.js","webpack://toperparty/./chrome-extension/src/managers/sync/eventListeners.js","webpack://toperparty/./chrome-extension/src/services/webrtc/WebRTCManager.js","webpack://toperparty/./chrome-extension/src/services/webrtc/ui.js","webpack://toperparty/./chrome-extension/src/services/webrtc/reconnect.js","webpack://toperparty/./chrome-extension/src/services/webrtc/signaling.js","webpack://toperparty/./chrome-extension/src/managers/url/URLSync.js"],"sourcesContent":["export class SyncLock {\n  constructor() {\n    this.suppressLocalUntil = 0;\n  }\n  set(durationMs) {\n    this.suppressLocalUntil = Date.now() + durationMs;\n  }\n  isActive() {\n    return Date.now() < this.suppressLocalUntil;\n  }\n}\n","import { SyncLock } from './lock.js';\nimport { attachPlaybackListeners } from './eventListeners.js';\nimport { createRemoteHandlers } from './remoteHandlers.js';\n\nclass MutableRef {\n  constructor(value) { this.value = value; }\n  get() { return this.value; }\n  set(v) { this.value = v; }\n}\n\nexport class SyncManager {\n  constructor(stateManager, netflixController) {\n    this.state = stateManager;\n    this.netflix = netflixController;\n    this.lock = new SyncLock();\n    this.isInitializedRef = new MutableRef(false);\n    this.listeners = null;\n\n    this.remote = createRemoteHandlers({\n      state: this.state,\n      netflix: this.netflix,\n      lock: this.lock,\n      isInitializedRef: this.isInitializedRef,\n    });\n  }\n\n  async setup() {\n    try {\n      const video = await this.waitForVideo();\n      if (!video) { console.warn('[SyncManager] Netflix video element not found'); return; }\n      \n      console.log('[SyncManager] Setting up event listeners');\n      this.isInitializedRef.set(false);\n      \n      // Request initial sync from other clients\n      this.state.safeSendMessage({ type: 'REQUEST_SYNC' });\n      \n      // If no response after 2 seconds, consider ourselves initialized\n      setTimeout(() => {\n        if (!this.isInitializedRef.get()) {\n          console.log('[SyncManager] No sync response received, marking as initialized');\n          this.isInitializedRef.set(true);\n        }\n      }, 2000);\n      \n      const listeners = attachPlaybackListeners({\n        video,\n        state: this.state,\n        isInitializedRef: this.isInitializedRef,\n        lock: this.lock,\n        onPlay: (vid) => this.broadcastPlay(vid),\n        onPause: (vid) => this.broadcastPause(vid),\n        onSeek: (vid) => this.broadcastSeek(vid)\n      });\n      this.listeners = listeners;\n    } catch (err) { console.error('[SyncManager] Error setting up playback sync:', err); }\n  }\n\n  teardown() {\n    if (this.listeners && this.listeners.video) {\n      const { video, handlePlay, handlePause, handleSeeked } = this.listeners;\n      try {\n        video.removeEventListener('play', handlePlay);\n        video.removeEventListener('pause', handlePause);\n        video.removeEventListener('seeked', handleSeeked);\n      } catch (e) { console.warn('[SyncManager] Error removing listeners:', e); }\n      this.listeners = null;\n    }\n  }\n\n  waitForVideo() {\n    return new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => reject(new Error('Video element timeout')), 10000);\n      const check = () => {\n        const video = this.netflix.getVideoElement();\n        if (video) { clearTimeout(timeout); resolve(video); }\n        else { setTimeout(check, 100); }\n      };\n      check();\n    });\n  }\n\n  broadcastPlay(video) {\n    console.log('[SyncManager] Broadcasting PLAY event');\n    this.state.safeSendMessage({ \n      type: 'PLAY_PAUSE', \n      control: 'play', \n      currentTime: video.currentTime \n    });\n  }\n\n  broadcastPause(video) {\n    console.log('[SyncManager] Broadcasting PAUSE event');\n    this.state.safeSendMessage({ \n      type: 'PLAY_PAUSE', \n      control: 'pause', \n      currentTime: video.currentTime \n    });\n  }\n\n  broadcastSeek(video) {\n    console.log('[SyncManager] Broadcasting SEEK event at', video.currentTime);\n    this.state.safeSendMessage({ \n      type: 'SEEK', \n      currentTime: video.currentTime, \n      isPlaying: !video.paused \n    });\n  }\n\n  // Remote event handlers\n  handleRequestSync(fromUserId) { return this.remote.handleRequestSync(fromUserId); }\n  handleSyncResponse(currentTime, isPlaying, fromUserId) { return this.remote.handleSyncResponse(currentTime, isPlaying, fromUserId); }\n  handlePlaybackControl(control, fromUserId) { return this.remote.handlePlaybackControl(control, fromUserId); }\n  handleSeek(currentTime, isPlaying, fromUserId) { return this.remote.handleSeek(currentTime, isPlaying, fromUserId); }\n}\n","export function createPeerConnectionFactory({ stateManager, sendSignal, remoteStreams, remoteVideos, addRemoteVideo, attemptReconnection, clearReconnection, removeRemoteVideo, peersThatLeft }) {\n  return function createPeerConnection(peerId) {\n    const state = stateManager.getState();\n    const pc = new RTCPeerConnection({\n      iceServers: [\n        { urls: ['stun:stun.l.google.com:19302'] },\n        { urls: ['stun:stun1.l.google.com:19302'] }\n      ]\n    });\n    pc.onicecandidate = (event) => {\n      if (event.candidate) {\n        console.log('[PeerConnection] ICE candidate for peer:', peerId, event.candidate);\n        sendSignal({ type: 'ICE_CANDIDATE', from: state.userId, to: peerId, candidate: event.candidate });\n      }\n    };\n    pc.ontrack = (event) => {\n      console.log('[PeerConnection] ontrack fired for peer:', peerId, 'track:', event.track, 'streams:', event.streams);\n      let stream = (event.streams && event.streams[0]) || remoteStreams.get(peerId);\n      if (!stream) {\n        console.log('[PeerConnection] Creating new MediaStream for peer:', peerId);\n        stream = new MediaStream();\n        remoteStreams.set(peerId, stream);\n      }\n      if (event.track) {\n        console.log('[PeerConnection] Adding track to stream:', event.track.kind, event.track.id);\n        try { stream.addTrack(event.track); } catch (e) {\n          console.warn('[PeerConnection] Error adding track:', e);\n        }\n      }\n      if (!remoteVideos.has(peerId)) {\n        console.log('[PeerConnection] Adding remote video for peer:', peerId, 'stream tracks:', stream.getTracks().length);\n        addRemoteVideo(peerId, stream);\n      }\n    };\n    pc.onconnectionstatechange = () => {\n      console.log('[PeerConnection] Connection state changed for peer:', peerId, 'â†’', pc.connectionState);\n      if (pc.connectionState === 'connected') {\n        clearReconnection(peerId);\n      } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {\n        if (peersThatLeft.has(peerId)) {\n          removeRemoteVideo(peerId);\n          clearReconnection(peerId);\n        } else {\n          removeRemoteVideo(peerId);\n          attemptReconnection(peerId);\n        }\n      } else if (pc.connectionState === 'closed') {\n        removeRemoteVideo(peerId);\n        clearReconnection(peerId);\n      }\n    };\n    return pc;\n  };\n}\n\nexport function addOrReplaceTrack(pc, track, stream) {\n  const senders = pc.getSenders();\n  const existingSender = senders.find(s => s.track && s.track.kind === track.kind);\n  if (existingSender) {\n    existingSender.replaceTrack(track).catch(e => console.warn('[WebRTCManager] Error replacing track', e));\n  } else {\n    try { pc.addTrack(track, stream); } catch (e) {}\n  }\n}\n","import { StateManager } from '../managers/state/StateManager.js';\nimport { NetflixController } from './netflix/NetflixController.js';\nimport { SyncManager } from '../managers/sync/SyncManager.js';\nimport { WebRTCManager } from '../services/webrtc/WebRTCManager.js';\nimport { UIManager } from '../ui/UIManager.js';\nimport { URLSync } from '../managers/url/URLSync.js';\n\nconsole.log('[Content Script] Initializing managers...');\nconst stateManager = new StateManager();\nconst uiManager = new UIManager();\nconst netflixController = new NetflixController();\nconst syncManager = new SyncManager(stateManager, netflixController);\nconst webrtcManager = new WebRTCManager(stateManager, uiManager);\nconst urlSync = new URLSync(stateManager);\nconsole.log('[Content Script] Managers initialized');\n\nlet localStream = null;\nlet videoElementMonitor = null;\n\n// Monitor and restore video elements if they get removed during navigation\nfunction startVideoElementMonitoring() {\n  if (videoElementMonitor) return;\n  \n  videoElementMonitor = setInterval(() => {\n    const state = stateManager.getState();\n    if (!state.partyActive) return;\n    \n    // Check if local preview exists\n    if (localStream && !document.getElementById('toperparty-local-preview')) {\n      console.log('[Content Script] Local preview missing, re-attaching');\n      uiManager.attachLocalPreview(localStream);\n    }\n    \n    // Check if remote videos exist\n    const remoteVideos = uiManager.getRemoteVideos();\n    const remoteStreams = uiManager.getRemoteStreams();\n    remoteStreams.forEach((stream, peerId) => {\n      const videoId = 'toperparty-remote-' + peerId;\n      if (!document.getElementById(videoId)) {\n        console.log('[Content Script] Remote video missing for peer:', peerId, 're-adding');\n        const videoManager = webrtcManager.videoManager;\n        if (videoManager && videoManager.add) {\n          videoManager.add(peerId, stream);\n        }\n      }\n    });\n  }, 1000); // Check every second\n  \n  console.log('[Content Script] Started video element monitoring');\n}\n\nfunction stopVideoElementMonitoring() {\n  if (videoElementMonitor) {\n    clearInterval(videoElementMonitor);\n    videoElementMonitor = null;\n    console.log('[Content Script] Stopped video element monitoring');\n  }\n}\n\n(function checkRestorePartyState() {\n  const restorationState = urlSync.getRestorationState();\n  if (restorationState) {\n    urlSync.clearState();\n    stateManager.setRestoringFlag(true);\n    setTimeout(function() {\n      chrome.runtime.sendMessage({ type: 'RESTORE_PARTY', roomId: restorationState.roomId });\n      setTimeout(function() {\n        stateManager.setRestoringFlag(false);\n      }, 2000);\n    }, 1000);\n  }\n})();\n\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n  console.log('[Content Script] Received message:', request.type);\n  if (request.type === 'REQUEST_MEDIA_STREAM') {\n    console.log('[Content Script] Processing REQUEST_MEDIA_STREAM');\n    navigator.mediaDevices.getUserMedia({ video: true, audio: true })\n      .then(stream => {\n        console.log('[Content Script] Media stream obtained, tracks:', stream.getTracks().length);\n        localStream = stream;\n        console.log('[Content Script] Setting local stream on WebRTC manager');\n        webrtcManager.setLocalStream(stream);\n        webrtcManager.onLocalStreamAvailable(stream);\n        console.log('[Content Script] Attaching local preview to UI');\n        uiManager.attachLocalPreview(stream);\n        console.log('[Content Script] Local preview attached, sending success response');\n        sendResponse({ success: true });\n      })\n      .catch(err => {\n        console.error('[Content Script] Failed to get media stream:', err);\n        sendResponse({ success: false, error: err.message });\n      });\n    return true;\n  }\n\n  if (request.type === 'PARTY_STARTED') {\n    console.log('[Content Script] Party started:', request.userId, request.roomId);\n    stateManager.startParty(request.userId, request.roomId);\n    syncManager.setup();\n    urlSync.start();\n    startVideoElementMonitoring();\n    sendResponse({ success: true });\n  }\n\n  if (request.type === 'PARTY_STOPPED') {\n    console.log('[Content Script] Stopping party');\n    stopVideoElementMonitoring();\n    stateManager.stopParty();\n    syncManager.teardown();\n    urlSync.stop();\n    urlSync.clearState();\n    webrtcManager.clearAll();\n    uiManager.removeLocalPreview();\n    if (localStream) {\n      localStream.getTracks().forEach(t => t.stop());\n      localStream = null;\n    }\n    sendResponse({ success: true });\n  }\n\n  if (request.type === 'SIGNAL') {\n    console.log('[Content Script] Handling SIGNAL:', request.message?.type);\n    webrtcManager.handleSignal(request.message);\n  }\n\n  if (request.type === 'APPLY_PLAYBACK_CONTROL') {\n    syncManager.handlePlaybackControl(request.control, request.fromUserId);\n  }\n\n  // Passive sync removed - using event-based sync only\n\n  if (request.type === 'APPLY_SEEK') {\n    syncManager.handleSeek(request.currentTime, request.isPlaying, request.fromUserId);\n  }\n\n  if (request.type === 'APPLY_URL_CHANGE') {\n    if (!stateManager.restoringPartyState) {\n      window.location.href = request.url;\n    }\n  }\n\n  if (request.type === 'HANDLE_REQUEST_SYNC') {\n    syncManager.handleRequestSync(request.fromUserId);\n  }\n\n  if (request.type === 'APPLY_SYNC_RESPONSE') {\n    syncManager.handleSyncResponse(request.currentTime, request.isPlaying, request.fromUserId);\n  }\n});\n\nwindow.addEventListener('beforeunload', () => {\n  if (stateManager.isActive()) {\n    urlSync.saveState();\n  }\n});\n","export class StateManager {\n  constructor() {\n    this.partyActive = false;\n    this.userId = null;\n    this.roomId = null;\n    this.restoringPartyState = false;\n  }\n  startParty(userId, roomId) {\n    this.partyActive = true;\n    this.userId = userId;\n    this.roomId = roomId;\n  }\n  stopParty() {\n    this.partyActive = false;\n    this.userId = null;\n    this.roomId = null;\n  }\n  isActive() { return this.partyActive; }\n  getUserId() { return this.userId; }\n  getRoomId() { return this.roomId; }\n  getState() {\n    return { partyActive: this.partyActive, userId: this.userId, roomId: this.roomId, restoringPartyState: this.restoringPartyState };\n  }\n  isInParty() { return !!(this.partyActive && this.userId && this.roomId); }\n  setRestoringFlag(value) { this.restoringPartyState = value; }\n  isExtensionContextValid() {\n    try { return chrome.runtime && chrome.runtime.id; } catch { return false; }\n  }\n  safeSendMessage(message, callback) {\n    if (!this.isExtensionContextValid()) return;\n    try { chrome.runtime.sendMessage(message, callback); } catch (e) { console.warn('Failed to send message:', e.message); }\n  }\n}\n","export class UIManager {\n  constructor() {\n    this.localPreviewVideo = null;\n    this.remoteVideos = new Map();\n    this.remoteStreams = new Map();\n    this.streamMonitorInterval = null;\n  }\n  getRemoteVideos() { return this.remoteVideos; }\n  getRemoteStreams() { return this.remoteStreams; }\n  setLocalPreviewVideo(video) { this.localPreviewVideo = video; }\n  getLocalPreviewVideo() { return this.localPreviewVideo; }\n  setStreamMonitorInterval(interval) { this.streamMonitorInterval = interval; }\n  getStreamMonitorInterval() { return this.streamMonitorInterval; }\n  clearStreamMonitorInterval() {\n    if (this.streamMonitorInterval) {\n      clearInterval(this.streamMonitorInterval);\n      this.streamMonitorInterval = null;\n    }\n  }\n\n  attachLocalPreview(stream) {\n    console.log('[UIManager] Attaching local preview with stream:', stream);\n    this.removeLocalPreview();\n    \n    const v = document.createElement('video');\n    v.id = 'toperparty-local-preview';\n    v.autoplay = true;\n    v.muted = true; // Always mute local preview to avoid feedback\n    v.playsInline = true;\n    v.style.position = 'fixed';\n    v.style.bottom = '20px';\n    v.style.left = '20px';\n    v.style.width = '240px';\n    v.style.height = '160px';\n    v.style.zIndex = '10001';\n    v.style.border = '2px solid #e50914';\n    v.style.borderRadius = '4px';\n    v.style.transform = 'scaleX(-1)'; // Mirror for natural preview\n\n    try {\n      v.srcObject = stream;\n      console.log('[UIManager] Set srcObject on local preview');\n    } catch (e) {\n      console.warn('[UIManager] srcObject failed, trying createObjectURL:', e);\n      v.src = URL.createObjectURL(stream);\n    }\n\n    document.body.appendChild(v);\n    this.localPreviewVideo = v;\n    console.log('[UIManager] Local preview video appended to body');\n\n    v.play().catch(err => {\n      console.warn('[UIManager] Local preview play() failed:', err);\n    });\n  }\n\n  removeLocalPreview() {\n    if (this.localPreviewVideo) {\n      console.log('[UIManager] Removing local preview video');\n      try {\n        if (this.localPreviewVideo.srcObject) {\n          this.localPreviewVideo.srcObject = null;\n        }\n      } catch (e) {\n        console.warn('[UIManager] Error clearing srcObject:', e);\n      }\n      this.localPreviewVideo.remove();\n      this.localPreviewVideo = null;\n    }\n  }\n\n  clearAll() {\n    this.removeLocalPreview();\n    this.remoteVideos.clear();\n    this.remoteStreams.clear();\n    this.clearStreamMonitorInterval();\n  }\n}\n","export class NetflixController {\n  constructor() { this.injectAPIBridge(); }\n  injectAPIBridge() {\n    const script = document.createElement('script');\n    script.src = chrome.runtime.getURL('netflix-api-bridge.js');\n    (document.head || document.documentElement).appendChild(script);\n    script.onload = function() { script.remove(); };\n  }\n  _sendCommand(command, args = []) {\n    return new Promise(function(resolve) {\n      const handler = function(e) {\n        if (e.detail.command === command) {\n          document.removeEventListener('__toperparty_response', handler);\n          resolve(e.detail.result);\n        }\n      };\n      document.addEventListener('__toperparty_response', handler);\n      setTimeout(function() { resolve(null); }, 1000);\n      document.dispatchEvent(new CustomEvent('__toperparty_command', { detail: { command, args } }));\n    });\n  }\n  play() { return this._sendCommand('play'); }\n  pause() { return this._sendCommand('pause'); }\n  seek(timeMs) { return this._sendCommand('seek', [timeMs]); }\n  getCurrentTime() { return this._sendCommand('getCurrentTime'); }\n  isPaused() { return this._sendCommand('isPaused'); }\n  getVideoElement() { return document.querySelector('video'); }\n}\n","export function createRemoteHandlers({ state, netflix, lock, isInitializedRef }) {\n  async function applyRemote(actionName, durationMs, actionFn) {\n    lock.set(durationMs);\n    try { await actionFn(); } catch (err) {\n      console.error(`[SyncManager] Error applying remote ${actionName}:`, err);\n    }\n  }\n\n  return {\n    async handleRequestSync(fromUserId) {\n      if (!isInitializedRef.get()) {\n        console.log('[SyncManager] Not yet initialized, ignoring sync request');\n        return;\n      }\n      \n      try {\n        const currentTime = await netflix.getCurrentTime();\n        const isPaused = await netflix.isPaused();\n        \n        if (currentTime == null) {\n          console.log('[SyncManager] Invalid playback state, ignoring sync request');\n          return;\n        }\n        \n        const currentTimeSeconds = currentTime / 1000;\n        console.log('[SyncManager] Sending SYNC_RESPONSE to', fromUserId, 'at', currentTimeSeconds.toFixed(2) + 's', isPaused ? 'paused' : 'playing');\n        \n        state.safeSendMessage({\n          type: 'SYNC_RESPONSE',\n          targetUserId: fromUserId,\n          currentTime: currentTimeSeconds,\n          isPlaying: !isPaused\n        });\n      } catch (e) { console.error('[SyncManager] Error handling sync request:', e); }\n    },\n    async handleSyncResponse(currentTime, isPlaying, fromUserId) {\n      if (isInitializedRef.get()) {\n        console.log('[SyncManager] Already initialized, ignoring late SYNC_RESPONSE');\n        return;\n      }\n      \n      if (currentTime == null || typeof currentTime !== 'number' || currentTime < 0) {\n        console.warn('[SyncManager] Invalid SYNC_RESPONSE - bad currentTime:', currentTime);\n        return;\n      }\n      \n      console.log('[SyncManager] Initial sync from', fromUserId, 'seeking to', currentTime.toFixed(2) + 's', isPlaying ? 'playing' : 'paused');\n      isInitializedRef.set(true);\n      \n      await applyRemote('initial-sync', 1500, async () => {\n        await netflix.seek(currentTime * 1000);\n        const localPaused = await netflix.isPaused();\n        if (isPlaying && localPaused) {\n          await netflix.play();\n        } else if (!isPlaying && !localPaused) {\n          await netflix.pause();\n        }\n      });\n    },\n    async handlePlaybackControl(control, fromUserId) {\n      console.log('[SyncManager] Remote', control.toUpperCase(), 'from', fromUserId);\n      \n      await applyRemote(control, 800, async () => {\n        if (control === 'play') {\n          await netflix.play();\n        } else {\n          await netflix.pause();\n        }\n      });\n    },\n    async handleSeek(currentTime, isPlaying, fromUserId) {\n      console.log('[SyncManager] Remote SEEK to', currentTime.toFixed(2) + 's', isPlaying ? 'playing' : 'paused', 'from', fromUserId);\n      \n      await applyRemote('seek', 1200, async () => {\n        await netflix.seek(currentTime * 1000);\n        const isPaused = await netflix.isPaused();\n        \n        if (isPlaying && isPaused) {\n          await netflix.play();\n        } else if (!isPlaying && !isPaused) {\n          await netflix.pause();\n        }\n      });\n    }\n  };\n}\n","export function attachPlaybackListeners({ video, state, isInitializedRef, lock, onPlay, onPause, onSeek }) {\n  const handlePlay = () => {\n    if (!state.isActive()) return;\n    if (!isInitializedRef.get()) return;\n    if (lock.isActive()) return;\n    console.log('[EventListeners] Play event detected');\n    onPlay(video);\n  };\n\n  const handlePause = () => {\n    if (!state.isActive()) return;\n    if (!isInitializedRef.get()) return;\n    if (lock.isActive()) return;\n    console.log('[EventListeners] Pause event detected');\n    onPause(video);\n  };\n\n  const handleSeeked = () => {\n    if (!state.isActive()) return;\n    if (!isInitializedRef.get()) return;\n    if (lock.isActive()) return;\n    console.log('[EventListeners] Seek event detected');\n    onSeek(video);\n  };\n\n  video.addEventListener('play', handlePlay);\n  video.addEventListener('pause', handlePause);\n  video.addEventListener('seeked', handleSeeked);\n\n  return { video, handlePlay, handlePause, handleSeeked };\n}\n","import { createSignalingHandlers } from './signaling.js';\nimport { createPeerConnectionFactory, addOrReplaceTrack } from './peerConnection.js';\nimport { createReconnectionManager } from './reconnect.js';\nimport { createRemoteVideoManager } from './ui.js';\n\nexport class WebRTCManager {\n  constructor(stateManager, uiManager) {\n    this.stateManager = stateManager;\n    this.uiManager = uiManager;\n    this.peerConnections = new Map();\n    this.remoteStreams = this.uiManager.getRemoteStreams();\n    this.remoteVideos = this.uiManager.getRemoteVideos();\n    this.peersThatLeft = new Set();\n    this.localStream = null;\n\n    const videoManager = createRemoteVideoManager(this.remoteVideos);\n    \n    // Create a placeholder object for circular dependency resolution\n    const reconnectionManager = {};\n    \n    const createPeer = createPeerConnectionFactory({\n      stateManager: this.stateManager,\n      sendSignal: (msg) => this._sendSignal(msg),\n      remoteStreams: this.remoteStreams,\n      remoteVideos: this.remoteVideos,\n      addRemoteVideo: videoManager.add,\n      attemptReconnection: (peerId) => reconnectionManager.attempt(peerId),\n      clearReconnection: (peerId) => reconnectionManager.clear(peerId),\n      removeRemoteVideo: (peerId) => {\n        videoManager.remove(peerId);\n        this.remoteStreams.delete(peerId);\n      },\n      peersThatLeft: this.peersThatLeft\n    });\n\n    // Now create the actual reconnection manager with createPeer available\n    Object.assign(reconnectionManager, createReconnectionManager({\n      stateManager: this.stateManager,\n      peerConnections: this.peerConnections,\n      peersThatLeft: this.peersThatLeft,\n      localStream: () => this.localStream,\n      createPeer: createPeer,\n      sendSignal: (msg) => this._sendSignal(msg),\n      addOrReplaceTrack\n    }));\n\n    this.reconnectionManager = reconnectionManager;\n    this.createPeer = createPeer;\n    this.videoManager = videoManager;\n\n    this.signalingHandlers = createSignalingHandlers({\n      getState: () => this.stateManager.getState(),\n      peerConnections: this.peerConnections,\n      peersThatLeft: this.peersThatLeft,\n      getLocalStream: () => this.localStream,\n      createPeer,\n      sendSignal: (msg) => this._sendSignal(msg),\n      addOrReplaceTrack,\n      clearReconnection: reconnectionManager.clear,\n      removeRemoteVideo: (peerId) => {\n        videoManager.remove(peerId);\n        this.remoteStreams.delete(peerId);\n      }\n    });\n  }\n\n  setLocalStream(stream) { this.localStream = stream; }\n  getLocalStream() { return this.localStream; }\n  \n  onLocalStreamAvailable(stream) {\n    this.localStream = stream;\n    this.peerConnections.forEach((pc) => {\n      try {\n        stream.getTracks().forEach(t => addOrReplaceTrack(pc, t, stream));\n      } catch (e) {}\n    });\n  }\n\n  async handleSignal(message) {\n    console.log('[WebRTCManager] handleSignal called with:', message);\n    if (!message || !message.type) {\n      console.warn('[WebRTCManager] Invalid message:', message);\n      return;\n    }\n    const type = message.type;\n    const from = message.userId || message.from;\n    const to = message.to;\n    const state = this.stateManager.getState();\n    console.log('[WebRTCManager] Processing signal type:', type, 'from:', from, 'to:', to, 'myId:', state.userId);\n    \n    if (to && to !== state.userId) {\n      console.log('[WebRTCManager] Ignoring message not meant for me');\n      return;\n    }\n\n    if (type === 'JOIN' && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleJoin');\n      await this.signalingHandlers.handleJoin(from);\n    } else if (type === 'OFFER' && message.offer && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleOffer');\n      await this.signalingHandlers.handleOffer(from, message.offer);\n    } else if (type === 'ANSWER' && message.answer && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleAnswer');\n      await this.signalingHandlers.handleAnswer(from, message.answer);\n    } else if (type === 'ICE_CANDIDATE' && message.candidate && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleIceCandidate');\n      await this.signalingHandlers.handleIceCandidate(from, message.candidate);\n    } else if (type === 'LEAVE' && from) {\n      console.log('[WebRTCManager] Dispatching to handleLeave');\n      this.signalingHandlers.handleLeave(from);\n    } else {\n      console.log('[WebRTCManager] Signal not handled - type:', type, 'from:', from, 'conditions not met');\n    }\n  }\n\n  attemptReconnection(peerId) {\n    return this.reconnectionManager.attempt(peerId);\n  }\n\n  _sendSignal(message) {\n    this.stateManager.safeSendMessage({ type: 'SIGNAL_SEND', message }, function() {});\n  }\n\n  clearAll() {\n    this.peerConnections.forEach((pc) => {\n      try { pc.close(); } catch (e) {}\n    });\n    this.peerConnections.clear();\n    this.peersThatLeft.clear();\n    this.remoteVideos.forEach((v) => {\n      try { if (v.srcObject) v.srcObject = null; } catch (e) {}\n      v.remove();\n    });\n    this.remoteVideos.clear();\n    this.remoteStreams.clear();\n    if (this.localStream) {\n      this.localStream.getTracks().forEach(track => track.stop());\n      this.localStream = null;\n    }\n  }\n}\n","export function createRemoteVideoManager(remoteVideos) {\n  function add(peerId, stream) {\n    console.log('[RemoteVideoManager] Adding remote video for peer:', peerId, 'stream:', stream, 'tracks:', stream.getTracks());\n    remove(peerId);\n    const v = document.createElement('video');\n    v.id = 'toperparty-remote-' + peerId;\n    v.autoplay = true;\n    v.playsInline = true;\n    v.muted = true;\n    v.style.position = 'fixed';\n    v.style.bottom = '20px';\n    v.style.right = (20 + (remoteVideos.size * 180)) + 'px';\n    v.style.width = '240px';\n    v.style.height = '160px';\n    v.style.zIndex = 10001;\n    v.style.border = '2px solid #00aaff';\n    v.style.borderRadius = '4px';\n    console.log('[RemoteVideoManager] Created video element:', v.id, 'at position:', v.style.right);\n    try { \n      v.srcObject = stream;\n      console.log('[RemoteVideoManager] Set srcObject successfully');\n    } catch (e) { \n      console.warn('[RemoteVideoManager] srcObject failed, trying createObjectURL:', e);\n      v.src = URL.createObjectURL(stream); \n    }\n    document.body.appendChild(v);\n    console.log('[RemoteVideoManager] Appended video to body');\n    remoteVideos.set(peerId, v);\n    try {\n      v.play().then(() => {\n        console.log('[RemoteVideoManager] Video playing, unmuting');\n        v.muted = false;\n        v.volume = 1.0;\n      }).catch((e) => { \n        console.warn('[RemoteVideoManager] Play failed:', e);\n        v.muted = false; \n      });\n    } catch (e) {\n      console.warn('[RemoteVideoManager] Error calling play:', e);\n    }\n  }\n  \n  function remove(peerId) {\n    console.log('[RemoteVideoManager] Removing remote video for peer:', peerId);\n    const v = remoteVideos.get(peerId);\n    if (v) {\n      try { if (v.srcObject) v.srcObject = null; } catch (e) {}\n      v.remove();\n      remoteVideos.delete(peerId);\n    }\n  }\n  \n  return { add, remove };\n}\n","export function createReconnectionManager({ stateManager, peerConnections, peersThatLeft, localStream, createPeer, sendSignal, addOrReplaceTrack }) {\n  const attempts = new Map();\n  const timeouts = new Map();\n  \n  function clear(peerId) {\n    attempts.delete(peerId);\n    const handle = timeouts.get(peerId);\n    if (handle) {\n      clearTimeout(handle);\n      timeouts.delete(peerId);\n    }\n  }\n  \n  async function attempt(peerId) {\n    if (!stateManager.isInParty()) return;\n    if (peersThatLeft.has(peerId)) {\n      clear(peerId);\n      return;\n    }\n    const count = attempts.get(peerId) || 0;\n    const maxAttempts = 5;\n    const backoffDelay = Math.min(1000 * Math.pow(2, count), 30000);\n    if (count >= maxAttempts) {\n      clear(peerId);\n      return;\n    }\n    attempts.set(peerId, count + 1);\n    const existing = timeouts.get(peerId);\n    if (existing) clearTimeout(existing);\n    const handle = setTimeout(async () => {\n      const oldPc = peerConnections.get(peerId);\n      if (oldPc) {\n        try { oldPc.close(); } catch (e) {}\n        peerConnections.delete(peerId);\n      }\n      try {\n        const pc = createPeer(peerId);\n        peerConnections.set(peerId, pc);\n        const stream = typeof localStream === 'function' ? localStream() : localStream;\n        if (stream) {\n          stream.getTracks().forEach(t => addOrReplaceTrack(pc, t, stream));\n        }\n        const offer = await pc.createOffer();\n        await pc.setLocalDescription(offer);\n        const state = stateManager.getState();\n        sendSignal({ type: 'OFFER', from: state.userId, to: peerId, offer: pc.localDescription });\n      } catch (err) {\n        console.error('[WebRTCManager] Reconnection failed:', err);\n        attempt(peerId);\n      }\n    }, backoffDelay);\n    timeouts.set(peerId, handle);\n  }\n  \n  return { attempt, clear };\n}\n","export function createSignalingHandlers({ getState, peerConnections, peersThatLeft, getLocalStream, createPeer, sendSignal, addOrReplaceTrack, clearReconnection, removeRemoteVideo }) {\n  return {\n    async handleJoin(from) {\n      console.log('[Signaling] Handling JOIN from', from);\n      const state = getState();\n      if (from === state.userId) {\n        console.log('[Signaling] Ignoring JOIN from self');\n        return;\n      }\n      peersThatLeft.delete(from);\n      if (peerConnections.has(from)) {\n        console.log('[Signaling] Already have peer connection for', from);\n        return;\n      }\n      try {\n        console.log('[Signaling] Creating peer connection for', from);\n        const pc = createPeer(from);\n        peerConnections.set(from, pc);\n        const stream = getLocalStream();\n        console.log('[Signaling] Local stream:', stream, 'tracks:', stream ? stream.getTracks().length : 0);\n        if (stream) {\n          stream.getTracks().forEach(t => {\n            console.log('[Signaling] Adding local track to peer:', t.kind, t.id);\n            addOrReplaceTrack(pc, t, stream);\n          });\n        } else {\n          console.warn('[Signaling] No local stream available when handling JOIN');\n        }\n        console.log('[Signaling] Creating and sending OFFER to', from);\n        const offer = await pc.createOffer();\n        await pc.setLocalDescription(offer);\n        sendSignal({ type: 'OFFER', from: state.userId, to: from, offer: pc.localDescription });\n      } catch (err) {\n        console.error('[Signaling] Error handling JOIN:', err);\n        peerConnections.delete(from);\n      }\n    },\n    async handleOffer(from, offer) {\n      console.log('[Signaling] Handling OFFER from', from);\n      const state = getState();\n      if (from === state.userId) {\n        console.log('[Signaling] Ignoring OFFER from self');\n        return;\n      }\n      let pc = peerConnections.get(from);\n      if (pc && pc.signalingState !== 'closed') {\n        console.log('[Signaling] Closing existing peer connection');\n        try { pc.close(); } catch (e) {}\n        peerConnections.delete(from);\n        pc = null;\n      }\n      if (!pc) {\n        console.log('[Signaling] Creating new peer connection for', from);\n        pc = createPeer(from);\n        peerConnections.set(from, pc);\n      }\n      try {\n        console.log('[Signaling] Setting remote description');\n        await pc.setRemoteDescription(new RTCSessionDescription(offer));\n        const stream = getLocalStream();\n        console.log('[Signaling] Local stream:', stream, 'tracks:', stream ? stream.getTracks().length : 0);\n        if (stream) {\n          stream.getTracks().forEach(t => {\n            console.log('[Signaling] Adding local track to peer:', t.kind, t.id);\n            addOrReplaceTrack(pc, t, stream);\n          });\n        } else {\n          console.warn('[Signaling] No local stream available when handling OFFER');\n        }\n        console.log('[Signaling] Creating and sending ANSWER to', from);\n        const answer = await pc.createAnswer();\n        await pc.setLocalDescription(answer);\n        sendSignal({ type: 'ANSWER', from: state.userId, to: from, answer: pc.localDescription });\n      } catch (err) {\n        console.error('[Signaling] Error handling offer:', err);\n        peerConnections.delete(from);\n        try { pc.close(); } catch (e) {}\n      }\n    },\n    async handleAnswer(from, answer) {\n      console.log('[Signaling] Handling ANSWER from', from);\n      const pc = peerConnections.get(from);\n      if (pc && pc.signalingState === 'have-local-offer') {\n        console.log('[Signaling] Setting remote description from ANSWER');\n        try {\n          await pc.setRemoteDescription(new RTCSessionDescription(answer));\n          console.log('[Signaling] Remote description set successfully');\n        } catch (err) {\n          console.error('[Signaling] Error handling answer:', err);\n        }\n      } else {\n        console.warn('[Signaling] Cannot handle ANSWER - pc:', !!pc, 'signalingState:', pc?.signalingState);\n      }\n    },\n    async handleIceCandidate(from, candidate) {\n      console.log('[Signaling] Handling ICE_CANDIDATE from', from);\n      const pc = peerConnections.get(from);\n      if (pc) {\n        try {\n          await pc.addIceCandidate(new RTCIceCandidate(candidate));\n          console.log('[Signaling] ICE candidate added successfully');\n        } catch (err) {\n          console.warn('[Signaling] Error adding ICE candidate', err);\n        }\n      } else {\n        console.warn('[Signaling] No peer connection found for ICE candidate from', from);\n      }\n    },\n    handleLeave(from) {\n      console.log('[Signaling] Handling LEAVE from', from);\n      peersThatLeft.add(from);\n      const pc = peerConnections.get(from);\n      if (pc) {\n        try { pc.close(); } catch (e) {}\n        peerConnections.delete(from);\n      }\n      clearReconnection(from);\n      removeRemoteVideo(from);\n    }\n  };\n}\n","export class URLSync {\n  constructor(stateManager) {\n    this.stateManager = stateManager;\n    this.urlMonitorInterval = null;\n    this.lastUrl = null;\n  }\n  start() { this.lastUrl = window.location.href; }\n  stop() {\n    if (this.urlMonitorInterval) { clearInterval(this.urlMonitorInterval); this.urlMonitorInterval = null; }\n  }\n  saveState() {\n    const state = this.stateManager.getState();\n    if (!state.partyActive) return;\n    const existing = this.getRestorationState() || {};\n    const payload = {\n      roomId: state.roomId,\n      currentTime: existing.currentTime || null,\n      isPlaying: typeof existing.isPlaying === 'boolean' ? existing.isPlaying : null,\n      timestamp: Date.now()\n    };\n    sessionStorage.setItem('toperparty_restore', JSON.stringify(payload));\n  }\n  clearState() { sessionStorage.removeItem('toperparty_restore'); }\n  getRestorationState() {\n    const stored = sessionStorage.getItem('toperparty_restore');\n    if (!stored) return null;\n    try {\n      const state = JSON.parse(stored);\n      if (Date.now() - state.timestamp < 30000) { return state; }\n    } catch (e) { console.error('[toperparty] Failed to parse restoration state:', e); }\n    return null;\n  }\n}\n"],"names":["SyncLock","constructor","this","suppressLocalUntil","set","durationMs","Date","now","isActive","MutableRef","value","get","v","addOrReplaceTrack","pc","track","stream","existingSender","getSenders","find","s","kind","replaceTrack","catch","e","console","warn","addTrack","log","stateManager","partyActive","userId","roomId","restoringPartyState","startParty","stopParty","getUserId","getRoomId","getState","isInParty","setRestoringFlag","isExtensionContextValid","chrome","runtime","id","safeSendMessage","message","callback","sendMessage","uiManager","localPreviewVideo","remoteVideos","Map","remoteStreams","streamMonitorInterval","getRemoteVideos","getRemoteStreams","setLocalPreviewVideo","video","getLocalPreviewVideo","setStreamMonitorInterval","interval","getStreamMonitorInterval","clearStreamMonitorInterval","clearInterval","attachLocalPreview","removeLocalPreview","document","createElement","autoplay","muted","playsInline","style","position","bottom","left","width","height","zIndex","border","borderRadius","transform","srcObject","src","URL","createObjectURL","body","appendChild","play","err","remove","clearAll","clear","netflixController","injectAPIBridge","script","getURL","head","documentElement","onload","_sendCommand","command","args","Promise","resolve","handler","detail","removeEventListener","result","addEventListener","setTimeout","dispatchEvent","CustomEvent","pause","seek","timeMs","getCurrentTime","isPaused","getVideoElement","querySelector","syncManager","state","netflix","lock","isInitializedRef","listeners","remote","async","applyRemote","actionName","actionFn","error","handleRequestSync","fromUserId","currentTime","currentTimeSeconds","toFixed","type","targetUserId","isPlaying","handleSyncResponse","localPaused","handlePlaybackControl","control","toUpperCase","handleSeek","createRemoteHandlers","setup","waitForVideo","onPlay","onPause","onSeek","handlePlay","handlePause","handleSeeked","attachPlaybackListeners","vid","broadcastPlay","broadcastPause","broadcastSeek","teardown","reject","timeout","Error","check","clearTimeout","paused","webrtcManager","peerConnections","peersThatLeft","Set","localStream","videoManager","peerId","delete","add","getTracks","right","size","then","volume","createRemoteVideoManager","reconnectionManager","createPeer","sendSignal","addRemoteVideo","attemptReconnection","clearReconnection","removeRemoteVideo","RTCPeerConnection","iceServers","urls","onicecandidate","event","candidate","from","to","ontrack","streams","MediaStream","has","length","onconnectionstatechange","connectionState","createPeerConnectionFactory","msg","_sendSignal","attempt","Object","assign","attempts","timeouts","handle","count","backoffDelay","Math","min","pow","existing","oldPc","close","forEach","t","offer","createOffer","setLocalDescription","localDescription","createReconnectionManager","signalingHandlers","getLocalStream","handleJoin","handleOffer","signalingState","setRemoteDescription","RTCSessionDescription","answer","createAnswer","handleAnswer","handleIceCandidate","addIceCandidate","RTCIceCandidate","handleLeave","createSignalingHandlers","setLocalStream","onLocalStreamAvailable","handleSignal","stop","urlSync","urlMonitorInterval","lastUrl","start","window","location","href","saveState","getRestorationState","payload","timestamp","sessionStorage","setItem","JSON","stringify","clearState","removeItem","stored","getItem","parse","videoElementMonitor","restorationState","onMessage","addListener","request","sender","sendResponse","navigator","mediaDevices","getUserMedia","audio","success","setInterval","getElementById","videoId","url"],"ignoreList":[],"sourceRoot":""}