(()=>{"use strict";var e,t,s={},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={exports:{}};return s[e](n,n.exports,o),n.exports}o.m=s,o.d=(e,t)=>{for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce((t,s)=>(o.f[s](e,t),t),[])),o.u=e=>e+".js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="tandem.watch:",o.l=(s,r,n,c)=>{if(e[s])e[s].push(r);else{var a,i;if(void 0!==n)for(var d=document.getElementsByTagName("script"),h=0;h<d.length;h++){var u=d[h];if(u.getAttribute("src")==s||u.getAttribute("data-webpack")==t+n){a=u;break}}a||(i=!0,(a=document.createElement("script")).charset="utf-8",o.nc&&a.setAttribute("nonce",o.nc),a.setAttribute("data-webpack",t+n),a.src=s),e[s]=[r];var l=(t,r)=>{a.onerror=a.onload=null,clearTimeout(m);var o=e[s];if(delete e[s],a.parentNode&&a.parentNode.removeChild(a),o&&o.forEach(e=>e(r)),t)return t(r)},m=setTimeout(l.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=l.bind(null,a.onerror),a.onload=l.bind(null,a.onload),i&&document.head.appendChild(a)}},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var r=s.length-1;r>-1&&(!e||!/^http(s?):/.test(e));)e=s[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={471:0};o.f.j=(t,s)=>{var r=o.o(e,t)?e[t]:void 0;if(0!==r)if(r)s.push(r[2]);else{var n=new Promise((s,o)=>r=e[t]=[s,o]);s.push(r[2]=n);var c=o.p+o.u(t),a=new Error;o.l(c,s=>{if(o.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var n=s&&("load"===s.type?"missing":s.type),c=s&&s.target&&s.target.src;a.message="Loading chunk "+t+" failed.\n("+n+": "+c+")",a.name="ChunkLoadError",a.type=n,a.request=c,r[1](a)}},"chunk-"+t,t)}};var t=(t,s)=>{var r,n,[c,a,i]=s,d=0;if(c.some(t=>0!==e[t])){for(r in a)o.o(a,r)&&(o.m[r]=a[r]);i&&i(o)}for(t&&t(s);d<c.length;d++)n=c[d],o.o(e,n)&&e[n]&&e[n][0](),e[n]=0},s=self.webpackChunktandem_watch=self.webpackChunktandem_watch||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();const n=new class{constructor(){o.e(23).then(o.bind(o,23)).then(({CONFIG:e})=>{this.wsUrl=e.WS.URL,this.maxReconnectAttempts=e.WS.MAX_RECONNECT_ATTEMPTS,this.reconnectDelayMs=e.WS.RECONNECT_DELAY_MS}),this.ws=null,this.localStream=null,this.isConnected=!1,this.roomId=null,this.userId=this.generateUserId(),this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectTimer=null,this.intentionalDisconnect=!1,this.heartbeatInterval=null,this.heartbeatTimeout=null,this.missedHeartbeats=0,this.reconnectDelayMs=3e3,this.wsUrl="ws://10.0.0.102:30401/ws"}generateUserId(){return"user_"+Math.random().toString(36).substr(2,9)}async startParty(e){return this.roomId=e||"default_room_"+Date.now(),this.intentionalDisconnect=!1,new Promise((e,t)=>{try{chrome.tabs.query({url:"https://www.netflix.com/*"},s=>{0===s.length?this.getMediaStreamInBackground().then(()=>this.connectToSignalingServer(e,t)).catch(t):chrome.tabs.sendMessage(s[0].id,{type:"REQUEST_MEDIA_STREAM"},s=>{if(chrome.runtime.lastError)return console.warn("Content script not ready, trying background:",chrome.runtime.lastError),void this.getMediaStreamInBackground().then(()=>this.connectToSignalingServer(e,t)).catch(t);s&&s.success?this.connectToSignalingServer(e,t):this.getMediaStreamInBackground().then(()=>this.connectToSignalingServer(e,t)).catch(t)})})}catch(e){t(e)}})}async getMediaStreamInBackground(){console.log("Note: Media stream will be obtained from Netflix page")}connectToSignalingServer(e,t){try{console.log("[BackgroundService] Connecting to signaling server:",this.wsUrl),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{console.log("[BackgroundService] Connected to signaling server"),this.isConnected=!0,this.reconnectAttempts=0,this.missedHeartbeats=0,this.ws.send(JSON.stringify({type:"JOIN",userId:this.userId,roomId:this.roomId,timestamp:Date.now()})),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STARTED",userId:this.userId,roomId:this.roomId}).catch(()=>{}),chrome.tabs.sendMessage(e.id,{type:"REQUEST_INITIAL_SYNC_AND_PLAY"}).catch(()=>{}),chrome.tabs.sendMessage(e.id,{type:"CONNECTION_STATUS",status:"connected"}).catch(()=>{})})}),this.startHeartbeat(),e()},this.ws.onmessage=e=>this.handleSignalingMessage(e.data),this.ws.onerror=e=>{console.warn("[BackgroundService] WebSocket error:",e),0===this.reconnectAttempts&&t(new Error("Failed to connect to signaling server"))},this.ws.onclose=()=>{console.log("[BackgroundService] WebSocket closed"),this.isConnected=!1,chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"CONNECTION_STATUS",status:"disconnected"}).catch(()=>{})})}),!this.intentionalDisconnect&&this.roomId?this.attemptReconnection():this.cleanup()}}catch(e){t(e)}}stopParty(e=!0){if(this.intentionalDisconnect=!0,this.stopHeartbeat(),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws){if(e)try{this.ws.send(JSON.stringify({type:"LEAVE",userId:this.userId,roomId:this.roomId,timestamp:Date.now()}))}catch(e){}this.ws.close(),this.ws=null}this.cleanup(),this.isConnected=!1,this.reconnectAttempts=0,e&&(this.roomId=null,chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STOPPED"}).catch(()=>{})})}))}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}async handleSignalingMessage(e){try{const t=JSON.parse(e);if(console.log("[BackgroundService] Received signaling message:",t.type),"PONG"===t.type)return this.heartbeatTimeout&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null),this.missedHeartbeats=0,void console.log("[BackgroundService] Heartbeat acknowledged");chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"SIGNAL",message:t}).catch(()=>{})})}),"PLAY_PAUSE"===t.type&&t.userId!==this.userId&&(console.log("[BackgroundService] Forwarding PLAY_PAUSE to content:",t.control,"at",t.currentTime,"from",t.userId),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_PLAYBACK_CONTROL",control:t.control,currentTime:t.currentTime,fromUserId:t.userId}).catch(()=>{})})})),"SYNC_PLAYBACK"===t.type&&t.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SYNC_PLAYBACK",currentTime:t.currentTime,isPlaying:t.isPlaying,timestamp:t.timestamp,fromUserId:t.userId}).catch(()=>{})})}),"SEEK"===t.type&&t.userId!==this.userId&&(console.log("[BackgroundService] Forwarding SEEK to content:",t.currentTime,"playing:",t.isPlaying,"from",t.userId),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SEEK",currentTime:t.currentTime,isPlaying:t.isPlaying,fromUserId:t.userId}).catch(()=>{})})})),"URL_CHANGE"===t.type&&t.userId!==this.userId&&(console.log("[BackgroundService] Forwarding URL_CHANGE to content:",t.url,"from",t.userId),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_URL_CHANGE",url:t.url,fromUserId:t.userId}).catch(()=>{})})})),"REQUEST_SYNC"===t.type&&t.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"HANDLE_REQUEST_SYNC",fromUserId:t.userId,respectAutoPlay:t.respectAutoPlay||!1}).catch(()=>{})})}),"SYNC_RESPONSE"===t.type&&t.to===this.userId&&(console.log("[BackgroundService] Received SYNC_RESPONSE for me, forwarding to content with URL:",t.url),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SYNC_RESPONSE",currentTime:t.currentTime,isPlaying:t.isPlaying,fromUserId:t.fromUserId,url:t.url,respectAutoPlay:t.respectAutoPlay||!1}).catch(()=>{})})}))}catch(e){console.error("Error handling signaling message:",e)}}attemptReconnection(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return console.error("[BackgroundService] Max reconnection attempts reached. Party disconnected."),void this.stopParty(!1);this.reconnectAttempts++;const e=Math.min(1e3*Math.pow(2,this.reconnectAttempts-1),3e4);console.log(`[BackgroundService] Attempting reconnection ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${e}ms...`),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"CONNECTION_STATUS",status:"reconnecting"}).catch(()=>{})})}),this.reconnectTimer=setTimeout(()=>{this.reconnect()},e)}reconnect(){console.log("[BackgroundService] Reconnecting to signaling server:",this.wsUrl),this.intentionalDisconnect=!1;try{this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{console.log("[BackgroundService] Reconnected successfully"),this.isConnected=!0,this.reconnectAttempts=0,this.missedHeartbeats=0,this.ws.send(JSON.stringify({type:"JOIN",userId:this.userId,roomId:this.roomId,timestamp:Date.now()})),this.startHeartbeat(),console.log("[BackgroundService] Rejoined room after reconnection"),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"RECONNECTED",userId:this.userId,roomId:this.roomId}).catch(()=>{}),chrome.tabs.sendMessage(e.id,{type:"CONNECTION_STATUS",status:"connected"}).catch(()=>{}),chrome.tabs.sendMessage(e.id,{type:"REQUEST_SYNC_AFTER_RECONNECT"}).catch(()=>{})})})},this.ws.onmessage=e=>this.handleSignalingMessage(e.data),this.ws.onerror=e=>{console.warn("[BackgroundService] Reconnection WebSocket error:",e)},this.ws.onclose=()=>{console.log("[BackgroundService] Reconnected WebSocket closed"),this.isConnected=!1,chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"CONNECTION_STATUS",status:"disconnected"}).catch(()=>{})})}),!this.intentionalDisconnect&&this.roomId&&this.attemptReconnection()}}catch(e){console.error("[BackgroundService] Reconnection failed:",e),this.attemptReconnection()}}broadcastMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN?(console.log("[BackgroundService] Broadcasting message:",e.type,e),this.ws.send(JSON.stringify(e))):console.warn("[BackgroundService] Cannot broadcast - WebSocket not open:",this.ws?this.ws.readyState:"no ws")}startHeartbeat(){this.stopHeartbeat(),console.log("[BackgroundService] Starting heartbeat monitoring"),this.heartbeatInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(JSON.stringify({type:"PING",userId:this.userId,timestamp:Date.now()})),this.heartbeatTimeout=setTimeout(()=>{this.missedHeartbeats++,console.warn("[BackgroundService] Missed heartbeat response. Count:",this.missedHeartbeats),this.missedHeartbeats>=3&&(console.error("[BackgroundService] Connection appears dead, forcing reconnection"),this.stopHeartbeat(),this.ws&&this.ws.close())},1e4)}catch(e){console.error("[BackgroundService] Error sending ping:",e)}else console.warn("[BackgroundService] WebSocket not open, stopping heartbeat"),this.stopHeartbeat()},15e3)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this.heartbeatTimeout&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null),this.missedHeartbeats=0}getStatus(){return{isConnected:this.isConnected,roomId:this.roomId,userId:this.userId,hasLocalStream:!!this.localStream}}};chrome.runtime.onMessage.addListener((e,t,s)=>{if("START_PARTY"===e.type)return n.startParty(e.roomId).then(()=>{s({success:!0})}).catch(e=>{s({success:!1,error:e.message})}),!0;if("STOP_PARTY"===e.type&&(n.stopParty(),s({success:!0})),"RESTORE_PARTY"===e.type){if(!n.ws||n.ws.readyState!==WebSocket.OPEN)return console.log("[Background] RESTORE_PARTY - WebSocket not connected, reconnecting"),n.stopParty(!1),n.startParty(e.roomId).then(()=>{s({success:!0,userId:n.userId,roomId:n.roomId})}).catch(e=>{s({success:!1,error:e.message})}),!0;console.log("[Background] RESTORE_PARTY - WebSocket already connected, reusing connection"),n.roomId=e.roomId,n.intentionalDisconnect=!1,console.log("[Background] Sending JOIN for room:",e.roomId,"userId:",n.userId),n.ws.send(JSON.stringify({type:"JOIN",userId:n.userId,roomId:n.roomId,timestamp:Date.now()})),setTimeout(()=>{chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STARTED",userId:n.userId,roomId:n.roomId}).catch(()=>{})})})},150),s({success:!0,userId:n.userId,roomId:n.roomId})}if("GET_STATUS"===e.type)return s(n.getStatus()),!0;if("PLAY_PAUSE"===e.type&&(console.log("[Background] Broadcasting PLAY_PAUSE:",e.control,"at",e.currentTime),n.broadcastMessage({type:"PLAY_PAUSE",control:e.control,currentTime:e.currentTime,userId:n.userId,roomId:n.roomId}),s({success:!0})),"SYNC_TIME"===e.type&&(n.broadcastMessage({type:"SYNC_PLAYBACK",currentTime:e.currentTime,isPlaying:e.isPlaying,userId:n.userId,roomId:n.roomId}),s({success:!0})),"SEEK"===e.type&&(n.broadcastMessage({type:"SEEK",currentTime:e.currentTime,isPlaying:e.isPlaying,userId:n.userId,roomId:n.roomId}),s({success:!0})),"POSITION_UPDATE"===e.type&&(n.broadcastMessage({type:"POSITION_UPDATE",currentTime:e.currentTime,isPlaying:e.isPlaying,userId:n.userId,roomId:n.roomId}),s({success:!0})),"URL_CHANGE"===e.type&&(console.log("[Background] Broadcasting URL_CHANGE:",e.url),n.broadcastMessage({type:"URL_CHANGE",url:e.url,userId:n.userId,roomId:n.roomId}),s({success:!0})),"REQUEST_SYNC"===e.type&&(n.broadcastMessage({type:"REQUEST_SYNC",userId:n.userId,roomId:n.roomId,respectAutoPlay:e.respectAutoPlay||!1}),s({success:!0})),"SYNC_RESPONSE"===e.type&&(console.log("[Background] Forwarding SYNC_RESPONSE to",e.targetUserId,"with URL:",e.url),n.ws&&n.ws.readyState===WebSocket.OPEN&&n.ws.send(JSON.stringify({type:"SYNC_RESPONSE",to:e.targetUserId,currentTime:e.currentTime,isPlaying:e.isPlaying,url:e.url,respectAutoPlay:e.respectAutoPlay||!1,fromUserId:n.userId,roomId:n.roomId})),s({success:!0})),"SIGNAL_SEND"===e.type){const t=Object.assign({},e.message||{});if(t.userId=t.userId||n.userId,t.roomId=t.roomId||n.roomId,n.ws&&n.ws.readyState===WebSocket.OPEN)try{n.ws.send(JSON.stringify(t)),s({success:!0})}catch(e){s({success:!1,error:e.message})}else s({success:!1,error:"Not connected to signaling server"});return!0}})})();
//# sourceMappingURL=background.js.map