(()=>{var e={954:()=>{let e=null,r=null,t=!1,s=null,o=n();function n(){return"user_"+Math.random().toString(36).substr(2,9)}async function c(e){return s=e||"default_room_"+Date.now(),new Promise((e,r)=>{try{chrome.tabs.query({url:"https://www.netflix.com/*"},t=>{0===t.length?a().then(()=>i(e,r)).catch(r):chrome.tabs.sendMessage(t[0].id,{type:"REQUEST_MEDIA_STREAM"},t=>{if(chrome.runtime.lastError)return console.warn("Content script not ready, trying background:",chrome.runtime.lastError),void a().then(()=>i(e,r)).catch(r);t&&t.success?(console.log("Got media stream from content script"),i(e,r)):(console.warn("Content script failed to get media, trying background"),a().then(()=>i(e,r)).catch(r))})})}catch(e){r(e)}})}async function a(){try{return void console.log("Note: Media stream will be obtained from Netflix page")}catch(e){throw console.error("Could not get media in background:",e),e}}function i(r,n){try{e=new WebSocket("ws://watch.toper.dev/ws"),e.onopen=()=>{console.log("Connected to signaling server"),t=!0,e.send(JSON.stringify({type:"JOIN",userId:o,roomId:s,timestamp:Date.now()})),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STARTED",userId:o,roomId:s}).catch(()=>{})})}),r()},e.onmessage=e=>{!async function(e){try{const r=JSON.parse(e);chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"SIGNAL",message:r}).catch(()=>{})})}),"PLAYBACK_CONTROL"===r.type&&r.userId!==o&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_PLAYBACK_CONTROL",control:r.control,timestamp:r.timestamp,fromUserId:r.userId}).catch(()=>{})})}),"SYNC_PLAYBACK"===r.type&&r.userId!==o&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SYNC_PLAYBACK",currentTime:r.currentTime,isPlaying:r.isPlaying,timestamp:r.timestamp,fromUserId:r.userId}).catch(()=>{})})}),"SEEK"===r.type&&r.userId!==o&&(console.log("Forwarding SEEK command from remote user"),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SEEK",currentTime:r.currentTime,isPlaying:r.isPlaying,fromUserId:r.userId}).catch(()=>{})})})),"URL_CHANGE"===r.type&&r.userId!==o&&(console.log("Received URL change from remote user:",r.url),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_URL_CHANGE",url:r.url,fromUserId:r.userId}).catch(()=>{})})})),"REQUEST_SYNC"===r.type&&r.userId!==o&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"HANDLE_REQUEST_SYNC",fromUserId:r.userId}).catch(()=>{})})}),"SYNC_RESPONSE"===r.type&&r.to===o&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SYNC_RESPONSE",currentTime:r.currentTime,isPlaying:r.isPlaying,fromUserId:r.fromUserId}).catch(()=>{})})})}catch(e){console.error("Error handling signaling message:",e)}}(e.data)},e.onerror=e=>{console.error("WebSocket error:",e),n(new Error("Failed to connect to signaling server"))},e.onclose=()=>{console.log("Disconnected from signaling server"),t=!1,l()}}catch(e){n(e)}}function u(r=!0){if(e){if(r)try{e.send(JSON.stringify({type:"LEAVE",userId:o,roomId:s,timestamp:Date.now()}))}catch(e){console.warn("Error sending LEAVE signal:",e)}e.close(),e=null}l(),t=!1,chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STOPPED"}).catch(()=>{})})})}function l(){r&&(r.getTracks().forEach(e=>e.stop()),r=null)}function d(r){e&&e.readyState===WebSocket.OPEN&&e.send(JSON.stringify(r))}chrome.runtime.onMessage.addListener((a,i,l)=>{if(console.log("Background received message:",a.type),"START_PARTY"===a.type)return c(a.roomId).then(()=>{l({success:!0})}).catch(e=>{l({success:!1,error:e.message})}),!0;if("STOP_PARTY"===a.type&&(u(),l({success:!0})),"RESTORE_PARTY"===a.type)return console.log("Restoring party after navigation:",a.roomId),console.log("Performing full party reset (Stop -> Start) for restoration"),u(!1),o=n(),c(a.roomId).then(()=>{l({success:!0})}).catch(e=>{console.error("Failed to restore party:",e),l({success:!1,error:e.message})}),!0;if("GET_STATUS"===a.type)return console.log("Sending status:",{isConnected:t,roomId:s,userId:o,hasLocalStream:!!r}),l({isConnected:t,roomId:s,userId:o,hasLocalStream:!!r}),!0;if("PLAY_PAUSE"===a.type&&(d({type:"PLAYBACK_CONTROL",control:a.control,timestamp:a.timestamp,userId:o}),l({success:!0})),"SYNC_TIME"===a.type&&(d({type:"SYNC_PLAYBACK",currentTime:a.currentTime,isPlaying:a.isPlaying,userId:o}),l({success:!0})),"SEEK"===a.type&&(console.log("Broadcasting SEEK command:",a.currentTime),d({type:"SEEK",currentTime:a.currentTime,isPlaying:a.isPlaying,userId:o}),l({success:!0})),"URL_CHANGE"===a.type&&(console.log("Broadcasting URL change:",a.url),d({type:"URL_CHANGE",url:a.url,userId:o}),l({success:!0})),"REQUEST_SYNC"===a.type&&(console.log("Broadcasting REQUEST_SYNC from",o),d({type:"REQUEST_SYNC",userId:o}),l({success:!0})),"SYNC_RESPONSE"===a.type&&(console.log("Forwarding SYNC_RESPONSE to",a.targetUserId),e&&e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({type:"SYNC_RESPONSE",to:a.targetUserId,currentTime:a.currentTime,isPlaying:a.isPlaying,fromUserId:o})),l({success:!0})),"SIGNAL_SEND"===a.type){const r=Object.assign({},a.message||{});if(r.userId=r.userId||o,r.roomId=r.roomId||s,e&&e.readyState===WebSocket.OPEN)try{e.send(JSON.stringify(r)),l({success:!0})}catch(e){l({success:!1,error:e.message})}else l({success:!1,error:"Not connected to signaling server"});return!0}})}},r={};function t(s){var o=r[s];if(void 0!==o)return o.exports;var n=r[s]={exports:{}};return e[s](n,n.exports,t),n.exports}t.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},t.d=(e,r)=>{for(var s in r)t.o(r,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:r[s]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),(()=>{"use strict";t(954)})()})();
//# sourceMappingURL=background.js.map