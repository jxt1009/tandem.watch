(()=>{"use strict";class e{constructor(){this.suppressLocalUntil=0}set(e){this.suppressLocalUntil=Date.now()+e}isActive(){return Date.now()<this.suppressLocalUntil}}class t{constructor(e=200){this.delayMs=e,this.timer=null,this.events=new Set}add(e){this.events.add(e)}schedule(e){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=this.events;this.events=new Set,this.timer=null,e(t)},this.delayMs)}cancel(){this.timer&&clearTimeout(this.timer),this.timer=null,this.events.clear()}}class a{constructor(e){this.value=e}get(){return this.value}set(e){this.value=e}}function n(e,t,a){const n=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(n)n.replaceTrack(t).catch(e=>console.warn("[WebRTCManager] Error replacing track",e));else try{e.addTrack(t,a)}catch(e){}}console.log("[Content Script] Initializing managers...");const s=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}isInParty(){return!!(this.partyActive&&this.userId&&this.roomId)}setRestoringFlag(e){this.restoringPartyState=e}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch{return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid())try{chrome.runtime.sendMessage(e,t)}catch(e){console.warn("Failed to send message:",e.message)}}},r=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}clearAll(){this.localPreviewVideo=null,this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval()}},i=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){e.remove()}}_sendCommand(e,t=[]){return new Promise(function(a){const n=function(t){t.detail.command===e&&(document.removeEventListener("__toperparty_response",n),a(t.detail.result))};document.addEventListener("__toperparty_response",n),setTimeout(function(){a(null)},1e3),document.dispatchEvent(new CustomEvent("__toperparty_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}isPaused(){return this._sendCommand("isPaused")}getVideoElement(){return document.querySelector("video")}},o=new class{constructor(n,s){this.state=n,this.netflix=s,this.lock=new e,this.debouncer=new t(200),this.isInitializedRef=new a(!1),this.listeners=null,this.contextRef=new a({lastUserInteractionAt:0}),this.remote=function({state:e,netflix:t,lock:a,isInitializedRef:n,contextRef:s}){async function r(e,t,n){a.set(t);try{await n()}catch(t){console.error(`[SyncManager] Error applying remote ${e}:`,t)}}return{async handleRequestSync(a){if(n.get())try{const n=await t.getCurrentTime(),s=await t.isPaused();e.safeSendMessage({type:"SYNC_RESPONSE",targetUserId:a,currentTime:n/1e3,isPlaying:!s})}catch(e){console.error("[SyncManager] Error handling sync request:",e)}},async handleSyncResponse(e,a,s){n.get()||(n.set(!0),await r("initial-sync",2e3,async()=>{await t.seek(1e3*e);const n=await t.isPaused();a&&n?await t.play():a||n||await t.pause()}))},async handlePlaybackControl(e){await r(e,1e3,async()=>{"play"===e?await t.play():await t.pause()})},async handleSeek(e,a){await r("seek",2e3,async()=>{await t.seek(1e3*e);const n=await t.isPaused();a&&n?await t.play():a||n||await t.pause()})},async handlePassiveSync(e,n,i,o){const c=Date.now();if(!(o&&c-o>5e3||c-s.get().lastUserInteractionAt<1e4||a.isActive()))try{const a=await t.getCurrentTime(),s=1e3*e;if(Math.abs(a-s)<=3e3)return;await r("passive-correction",1500,async()=>{await t.seek(s);const e=await t.isPaused();n&&e?await t.play():n||e||await t.pause()})}catch(e){console.error("[SyncManager] Error handling passive sync:",e)}}}}({state:this.state,netflix:this.netflix,lock:this.lock,isInitializedRef:this.isInitializedRef,contextRef:this.contextRef})}async setup(){try{const e=await this.waitForVideo();if(!e)return void console.warn("[SyncManager] Netflix video element not found");this.isInitializedRef.set(!1),this.state.safeSendMessage({type:"REQUEST_SYNC"}),setTimeout(()=>{this.isInitializedRef.get()||this.isInitializedRef.set(!0)},2e3);const t=function({video:e,state:t,isInitializedRef:a,lock:n,debouncer:s,onBroadcast:r,onPassiveSyncContext:i}){const o={lastUserInteractionAt:0},c=i=>{t.isActive()&&a.get()&&(n.isActive()||(o.lastUserInteractionAt=Date.now(),s.add(i.type),s.schedule(()=>r(e))))};let l=0;const d=()=>{if(!t.isActive())return;const a=Date.now();n.isActive()||a-o.lastUserInteractionAt<5e3||a-l<1e4||e.paused||(l=a,i({now:a,lastPassiveSentAt:l}))};return e.addEventListener("play",c),e.addEventListener("pause",c),e.addEventListener("seeked",c),e.addEventListener("timeupdate",d),{video:e,handleLocalEvent:c,handleTimeUpdate:d,context:o}}({video:e,state:this.state,isInitializedRef:this.isInitializedRef,lock:this.lock,debouncer:this.debouncer,onBroadcast:e=>this.broadcastLocalState(e),onPassiveSyncContext:({now:t})=>{this.state.safeSendMessage({type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused,timestamp:t})}});this.listeners=t,this.contextRef.set(t.context)}catch(e){console.error("[SyncManager] Error setting up playback sync:",e)}}teardown(){if(this.listeners&&this.listeners.video){const{video:e,handleLocalEvent:t,handleTimeUpdate:a}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",t),e.removeEventListener("seeked",t),e.removeEventListener("timeupdate",a)}catch(e){console.warn("[SyncManager] Error removing listeners:",e)}this.listeners=null}this.debouncer.cancel()}waitForVideo(){return new Promise((e,t)=>{const a=setTimeout(()=>t(new Error("Video element timeout")),1e4),n=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(a),e(t)):setTimeout(n,100)};n()})}broadcastLocalState(e){const t=e.currentTime,a=!e.paused,n=new Set(this.debouncer.events);if(n.has("seeked"))this.state.safeSendMessage({type:"SEEK",currentTime:t,isPlaying:a});else if(n.has("play")||n.has("pause")){const e=a?"play":"pause";this.state.safeSendMessage({type:"PLAY_PAUSE",control:e,timestamp:t})}}handleRequestSync(e){return this.remote.handleRequestSync(e)}handleSyncResponse(e,t,a){return this.remote.handleSyncResponse(e,t,a)}handlePlaybackControl(e,t){return this.remote.handlePlaybackControl(e,t)}handleSeek(e,t,a){return this.remote.handleSeek(e,t,a)}handlePassiveSync(e,t,a,n){return this.remote.handlePassiveSync(e,t,a,n)}}(s,i),c=new class{constructor(e,t){this.stateManager=e,this.uiManager=t,this.peerConnections=new Map,this.remoteStreams=this.uiManager.getRemoteStreams(),this.remoteVideos=this.uiManager.getRemoteVideos(),this.peersThatLeft=new Set,this.localStream=null;const a=function(e){function t(t){const a=e.get(t);if(a){try{a.srcObject&&(a.srcObject=null)}catch(e){}a.remove(),e.delete(t)}}return{add:function(a,n){t(a);const s=document.createElement("video");s.id="toperparty-remote-"+a,s.autoplay=!0,s.playsInline=!0,s.muted=!0,s.style.position="fixed",s.style.bottom="20px",s.style.right=20+180*e.size+"px",s.style.width="240px",s.style.height="160px",s.style.zIndex=10001,s.style.border="2px solid #00aaff",s.style.borderRadius="4px";try{s.srcObject=n}catch(e){s.src=URL.createObjectURL(n)}document.body.appendChild(s),e.set(a,s);try{s.play().then(()=>{s.muted=!1,s.volume=1}).catch(()=>{s.muted=!1})}catch(e){}},remove:t}}(this.remoteVideos),s=function({stateManager:e,peerConnections:t,peersThatLeft:a,localStream:n,createPeer:s,sendSignal:r,addOrReplaceTrack:i}){const o=new Map,c=new Map;function l(e){o.delete(e);const t=c.get(e);t&&(clearTimeout(t),c.delete(e))}return{attempt:async function d(h){if(!e.isInParty())return;if(a.has(h))return void l(h);const m=o.get(h)||0,u=Math.min(1e3*Math.pow(2,m),3e4);if(m>=5)return void l(h);o.set(h,m+1);const g=c.get(h);g&&clearTimeout(g);const p=setTimeout(async()=>{const a=t.get(h);if(a){try{a.close()}catch(e){}t.delete(h)}try{const a=s(h);t.set(h,a),n&&n.getTracks().forEach(e=>i(a,e,n));const o=await a.createOffer();await a.setLocalDescription(o);const c=e.getState();r({type:"OFFER",from:c.userId,to:h,offer:a.localDescription})}catch(e){console.error("[WebRTCManager] Reconnection failed:",e),d(h)}},u);c.set(h,p)},clear:l}}({stateManager:this.stateManager,peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,localStream:()=>this.localStream,createPeer:null,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:n}),r=function({stateManager:e,sendSignal:t,remoteStreams:a,remoteVideos:n,addRemoteVideo:s,attemptReconnection:r,clearReconnection:i,removeRemoteVideo:o,peersThatLeft:c}){return function(l){const d=e.getState(),h=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return h.onicecandidate=e=>{e.candidate&&t({type:"ICE_CANDIDATE",from:d.userId,to:l,candidate:e.candidate})},h.ontrack=e=>{let t=e.streams&&e.streams[0]||a.get(l);if(t||(t=new MediaStream,a.set(l,t)),e.track)try{t.addTrack(e.track)}catch(e){}n.has(l)||s(l,t)},h.onconnectionstatechange=()=>{"connected"===h.connectionState?i(l):"disconnected"===h.connectionState||"failed"===h.connectionState?c.has(l)?(o(l),i(l)):(o(l),r(l)):"closed"===h.connectionState&&(o(l),i(l))},h}}({stateManager:this.stateManager,sendSignal:e=>this._sendSignal(e),remoteStreams:this.remoteStreams,remoteVideos:this.remoteVideos,addRemoteVideo:a.add,attemptReconnection:s.attempt,clearReconnection:s.clear,removeRemoteVideo:e=>{a.remove(e),this.remoteStreams.delete(e)},peersThatLeft:this.peersThatLeft});s.createPeer=r,this.reconnectionManager=s,this.createPeer=r,this.videoManager=a,this.signalingHandlers=function({getState:e,peerConnections:t,peersThatLeft:a,getLocalStream:n,createPeer:s,sendSignal:r,addOrReplaceTrack:i,clearReconnection:o,removeRemoteVideo:c}){return{async handleJoin(o){console.log("[WebRTCManager] Handling JOIN from",o);const c=e();if(o!==c.userId&&(a.delete(o),!t.has(o)))try{const e=s(o);t.set(o,e);const a=n();a&&a.getTracks().forEach(t=>i(e,t,a));const l=await e.createOffer();await e.setLocalDescription(l),r({type:"OFFER",from:c.userId,to:o,offer:e.localDescription})}catch(e){console.error("[WebRTCManager] Error handling JOIN:",e),t.delete(o)}},async handleOffer(a,o){console.log("[WebRTCManager] Handling OFFER from",a);const c=e();if(a===c.userId)return;let l=t.get(a);if(l&&"closed"!==l.signalingState){try{l.close()}catch(e){}t.delete(a),l=null}l||(l=s(a),t.set(a,l));try{await l.setRemoteDescription(new RTCSessionDescription(o));const e=n();e&&e.getTracks().forEach(t=>i(l,t,e));const t=await l.createAnswer();await l.setLocalDescription(t),r({type:"ANSWER",from:c.userId,to:a,answer:l.localDescription})}catch(e){console.error("[WebRTCManager] Error handling offer:",e),t.delete(a);try{l.close()}catch(e){}}},async handleAnswer(e,a){console.log("[WebRTCManager] Handling ANSWER from",e);const n=t.get(e);if(n&&"have-local-offer"===n.signalingState)try{await n.setRemoteDescription(new RTCSessionDescription(a))}catch(e){console.error("[WebRTCManager] Error handling answer:",e)}},async handleIceCandidate(e,a){console.log("[WebRTCManager] Handling ICE_CANDIDATE from",e);const n=t.get(e);if(n)try{await n.addIceCandidate(new RTCIceCandidate(a))}catch(e){console.warn("[WebRTCManager] Error adding ICE candidate",e)}},handleLeave(e){console.log("[WebRTCManager] Handling LEAVE from",e),a.add(e);const n=t.get(e);if(n){try{n.close()}catch(e){}t.delete(e)}o(e),c(e)}}}({getState:()=>this.stateManager.getState(),peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,getLocalStream:()=>this.localStream,createPeer:r,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:n,clearReconnection:s.clear,removeRemoteVideo:e=>{a.remove(e),this.remoteStreams.delete(e)}})}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}onLocalStreamAvailable(e){this.localStream=e,this.peerConnections.forEach(t=>{try{e.getTracks().forEach(a=>n(t,a,e))}catch(e){}})}async handleSignal(e){if(!e||!e.type)return;const t=e.type,a=e.userId||e.from,n=e.to,s=this.stateManager.getState();n&&n!==s.userId||("JOIN"===t&&a&&a!==s.userId?await this.signalingHandlers.handleJoin(a):"OFFER"===t&&e.offer&&a&&a!==s.userId?await this.signalingHandlers.handleOffer(a,e.offer):"ANSWER"===t&&e.answer&&a&&a!==s.userId?await this.signalingHandlers.handleAnswer(a,e.answer):"ICE_CANDIDATE"===t&&e.candidate&&a&&a!==s.userId?await this.signalingHandlers.handleIceCandidate(a,e.candidate):"LEAVE"===t&&a&&this.signalingHandlers.handleLeave(a))}attemptReconnection(e){return this.reconnectionManager.attempt(e)}_sendSignal(e){this.stateManager.safeSendMessage({type:"SIGNAL_SEND",message:e},function(){})}clearAll(){this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.peersThatLeft.clear(),this.remoteVideos.forEach(e=>{try{e.srcObject&&(e.srcObject=null)}catch(e){}e.remove()}),this.remoteVideos.clear(),this.remoteStreams.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}}(s,r),l=new class{constructor(e){this.stateManager=e,this.urlMonitorInterval=null,this.lastUrl=null}start(){this.lastUrl=window.location.href}stop(){this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null)}saveState(){const e=this.stateManager.getState();if(!e.partyActive)return;const t=this.getRestorationState()||{},a={roomId:e.roomId,currentTime:t.currentTime||null,isPlaying:"boolean"==typeof t.isPlaying?t.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("toperparty_restore",JSON.stringify(a))}clearState(){sessionStorage.removeItem("toperparty_restore")}getRestorationState(){const e=sessionStorage.getItem("toperparty_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[toperparty] Failed to parse restoration state:",e)}return null}}(s);console.log("[Content Script] Managers initialized");let d=null;!function(){const e=l.getRestorationState();e&&(l.clearState(),s.setRestoringFlag(!0),setTimeout(function(){chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:e.roomId}),setTimeout(function(){s.setRestoringFlag(!1)},2e3)},1e3))}(),chrome.runtime.onMessage.addListener((e,t,a)=>{if(console.log("[Content Script] Received message:",e.type),"REQUEST_MEDIA_STREAM"===e.type)return navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{d=e,c.setLocalStream(e),c.onLocalStreamAvailable(e),a({success:!0})}).catch(e=>a({success:!1,error:e.message})),!0;"PARTY_STARTED"===e.type&&(console.log("[Content Script] Party started:",e.userId,e.roomId),s.startParty(e.userId,e.roomId),o.setup(),l.start(),a({success:!0})),"PARTY_STOPPED"===e.type&&(s.stopParty(),o.teardown(),l.stop(),l.clearState(),c.clearAll(),d&&(d.getTracks().forEach(e=>e.stop()),d=null),a({success:!0})),"SIGNAL"===e.type&&(console.log("[Content Script] Handling SIGNAL:",e.message?.type),c.handleSignal(e.message)),"APPLY_PLAYBACK_CONTROL"===e.type&&o.handlePlaybackControl(e.control,e.fromUserId),"APPLY_SYNC_PLAYBACK"===e.type&&o.handlePassiveSync(e.currentTime,e.isPlaying,e.fromUserId,e.timestamp),"APPLY_SEEK"===e.type&&o.handleSeek(e.currentTime,e.isPlaying,e.fromUserId),"APPLY_URL_CHANGE"===e.type&&(s.restoringPartyState||(window.location.href=e.url)),"HANDLE_REQUEST_SYNC"===e.type&&o.handleRequestSync(e.fromUserId),"APPLY_SYNC_RESPONSE"===e.type&&o.handleSyncResponse(e.currentTime,e.isPlaying,e.fromUserId)}),window.addEventListener("beforeunload",()=>{s.isActive()&&l.saveState()})})();
//# sourceMappingURL=content-script.js.map