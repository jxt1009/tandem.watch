(()=>{"use strict";const e=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t,console.log("Party started! Room:",t,"User:",e)}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null,console.log("Party stopped")}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}isInParty(){return!!(this.partyActive&&this.userId&&this.roomId)}setRestoringFlag(e){this.restoringPartyState=e}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch(e){return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid())try{chrome.runtime.sendMessage(e,t)}catch(e){console.warn("Failed to send message, extension may have been reloaded:",e.message)}else console.warn("Extension context invalidated - please reload the page")}},t=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}clearAll(){this.localPreviewVideo=null,this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval()}},n=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){console.log("Netflix API bridge loaded"),e.remove()}}_sendCommand(e,t=[]){return new Promise(function(n){const o=function(t){t.detail.command===e&&(document.removeEventListener("__toperparty_response",o),n(t.detail.result))};document.addEventListener("__toperparty_response",o),setTimeout(function(){n(null)},1e3),document.dispatchEvent(new CustomEvent("__toperparty_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}isPaused(){return this._sendCommand("isPaused")}getVideoElement(){return document.querySelector("video")}},o=new class{constructor(e,t){this.state=e,this.netflix=t,this.listeners=null,this.suppressLocalUntil=0,this.debounceTimer=null,this.recentLocalEvents=new Set,this.lastUserInteractionAt=0,this.isInitialized=!1}async setup(){try{const e=await this.waitForVideo();if(!e)return void console.warn("[SyncManager] Netflix video element not found");this.isInitialized=!1,console.log("[SyncManager] Requesting initial sync state from peers..."),this.state.safeSendMessage({type:"REQUEST_SYNC"}),setTimeout(()=>{this.isInitialized||(console.log("[SyncManager] No sync response received (timeout). Assuming self-authority."),this.isInitialized=!0)},2e3),this.attachEventListeners(e),console.log("[SyncManager] Setup complete. Waiting for sync response...")}catch(e){console.error("[SyncManager] Error setting up playback sync:",e)}}teardown(){if(this.listeners&&this.listeners.video){const{video:e,handleLocalEvent:t,handleTimeUpdate:n}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",t),e.removeEventListener("seeked",t),e.removeEventListener("timeupdate",n)}catch(e){console.warn("[SyncManager] Error removing listeners:",e)}this.listeners=null}this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}waitForVideo(){return new Promise((e,t)=>{const n=setTimeout(()=>t(new Error("Video element timeout")),1e4),o=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(n),e(t)):setTimeout(o,100)};o()})}attachEventListeners(e){const t=t=>{if(!this.state.isActive())return;if(!this.isInitialized)return void console.log(`[SyncManager] Suppressed local ${t.type} (waiting for init)`);const n=Date.now();n<this.suppressLocalUntil?console.log(`[SyncManager] Suppressed local ${t.type} (lock active)`):(this.lastUserInteractionAt=n,this.recentLocalEvents.add(t.type),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.broadcastLocalState(e)},200))};let n=0;const o=()=>{if(!this.state.isActive())return;const t=Date.now();if(t<this.suppressLocalUntil)return;if(t-this.lastUserInteractionAt<5e3)return;if(t-n<1e4)return;if(e.paused)return;n=t;const o={type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused,timestamp:t};console.log("[SyncManager] Sending passive sync:",o.currentTime.toFixed(2)),this.state.safeSendMessage(o)};e.addEventListener("play",t),e.addEventListener("pause",t),e.addEventListener("seeked",t),e.addEventListener("timeupdate",o),this.listeners={video:e,handleLocalEvent:t,handleTimeUpdate:o}}broadcastLocalState(e){const t=this.recentLocalEvents;this.recentLocalEvents=new Set,this.debounceTimer=null;const n=e.currentTime,o=!e.paused;if(t.has("seeked"))console.log("[SyncManager] Broadcasting SEEK:",n.toFixed(2)),this.state.safeSendMessage({type:"SEEK",currentTime:n,isPlaying:o});else if(t.has("play")||t.has("pause")){const e=o?"play":"pause";console.log("[SyncManager] Broadcasting PLAY_PAUSE:",e),this.state.safeSendMessage({type:"PLAY_PAUSE",control:e,timestamp:n})}}async handleRequestSync(e){if(this.isInitialized)try{const t=await this.netflix.getCurrentTime(),n=await this.netflix.isPaused();console.log("[SyncManager] Sending SYNC_RESPONSE to",e),this.state.safeSendMessage({type:"SYNC_RESPONSE",targetUserId:e,currentTime:t/1e3,isPlaying:!n})}catch(e){console.error("[SyncManager] Error handling sync request:",e)}}async handleSyncResponse(e,t,n){this.isInitialized?console.log("[SyncManager] Received late SYNC_RESPONSE, ignoring."):(console.log("[SyncManager] Received initial state from",n,"Time:",e,"Playing:",t),this.isInitialized=!0,await this._applyRemoteAction("initial-sync",2e3,async()=>{await this.netflix.seek(1e3*e);const n=await this.netflix.isPaused();t&&n?await this.netflix.play():t||n||await this.netflix.pause()}))}async _applyRemoteAction(e,t,n){console.log(`[SyncManager] Applying remote ${e}...`),this.suppressLocalUntil=Date.now()+t;try{await n()}catch(t){console.error(`[SyncManager] Error applying remote ${e}:`,t)}}async handlePlaybackControl(e,t){await this._applyRemoteAction(e,1e3,async()=>{"play"===e?await this.netflix.play():await this.netflix.pause()})}async handleSeek(e,t,n){await this._applyRemoteAction("seek",2e3,async()=>{await this.netflix.seek(1e3*e);const n=await this.netflix.isPaused();t&&n?await this.netflix.play():t||n||await this.netflix.pause()})}async handlePassiveSync(e,t,n,o){const a=Date.now();if(!(o&&a-o>5e3))if(a-this.lastUserInteractionAt<1e4)console.log("[SyncManager] Ignoring passive sync (recent local interaction)");else if(!(a<this.suppressLocalUntil))try{const n=await this.netflix.getCurrentTime(),o=1e3*e,a=Math.abs(n-o);if(a<=3e3)return;console.log(`[SyncManager] Drift detected (${(a/1e3).toFixed(2)}s). Correcting...`),await this._applyRemoteAction("passive-correction",1500,async()=>{await this.netflix.seek(o);const e=await this.netflix.isPaused();t&&e?await this.netflix.play():t||e||await this.netflix.pause()})}catch(e){console.error("[SyncManager] Error handling passive sync:",e)}}}(e,n),a=new class{constructor(e,t){this.stateManager=e,this.uiManager=t,this.peerConnections=new Map,this.reconnectionAttempts=new Map,this.reconnectionTimeouts=new Map,this.remoteStreams=this.uiManager.getRemoteStreams(),this.remoteVideos=this.uiManager.getRemoteVideos(),this.peersThatLeft=new Set,this.localStream=null}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}onLocalStreamAvailable(e){this.localStream=e,this.peerConnections.forEach(t=>{try{e.getTracks().forEach(n=>this._addOrReplaceTrack(t,n,e))}catch(e){console.warn("[WebRTCManager] Error adding tracks to peer connection",e)}})}async handleSignal(e){if(!e||!e.type)return;const t=e.type,n=e.userId||e.from,o=e.to,a=this.stateManager.getState();if(!o||o===a.userId)if("JOIN"===t&&n&&n!==a.userId){if(this.peersThatLeft.delete(n),!this.peerConnections.has(n))try{const e=this._createPeerConnection(n);this.peerConnections.set(n,e),this.localStream&&this.localStream.getTracks().forEach(t=>this._addOrReplaceTrack(e,t,this.localStream));const t=await e.createOffer();await e.setLocalDescription(t),this._sendSignal({type:"OFFER",from:a.userId,to:n,offer:e.localDescription})}catch(e){console.error("[WebRTCManager] Error handling JOIN and creating offer:",e),this.peerConnections.delete(n)}}else{if("OFFER"===t&&e.offer&&n&&n!==a.userId){let t=this.peerConnections.get(n);if(t){const e=t.signalingState;if("closed"!==e){console.log("[WebRTCManager] Received new offer while in state:",e,"- recreating connection for",n);try{t.close()}catch(e){}this.peerConnections.delete(n),t=null}}t||(t=this._createPeerConnection(n),this.peerConnections.set(n,t));try{await t.setRemoteDescription(new RTCSessionDescription(e.offer)),this.localStream&&this.localStream.getTracks().forEach(e=>this._addOrReplaceTrack(t,e,this.localStream));const o=await t.createAnswer();await t.setLocalDescription(o),this._sendSignal({type:"ANSWER",from:a.userId,to:n,answer:t.localDescription})}catch(e){console.error("[WebRTCManager] Error handling offer:",e),this.peerConnections.delete(n);try{t.close()}catch(e){}}return}if("ANSWER"===t&&e.answer&&n&&n!==a.userId){const t=this.peerConnections.get(n);if(t)try{"have-local-offer"===t.signalingState?await t.setRemoteDescription(new RTCSessionDescription(e.answer)):console.warn("[WebRTCManager] Received answer in unexpected state:",t.signalingState)}catch(e){console.error("[WebRTCManager] Error handling answer:",e)}return}if("ICE_CANDIDATE"===t&&e.candidate&&n&&n!==a.userId){const t=this.peerConnections.get(n);if(t)try{await t.addIceCandidate(new RTCIceCandidate(e.candidate))}catch(e){console.warn("[WebRTCManager] Error adding received ICE candidate",e)}return}if("LEAVE"===t&&n){this.peersThatLeft.add(n);const e=this.peerConnections.get(n);if(e){try{e.close()}catch(e){}this.peerConnections.delete(n)}return this._clearReconnectionState(n),void this._removeRemoteVideo(n)}}}async attemptReconnection(e){const t=this.stateManager.getState();if(!this.stateManager.isInParty())return void console.log("[WebRTCManager] Cannot reconnect - party not active");if(this.peersThatLeft.has(e))return console.log("[WebRTCManager] Not attempting reconnection to peer that has explicitly left:",e),void this._clearReconnectionState(e);const n=this.reconnectionAttempts.get(e)||0,o=Math.min(1e3*Math.pow(2,n),3e4);if(n>=5)return console.log("[WebRTCManager] Max reconnection attempts reached for",e),this.reconnectionAttempts.delete(e),void this.reconnectionTimeouts.delete(e);console.log(`[WebRTCManager] Attempting reconnection to ${e} (attempt ${n+1}/5) in ${o}ms`),this.reconnectionAttempts.set(e,n+1);const a=this.reconnectionTimeouts.get(e);a&&clearTimeout(a);const r=setTimeout(async()=>{console.log("[WebRTCManager] Reconnecting to",e);const n=this.peerConnections.get(e);if(n){try{n.close()}catch(e){console.warn("[WebRTCManager] Error closing old peer connection:",e)}this.peerConnections.delete(e)}try{const n=this._createPeerConnection(e);this.peerConnections.set(e,n),this.localStream&&this.localStream.getTracks().forEach(e=>this._addOrReplaceTrack(n,e,this.localStream));const o=await n.createOffer();await n.setLocalDescription(o),this._sendSignal({type:"OFFER",from:t.userId,to:e,offer:n.localDescription}),console.log("[WebRTCManager] Reconnection offer sent to",e)}catch(t){console.error("[WebRTCManager] Failed to create reconnection offer:",t),this.attemptReconnection(e)}},o);this.reconnectionTimeouts.set(e,r)}_clearReconnectionState(e){this.reconnectionAttempts.delete(e);const t=this.reconnectionTimeouts.get(e);t&&(clearTimeout(t),this.reconnectionTimeouts.delete(e))}_createPeerConnection(e){const t=this.stateManager.getState(),n=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return n.onicecandidate=n=>{n.candidate&&this._sendSignal({type:"ICE_CANDIDATE",from:t.userId,to:e,candidate:n.candidate})},n.ontrack=t=>{console.log("[WebRTCManager] Received remote track from",e,"track=",t.track&&t.track.kind);let n=t.streams&&t.streams[0]||this.remoteStreams.get(e);if(n||(n=new MediaStream,this.remoteStreams.set(e,n)),t.track)try{n.addTrack(t.track),t.track.onended=()=>{console.warn("[WebRTCManager] Remote track ended from",e,"kind=",t.track.kind)},console.log("[WebRTCManager] Added remote track to stream, kind=",t.track.kind,"readyState=",t.track.readyState)}catch(e){console.warn("[WebRTCManager] Failed to add remote track to stream",e)}this.remoteVideos.has(e)||this._addRemoteVideo(e,n)},n.onconnectionstatechange=()=>{console.log("[WebRTCManager] PC state",n.connectionState,"for",e),"connected"===n.connectionState?(console.log("[WebRTCManager] Connection established successfully with",e),this._clearReconnectionState(e)):"disconnected"===n.connectionState||"failed"===n.connectionState?this.peersThatLeft.has(e)?(console.warn("[WebRTCManager] Connection",n.connectionState,"with peer that has left",e,"- not reconnecting"),this.peerConnections.delete(e),this._removeRemoteVideo(e),this._clearReconnectionState(e)):(console.warn("[WebRTCManager] Connection",n.connectionState,"with",e,"- attempting reconnection"),this.peerConnections.delete(e),this._removeRemoteVideo(e),this.attemptReconnection(e)):"closed"===n.connectionState&&(console.log("[WebRTCManager] Connection closed with",e),this.peerConnections.delete(e),this._removeRemoteVideo(e),this._clearReconnectionState(e))},n}_addOrReplaceTrack(e,t,n){const o=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(o)o.replaceTrack(t).catch(e=>console.warn("[WebRTCManager] Error replacing track",e));else try{e.addTrack(t,n)}catch(e){console.warn("[WebRTCManager] Error adding track",e)}}_addRemoteVideo(e,t){this._removeRemoteVideo(e);const n=document.createElement("video");n.id="toperparty-remote-"+e,n.autoplay=!0,n.playsInline=!0,n.muted=!0,n.style.position="fixed",n.style.bottom="20px",n.style.right=20+180*this.remoteVideos.size+"px",n.style.width="240px",n.style.height="160px",n.style.zIndex=10001,n.style.border="2px solid #00aaff",n.style.borderRadius="4px";const o=t.getAudioTracks();console.log("[WebRTCManager] Remote stream audio tracks:",o.length),o.forEach(e=>{console.log("[WebRTCManager] Audio track:",e.id,"enabled=",e.enabled,"readyState=",e.readyState)});try{n.srcObject=t}catch(e){n.src=URL.createObjectURL(t)}document.body.appendChild(n),this.remoteVideos.set(e,n);try{n.play().then(()=>{console.log("[WebRTCManager] Remote video playing, unmuting audio for",e),n.muted=!1,n.volume=1}).catch(e=>{console.warn("[WebRTCManager] Remote video play() failed:",e),n.muted=!1})}catch(e){console.error("[WebRTCManager] Exception calling play():",e)}}_removeRemoteVideo(e){const t=this.remoteVideos.get(e);if(t){try{t.srcObject&&(t.srcObject=null)}catch(e){}t.remove(),this.remoteVideos.delete(e)}this.remoteStreams.delete(e)}_sendSignal(e){this.stateManager.safeSendMessage({type:"SIGNAL_SEND",message:e},function(){})}clearAll(){this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.reconnectionTimeouts.forEach(e=>{clearTimeout(e)}),this.reconnectionTimeouts.clear(),this.reconnectionAttempts.clear(),this.peersThatLeft.clear(),this.remoteVideos.forEach((e,t)=>{try{e.srcObject&&(e.srcObject=null)}catch(e){}e.remove()}),this.remoteVideos.clear(),this.remoteStreams.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}}(e,t),r=new class{constructor(e){this.stateManager=e,this.urlMonitorInterval=null,this.lastUrl=null}start(){this.lastUrl=window.location.href}stop(){this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null)}saveState(){const e=this.stateManager.getState();if(!e.partyActive)return;const t=this.getRestorationState()||{},n={roomId:e.roomId,currentTime:t.currentTime||null,isPlaying:"boolean"==typeof t.isPlaying?t.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("toperparty_restore",JSON.stringify(n))}clearState(){sessionStorage.removeItem("toperparty_restore")}getRestorationState(){const e=sessionStorage.getItem("toperparty_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[toperparty] Failed to parse restoration state:",e)}return null}}(e);let s=null;!function(){const t=r.getRestorationState();t&&(console.log("Detected party state after navigation, will restore:",t),r.clearState(),e.setRestoringFlag(!0),setTimeout(function(){console.log("Triggering party reset and restoration..."),chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:t.roomId}),setTimeout(function(){e.setRestoringFlag(!1),console.log("Party restoration complete, URL monitoring active")},2e3)},1e3))}(),n.injectAPIBridge();let i=window.location.href;chrome.runtime.onMessage.addListener((c,l,d)=>{if("SIGNAL"===c.type&&c.message)a.handleSignal(c.message).catch(e=>console.error("Signal handling error:",e));else{if("REQUEST_MEDIA_STREAM"===c.type)return navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:!0}).then(e=>{s=e,a.setLocalStream(e),console.log("Media stream obtained in content script"),e.getTracks().forEach(function(e){console.log("Local stream track obtained:",e.kind,"id=",e.id,"readyState=",e.readyState),e.onended=function(){console.error("LOCAL STREAM TRACK ENDED UNEXPECTEDLY:",e.kind,"id=",e.id)},e.onmute=function(){console.warn("Local stream track muted:",e.kind)},e.onunmute=function(){console.log("Local stream track unmuted:",e.kind)}}),function(e){let n=t.getLocalPreviewVideo();if(n){try{n.srcObject&&(n.srcObject=null)}catch(e){}n.remove(),n=null}const o=document.createElement("video");o.id="toperparty-local-preview",o.autoplay=!0,o.muted=!0,o.playsInline=!0,o.style.position="fixed",o.style.bottom="20px",o.style.left="20px",o.style.width="240px",o.style.height="160px",o.style.zIndex=10001,o.style.border="2px solid #e50914",o.style.borderRadius="4px",o.style.transform="scaleX(-1)";try{o.srcObject=e}catch(t){o.src=URL.createObjectURL(e)}document.body.appendChild(o),t.setLocalPreviewVideo(o),o.play().catch(function(e){console.warn("Local preview play() failed (this is usually fine):",e)})}(e),function(e){t.clearStreamMonitorInterval();const n=setInterval(function(){if(!e)return console.warn("Local stream is null, stopping monitor"),void t.clearStreamMonitorInterval();const n=e.getTracks();if(0===n.length)return console.warn("Local stream has no tracks"),void t.clearStreamMonitorInterval();let o=!0;n.forEach(function(e){"live"!==e.readyState&&(console.error("Local stream track not live:",e.kind,"readyState=",e.readyState),o=!1)}),o||console.warn("Some local stream tracks are not active - may need to restart stream")},5e3);t.setStreamMonitorInterval(n)}(e),a.onLocalStreamAvailable(e),d({success:!0,message:"Media stream obtained"})}).catch(e=>{console.error("Failed to get media stream:",e),d({success:!1,error:e.message})}),!0;if("PARTY_STARTED"===c.type&&(e.startParty(c.userId,c.roomId),console.log("Party started! Room:",c.roomId,"User:",c.userId),window.addEventListener("beforeunload",function(){const t=e.getState();if(e.isInParty()){r.saveState();try{e.safeSendMessage({type:"SIGNAL_SEND",message:{type:"LEAVE",userId:t.userId,roomId:t.roomId,timestamp:Date.now()}})}catch(e){console.warn("Error sending LEAVE on beforeunload:",e)}try{a.clearAll()}catch(e){console.warn("Error clearing WebRTC state on beforeunload:",e)}}}),setInterval(function(){const t=window.location.href,n=e.getState();t!==i&&n.partyActive&&!n.restoringPartyState?(console.log("URL changed from",i,"to",t),i=t,e.safeSendMessage({type:"URL_CHANGE",url:t})):n.restoringPartyState||(i=t)},500),Promise.resolve(o.setup()).then(()=>{!function(){const e=r.getRestorationState();if(!e||null==e.currentTime)return;const t=e.currentTime,o="boolean"==typeof e.isPlaying?e.isPlaying:null;r.clearState(),setTimeout(()=>{n.getCurrentTime().then(e=>{const o=null!=e?e/1e3:0;if(Math.abs(o-t)>2)return console.log("[ContentScript] Restoring playback position after navigation from",o,"to",t),n.seek(1e3*t)}).then(()=>{if(null!==o)return n.isPaused().then(e=>o&&e?(console.log("[ContentScript] Resuming playback after navigation"),n.play()):o||e?void 0:(console.log("[ContentScript] Pausing playback after navigation"),n.pause()))}).catch(e=>{console.warn("[ContentScript] Failed to restore playback state after navigation:",e)})},1e3)}()}).catch(e=>{console.error("[ContentScript] Error setting up sync manager:",e)}),d({success:!0})),"PARTY_STOPPED"===c.type&&(e.stopParty(),i=window.location.href,r.stop(),o.teardown(),t.clearStreamMonitorInterval(),s&&(s.getTracks().forEach(e=>e.stop()),s=null,a.setLocalStream(null)),function(){const e=t.getLocalPreviewVideo();if(e){try{e.srcObject&&(e.srcObject.getTracks().forEach(function(e){e.stop()}),e.srcObject=null)}catch(e){console.warn("Error stopping local preview tracks:",e)}e.remove(),t.setLocalPreviewVideo(null)}}(),function(){const e=document.getElementById("netflix-party-controls");e&&e.remove()}(),a.clearAll(),console.log("Party stopped"),d({success:!0})),"APPLY_PLAYBACK_CONTROL"===c.type&&(o.handlePlaybackControl(c.control,c.fromUserId),d({success:!0})),"APPLY_SYNC_PLAYBACK"===c.type&&(o.handlePassiveSync(c.currentTime,c.isPlaying,c.fromUserId,c.timestamp),d({success:!0})),"APPLY_SEEK"===c.type&&(o.handleSeek(c.currentTime,c.isPlaying,c.fromUserId),d({success:!0})),"APPLY_URL_CHANGE"===c.type){console.log("Applying URL change from remote user:",c.url,"from user:",c.fromUserId);const t=e.getState();t.partyActive&&t.userId&&t.roomId&&n.getCurrentTime().then(e=>{const t=null!=e?e/1e3:null;return n.isPaused().then(e=>({currentTime:t,isPlaying:!e}))}).then(e=>{const n=r.getRestorationState()||{},o={roomId:t.roomId,currentTime:null!=e.currentTime?e.currentTime:n.currentTime||null,isPlaying:"boolean"==typeof e.isPlaying?e.isPlaying:"boolean"==typeof n.isPlaying?n.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("toperparty_restore",JSON.stringify(o)),console.log("Saved party + playback state before navigation",o)}).catch(e=>{console.warn("Failed to capture playback state before navigation, falling back to basic party state:",e),r.saveState()}),window.location.href=c.url,d({success:!0})}"HANDLE_REQUEST_SYNC"===c.type&&(o.handleRequestSync(c.fromUserId),d({success:!0})),"APPLY_SYNC_RESPONSE"===c.type&&(o.handleSyncResponse(c.currentTime,c.isPlaying,c.fromUserId),d({success:!0}))}})})();
//# sourceMappingURL=content-script.js.map