(()=>{"use strict";class e{constructor(){this.suppressLocalUntil=0}set(e){this.suppressLocalUntil=Date.now()+e}isActive(){return Date.now()<this.suppressLocalUntil}}class t{constructor(e){this.value=e}get(){return this.value}set(e){this.value=e}}function n(e,t,n){const o=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(o)o.replaceTrack(t).catch(e=>console.warn("[WebRTCManager] Error replacing track",e));else try{e.addTrack(t,n)}catch(e){}}console.log("[Content Script] Initializing managers...");const o="true"===sessionStorage.getItem("tandem_was_active");if(o)console.log("[Content Script] Party is active, keeping existing video elements");else{console.log("[Content Script] No active party detected, cleaning up stale elements...");const e=document.querySelectorAll('[id^="tandem-container-"]'),t=document.querySelectorAll('[id^="tandem-remote-"]'),n=document.querySelectorAll('[id^="tandem-overlay-"]'),o=document.getElementById("tandem-local-preview"),a=document.getElementById("tandem-waiting-indicator");e.forEach(e=>{console.log("[Content Script] Removing stale container:",e.id),e.remove()}),t.forEach(e=>{console.log("[Content Script] Removing stale video:",e.id),e.remove()}),n.forEach(e=>{console.log("[Content Script] Removing stale overlay:",e.id),e.remove()}),o&&(console.log("[Content Script] Removing stale local video"),o.remove()),a&&(console.log("[Content Script] Removing stale waiting indicator"),a.remove())}const a=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t,sessionStorage.setItem("tandem_was_active","true")}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null,sessionStorage.removeItem("tandem_was_active")}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}isInParty(){return!!(this.partyActive&&this.userId&&this.roomId)}setRestoringFlag(e){this.restoringPartyState=e}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch{return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid()){console.log("[StateManager] Sending message:",e.type,e);try{chrome.runtime.sendMessage(e,n=>{chrome.runtime.lastError?console.error("[StateManager] Error sending message:",e.type,chrome.runtime.lastError.message):console.log("[StateManager] Message sent successfully:",e.type,n),t&&t(n)})}catch(t){console.error("[StateManager] Exception sending message:",e.type,t.message,t)}}else if(console.warn("[StateManager] Extension context invalid - page needs reload after extension update"),!document.getElementById("tandem-reload-notice")){const e=document.createElement("div");e.id="tandem-reload-notice",e.style.cssText="position:fixed;top:20px;right:20px;background:#e50914;color:white;padding:15px;border-radius:8px;z-index:99999;font-family:Arial;box-shadow:0 4px 6px rgba(0,0,0,0.3);",e.innerHTML="<strong>tandem.watch:</strong> Extension updated. Please reload this page.",document.body.appendChild(e)}}},i=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}makeDraggable(e){let t,n,o,a,i=!1;e.addEventListener("mousedown",function(t){const n=window.getComputedStyle(e),s=(n.bottom,n.left,n.right,e.getBoundingClientRect());e.style.left=s.left+"px",e.style.top=s.top+"px",e.style.bottom="auto",e.style.right="auto",o=t.clientX-s.left,a=t.clientY-s.top,i=!0,e.style.opacity="0.8"}),e.addEventListener("mouseup",function(s){o=t,a=n,i=!1,e.style.opacity="1"}),e.addEventListener("mousemove",function(s){if(i){s.preventDefault(),t=s.clientX-o,n=s.clientY-a;const i=window.innerWidth-e.offsetWidth,d=window.innerHeight-e.offsetHeight;t=Math.max(0,Math.min(t,i)),n=Math.max(0,Math.min(n,d)),r=t,l=n,(c=e).style.left=r+"px",c.style.top=l+"px"}var r,l,c}),e.style.cursor="move"}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}attachLocalPreview(e){console.log("[UIManager] Attaching local preview with stream:",e),this.removeLocalPreview();const t=document.createElement("video");t.id="tandem-local-preview",t.autoplay=!0,t.muted=!0,t.playsInline=!0,t.style.position="fixed",t.style.bottom="145px",t.style.left="20px",t.style.width="240px",t.style.height="160px",t.style.zIndex="999999",t.style.border="2px solid #e50914",t.style.borderRadius="4px",t.style.transform="scaleX(-1)";try{t.srcObject=e,console.log("[UIManager] Set srcObject on local preview")}catch(n){console.warn("[UIManager] srcObject failed, trying createObjectURL:",n),t.src=URL.createObjectURL(e)}document.body.appendChild(t),this.localPreviewVideo=t,console.log("[UIManager] Local preview video appended to body"),this.makeDraggable(t),t.play().catch(e=>{console.warn("[UIManager] Local preview play() failed:",e)})}removeLocalPreview(){if(this.localPreviewVideo){console.log("[UIManager] Removing local preview video");try{this.localPreviewVideo.srcObject&&(this.localPreviewVideo.srcObject=null)}catch(e){console.warn("[UIManager] Error clearing srcObject:",e)}this.localPreviewVideo.remove(),this.localPreviewVideo=null}}clearAll(){this.removeLocalPreview(),this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval(),this.removeConnectionIndicator()}showConnectionIndicator(){this.removeConnectionIndicator();const e=document.createElement("div");e.id="tandem-connection-indicator",e.style.cssText="\n      position: fixed;\n      top: 10px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 0, 0, 0.85);\n      color: white;\n      padding: 8px 16px;\n      border-radius: 20px;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 13px;\n      font-weight: 500;\n      z-index: 999999;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n      backdrop-filter: blur(10px);\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      transition: all 0.3s ease;\n      cursor: pointer;\n    ",e.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"OPEN_POPUP"})});const t=document.createElement("div");t.id="tandem-connection-dot",t.style.cssText="\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      background: #4ade80;\n      animation: pulse 2s ease-in-out infinite;\n    ";const n=document.createElement("span");n.id="tandem-connection-text",n.textContent="Connected",e.appendChild(t),e.appendChild(n),document.body.appendChild(e);const o=document.createElement("style");return o.id="tandem-connection-style",o.textContent="\n      @keyframes pulse {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.5; }\n      }\n      @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n    ",document.head.appendChild(o),e}updateConnectionIndicator(e){const t=document.getElementById("tandem-connection-dot"),n=document.getElementById("tandem-connection-text");t&&n&&("connected"===e?(t.style.background="#4ade80",t.style.animation="pulse 2s ease-in-out infinite",n.textContent="Connected"):"waiting"===e?(t.style.background="#a78bfa",t.style.animation="spin 1s linear infinite",n.textContent="Waiting for others..."):"reconnecting"===e?(t.style.background="#f59e0b",t.style.animation="spin 1s linear infinite",n.textContent="Reconnecting..."):"disconnected"===e&&(t.style.background="#ef4444",t.style.animation="pulse 1s ease-in-out infinite",n.textContent="Disconnected"))}removeConnectionIndicator(){const e=document.getElementById("tandem-connection-indicator");e&&e.remove()}},s=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){e.remove()}}_sendCommand(e,t=[]){return new Promise(function(n){const o=function(t){t.detail.command===e&&(document.removeEventListener("__tandem_response",o),n(t.detail.result))};document.addEventListener("__tandem_response",o),setTimeout(function(){n(null)},1e3),document.dispatchEvent(new CustomEvent("__tandem_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}getDuration(){return this._sendCommand("getDuration")}getPlayerState(){return this._sendCommand("getPlayerState")}isPaused(){return this._sendCommand("isPaused")}setVolume(e){return this._sendCommand("setVolume",[e])}getVolume(){return this._sendCommand("getVolume")}getVideoElement(){if(!window.location.pathname.startsWith("/watch"))return null;const e=document.querySelectorAll("video");for(const t of e)if(!t.id||!t.id.startsWith("tandem-"))return t;return null}},r=new class{constructor(n,o){this.state=n,this.netflix=o,this.lock=new e,this.isInitializedRef=new t(!1),this.listeners=null,this.initialSyncRequestAt=0,this.initialSyncWindowMs=8e3,this.lastKnownTimeSeconds=0,this.videoMonitorInterval=null,this.activeVideo=null,this.urlSync=null,this.hostUserId=null,this.heartbeatInterval=null,this.remote=function({state:e,netflix:t,lock:n,isInitializedRef:o,urlSync:a,shouldAcceptLateSync:i,onInitialSyncApplied:s}){async function r(e,t,o){n.set(t);try{await o()}catch(t){console.error(`[SyncManager] Error applying remote ${e}:`,t)}}function l(e,t,n){return Number.isFinite(e)&&n&&Number.isFinite(n)&&t?e+Math.max(0,Date.now()-n)/1e3:e}return{async handleRequestSync(n,a=!1){const i=window.location.href;if(!window.location.pathname.startsWith("/watch"))return void console.log("[SyncManager] On browse page, not sending sync response");const s=async o=>{try{const r=await t.getCurrentTime(),l=await t.isPaused();if(null==r)return void(o<6?(console.log("[SyncManager] Playback state not ready, retrying sync response (attempt",o+1,")"),setTimeout(()=>s(o+1),500)):console.log("[SyncManager] Playback state still not ready, giving up on sync response"));const c=r/1e3;console.log("[SyncManager] Sending SYNC_RESPONSE to",n,"at",c.toFixed(2)+"s",l?"paused":"playing","URL:",i,a?"(will respect auto-play)":""),e.safeSendMessage({type:"SYNC_RESPONSE",targetUserId:n,currentTime:c,isPlaying:!l,url:i,respectAutoPlay:a})}catch(e){console.error("[SyncManager] Error handling sync request:",e)}};o.get()||console.log("[SyncManager] Not yet initialized, will still attempt to respond to sync request"),s(1)},async handleSyncResponse(n,l,c,d,g=!1){const m=a?.();if(m&&m.shouldSuppressSyncResponse(d))return;if(o.get()&&!i?.())return void console.log("[SyncManager] Already initialized, ignoring late SYNC_RESPONSE");if(o.get()&&i?.()&&console.log("[SyncManager] Accepting late SYNC_RESPONSE within initial window"),null==n||"number"!=typeof n||n<0)return void console.warn("[SyncManager] Invalid SYNC_RESPONSE - bad currentTime:",n);g?console.log("[SyncManager] Initial sync from",c,"seeking to",n.toFixed(2)+"s (respecting auto-play)"):console.log("[SyncManager] Initial sync from",c,"seeking to",n.toFixed(2)+"s",l?"playing":"paused","URL:",d);const h=window.location.href,p=window.location.pathname,u=p.startsWith("/watch"),y=p.startsWith("/browse"),f=d&&new URL(d).pathname.startsWith("/watch");if(!u&&f&&y)return console.log("[SyncManager] On browse page during initial join, other user on /watch - navigating to their show"),sessionStorage.setItem("tandem_pending_sync",JSON.stringify({currentTime:n,isPlaying:l,timestamp:Date.now()})),void(window.location.href=d);if(!u)return console.log("[SyncManager] Not on /watch page - ignoring sync response"),o.set(!0),void(s&&s());if(d&&d!==h)return console.log("[SyncManager] URL mismatch - navigating from",h,"to",d),sessionStorage.setItem("tandem_pending_sync",JSON.stringify({currentTime:n,isPlaying:l,timestamp:Date.now()})),void(window.location.href=d);if(n<=2)try{console.log("[SyncManager] Received near-zero sync (",n.toFixed(2)+"s), checking for local resume position from",c);const a=async()=>{for(let e=0;e<8;e++){const n=await t.getCurrentTime();if(console.log("[SyncManager] Resume check attempt",e+1,"- local time:",null!=n?(n/1e3).toFixed(2)+"s":"null"),null!=n&&n>5e3)return n;await new Promise(e=>setTimeout(e,500))}return null},i=await a();if(null!=i&&i>5e3){const n=await t.isPaused(),a=i/1e3;return console.log("[SyncManager] Using local resume position instead of near-zero sync:",a.toFixed(2)+"s",n?"paused":"playing"),o.set(!0),s&&s(),void e.safeSendMessage({type:"POSITION_UPDATE",currentTime:a,isPlaying:!n})}console.log("[SyncManager] No local resume position found after waiting, applying sync at",n.toFixed(2)+"s")}catch(e){console.warn("[SyncManager] Error checking local resume position:",e)}o.set(!0),s&&s(),await r("initial-sync",1500,async()=>{if(await t.seek(1e3*n),g){console.log("[SyncManager] Synced timestamp only, respecting Netflix auto-play");const o=await t.isPaused();return void e.safeSendMessage({type:"POSITION_UPDATE",currentTime:n,isPlaying:!o})}const o=await t.isPaused();l&&o?(console.log("[SyncManager] Remote is playing, starting playback"),await t.play()):l||o||(console.log("[SyncManager] Remote is paused, pausing playback"),await t.pause()),e.safeSendMessage({type:"POSITION_UPDATE",currentTime:n,isPlaying:l})})},async handlePlaybackControl(e,n,o,a){console.log("[SyncManager] Remote",e.toUpperCase(),"from",o);const i=l(n,"play"===e,a);await r(e,1e3,async()=>{if("play"===e){if(Number.isFinite(i)){const e=await t.getCurrentTime(),n=Number.isFinite(e)?e/1e3:null;null!=n&&Math.abs(n-i)>.75&&(console.log("[SyncManager] Latency compensation: nudging to",i.toFixed(2)+"s before play"),await t.seek(1e3*i))}await t.play()}else await t.pause()})},async handleSeek(e,n,o,a){const i=l(e,n,a);console.log("[SyncManager] Remote SEEK to",i.toFixed(2)+"s",n?"playing":"paused","from",o),await r("seek",1200,async()=>{await t.seek(1e3*i);const e=await t.isPaused();n&&e?await t.play():n||e||await t.pause()})},async handleSeekPause(n,o){console.log("[SyncManager] Remote SEEK_PAUSE to",n.toFixed(2)+"s from",o),await r("seek-pause",1500,async()=>{await t.seek(1e3*n),await t.pause(),await new Promise(e=>{const n=t.getVideoElement();if(!n)return void setTimeout(e,400);if(n.readyState>=3)return void e();let o=!1;const a=()=>{o||(o=!0,n.removeEventListener("canplaythrough",a),n.removeEventListener("canplay",a),e())};n.addEventListener("canplaythrough",a,{once:!0}),n.addEventListener("canplay",a,{once:!0}),setTimeout(a,4e3)}),e.safeSendMessage({type:"READY",targetTime:n})})},async handleHostHeartbeat(e,n,o,a){if(!Number.isFinite(e))return;const i=l(e,n,a),s=await t.getCurrentTime(),c=Number.isFinite(s)?s/1e3:null;if(null==c)return;const d=i-c;Math.abs(d)<.5||await r("heartbeat-catchup",600,async()=>{console.log("[SyncManager] Host heartbeat correction:",d.toFixed(2)+"s"),await t.seek(1e3*i);const e=await t.isPaused();n&&e?await t.play():n||e||await t.pause()})}}}({state:this.state,netflix:this.netflix,lock:this.lock,isInitializedRef:this.isInitializedRef,urlSync:()=>this.urlSync,shouldAcceptLateSync:()=>!!this.initialSyncRequestAt&&Date.now()-this.initialSyncRequestAt<this.initialSyncWindowMs,onInitialSyncApplied:()=>{this.initialSyncRequestAt=0}})}setUrlSync(e){this.urlSync=e}async setup(){try{if(!window.location.pathname.startsWith("/watch"))return void console.log("[SyncManager] Not on /watch page, skipping setup");console.log("[SyncManager] Starting setup - waiting for video element...");const e=await this.waitForVideo();if(!e)return void console.warn("[SyncManager] Netflix video element not found");console.log("[SyncManager] Video element found, setting up event listeners"),this.activeVideo=e;const t=sessionStorage.getItem("tandem_pending_sync");if(t)try{const n=JSON.parse(t);if(Date.now()-n.timestamp<1e4){console.log("[SyncManager] Applying pending sync from URL navigation"),sessionStorage.removeItem("tandem_pending_sync"),this.isInitializedRef.set(!0),this.initialSyncRequestAt=0,this.lock.set(1500),await this.netflix.seek(1e3*n.currentTime);const t=await this.netflix.isPaused();return n.isPlaying&&t?await this.netflix.play():n.isPlaying||t||await this.netflix.pause(),this.attachListeners(e),this.startVideoMonitor(),void console.log("[SyncManager] Setup complete with pending sync applied")}console.log("[SyncManager] Pending sync expired, ignoring"),sessionStorage.removeItem("tandem_pending_sync")}catch(e){console.error("[SyncManager] Error applying pending sync:",e),sessionStorage.removeItem("tandem_pending_sync")}if(this.isInitializedRef.set(!1),"true"===sessionStorage.getItem("tandem_from_browse")){console.log("[SyncManager] Just navigated from browse - becoming leader, will broadcast state once video is ready"),sessionStorage.removeItem("tandem_from_browse"),this.isInitializedRef.set(!0),this.initialSyncRequestAt=0;const t=()=>{let t=!1,n=null;const o=async o=>{if(!t){t=!0,e.removeEventListener("seeked",a),e.removeEventListener("timeupdate",i),n&&clearTimeout(n);try{const e=await this.netflix.getCurrentTime(),t=await this.netflix.isPaused(),n=null!=e?e/1e3:0;console.log("[SyncManager] Broadcasting initial state as leader from",o+":",n.toFixed(2)+"s",t?"paused":"playing"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:t?"pause":"play"})}catch(e){console.error("[SyncManager] Error broadcasting leader state:",e)}}},a=async()=>{const e=await this.netflix.getCurrentTime();null!=e&&e>5e3&&(console.log("[SyncManager] Detected resume via seeked event at",(e/1e3).toFixed(2)+"s"),o("seeked"))},i=async()=>{const e=await this.netflix.getCurrentTime();null!=e&&e>5e3&&(console.log("[SyncManager] Detected resume via timeupdate at",(e/1e3).toFixed(2)+"s"),o("timeupdate"))};e.addEventListener("seeked",a),e.addEventListener("timeupdate",i),n=setTimeout(()=>{console.log("[SyncManager] Resume timeout reached, broadcasting current state"),o("timeout")},8e3),this.netflix.getCurrentTime().then(e=>{null!=e&&e>5e3&&(console.log("[SyncManager] Already at resume position:",(e/1e3).toFixed(2)+"s"),o("immediate"))})};if(e.readyState>=3)console.log("[SyncManager] Video ready, waiting for Netflix resume event"),t();else{console.log("[SyncManager] Waiting for video ready before resume detection");const n=()=>{e.removeEventListener("canplay",n),console.log("[SyncManager] Video ready, waiting for Netflix resume event"),t()};e.addEventListener("canplay",n),setTimeout(()=>{e.removeEventListener("canplay",n),console.log("[SyncManager] Video ready timeout, starting resume detection anyway"),t()},3e3)}}else{const t=()=>{console.log("[SyncManager] Video ready - requesting initial sync from other clients"),this.initialSyncRequestAt=Date.now(),this.state.safeSendMessage({type:"REQUEST_SYNC"}),setTimeout(()=>{this.isInitializedRef.get()?console.log("[SyncManager] Already initialized, skipping timeout initialization"):(console.log("[SyncManager] No sync response received after 2s, marking as initialized (will still accept late sync briefly)"),this.isInitializedRef.set(!0),console.log("[SyncManager] isInitialized is now:",this.isInitializedRef.get()))},2e3)},n=()=>{console.log("[SyncManager] Video canplay event fired"),e.removeEventListener("canplay",n),t()};e.readyState>=3?(console.log("[SyncManager] Video already ready (readyState:",e.readyState+")"),t()):(console.log("[SyncManager] Waiting for video to be ready before requesting sync (readyState:",e.readyState+")"),e.addEventListener("canplay",n),setTimeout(()=>{e.removeEventListener("canplay",n),console.log("[SyncManager] Timeout reached, requesting sync anyway"),t()},5e3))}this.attachListeners(e),this.startVideoMonitor(),console.log("[SyncManager] Setup complete - ready to sync")}catch(e){console.error("[SyncManager] Error setting up playback sync:",e)}}attachListeners(e){if(this.listeners&&this.listeners.cleanup)try{const{handlePlay:e,handlePause:t,handleSeeked:n}=this.listeners;this.listeners.video&&(this.listeners.video.removeEventListener("play",e),this.listeners.video.removeEventListener("pause",t),this.listeners.video.removeEventListener("seeked",n)),this.listeners.cleanup(),console.log("[SyncManager] Cleaned up old listeners before attaching new ones")}catch(e){console.warn("[SyncManager] Error cleaning up old listeners:",e)}const t=function({video:e,state:t,isInitializedRef:n,lock:o,onPlay:a,onPause:i,onSeek:s,onPositionUpdate:r}){const l=()=>{console.log("[EventListeners] Play event fired - checking conditions:",{isActive:t.isActive(),isInitialized:n.get(),lockActive:o.isActive()}),t.isActive()?n.get()?o.isActive()?console.log("[EventListeners] Ignoring play - lock active"):(console.log("[EventListeners] Play event detected - broadcasting"),a(e)):console.log("[EventListeners] Ignoring play - not initialized"):console.log("[EventListeners] Ignoring play - party not active")},c=()=>{console.log("[EventListeners] Pause event fired - checking conditions:",{isActive:t.isActive(),isInitialized:n.get(),lockActive:o.isActive()}),t.isActive()?n.get()?o.isActive()?console.log("[EventListeners] Ignoring pause - lock active"):(console.log("[EventListeners] Pause event detected - broadcasting"),i(e)):console.log("[EventListeners] Ignoring pause - not initialized"):console.log("[EventListeners] Ignoring pause - party not active")},d=()=>{console.log("[EventListeners] Seek event fired - checking conditions:",{isActive:t.isActive(),isInitialized:n.get(),lockActive:o.isActive()}),t.isActive()?n.get()?o.isActive()?console.log("[EventListeners] Ignoring seek - lock active"):(console.log("[EventListeners] Seek event detected - broadcasting"),s(e)):console.log("[EventListeners] Ignoring seek - not initialized"):console.log("[EventListeners] Ignoring seek - party not active")},g=setInterval(()=>{window.location.pathname.startsWith("/watch")&&t.isActive()&&n.get()&&!o.isActive()&&r&&r(e)},500);return e.addEventListener("play",l),e.addEventListener("pause",c),e.addEventListener("seeked",d),console.log("[EventListeners] Event listeners attached to video element"),{video:e,handlePlay:l,handlePause:c,handleSeeked:d,cleanup:()=>clearInterval(g)}}({video:e,state:this.state,isInitializedRef:this.isInitializedRef,lock:this.lock,onPlay:e=>this.broadcastPlay(e),onPause:e=>this.broadcastPause(e),onSeek:e=>this.broadcastSeek(e),onPositionUpdate:e=>this.broadcastPosition(e)});this.listeners=t}startVideoMonitor(){this.videoMonitorInterval||(this.videoMonitorInterval=setInterval(()=>{if(!this.isOnWatchPage())return;const e=this.netflix.getVideoElement();e&&e!==this.activeVideo&&(console.log("[SyncManager] Detected new Netflix video element, reattaching listeners"),this.activeVideo=e,this.attachListeners(e))},1e3))}teardown(){if(console.log("[SyncManager] Tearing down sync manager"),this.listeners){const{video:e,handlePlay:t,handlePause:n,handleSeeked:o,cleanup:a}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",n),e.removeEventListener("seeked",o),a&&a(),console.log("[SyncManager] Event listeners removed")}catch(e){console.warn("[SyncManager] Error removing listeners:",e)}this.listeners=null}this.videoMonitorInterval&&(clearInterval(this.videoMonitorInterval),this.videoMonitorInterval=null),this.activeVideo=null,this.isInitializedRef.set(!1),this.stopHostHeartbeat()}waitForVideo(){return new Promise((e,t)=>{const n=setTimeout(()=>t(new Error("Video element timeout")),1e4),o=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(n),e(t)):setTimeout(o,100)};o()})}isOnWatchPage(){return window.location.pathname.startsWith("/watch")}broadcastPlay(e){this.isOnWatchPage()?(console.log("[SyncManager] Broadcasting PLAY event"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:"play",currentTime:e?.currentTime||0,eventTimestamp:Date.now()})):console.log("[SyncManager] Ignoring PLAY event - not on /watch page")}broadcastPause(e){this.isOnWatchPage()?(console.log("[SyncManager] Broadcasting PAUSE event"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:"pause",currentTime:e?.currentTime||0,eventTimestamp:Date.now()})):console.log("[SyncManager] Ignoring PAUSE event - not on /watch page")}broadcastSeek(e){this.isOnWatchPage()?(console.log("[SyncManager] Broadcasting SEEK event at",e.currentTime),this.state.safeSendMessage({type:"SEEK",currentTime:e.currentTime,isPlaying:!e.paused,eventTimestamp:Date.now()})):console.log("[SyncManager] Ignoring SEEK event - not on /watch page")}broadcastPosition(e){this.isOnWatchPage()&&this.netflix.getCurrentTime().then(t=>{let n=null;null!=t&&(n=t/1e3),(null==n||0===n)&&e?.currentTime>0&&(n=e.currentTime),null==n||0===n?n=this.lastKnownTimeSeconds||0:this.lastKnownTimeSeconds=n,0!==n&&this.state.safeSendMessage({type:"POSITION_UPDATE",currentTime:n,isPlaying:!e.paused})}).catch(e=>{console.warn("[SyncManager] Failed to read currentTime for POSITION_UPDATE:",e)})}handleRequestSync(e,t){return this.remote.handleRequestSync(e,t)}handleSyncResponse(e,t,n,o,a){if(this.isOnWatchPage())return this.remote.handleSyncResponse(e,t,n,o,a);console.log("[SyncManager] Ignoring sync response - not on /watch page")}handlePlaybackControl(e,t,n,o){return this.remote.handlePlaybackControl(e,t,n,o)}handleSeek(e,t,n,o){return this.remote.handleSeek(e,t,n,o)}handleSeekPause(e,t){return this.remote.handleSeekPause(e,t)}handleHostHeartbeat(e,t,n,o){return this.remote.handleHostHeartbeat(e,t,n,o)}setHostUserId(e){this.hostUserId=e,this.updateHostHeartbeat()}updateHostHeartbeat(){const e=this.state.getUserId();this.hostUserId&&e&&this.hostUserId===e?this.startHostHeartbeat():this.stopHostHeartbeat()}startHostHeartbeat(){this.heartbeatInterval||(this.heartbeatInterval=setInterval(async()=>{if(!this.isOnWatchPage()||!this.isInitializedRef.get())return;const e=await this.netflix.getCurrentTime();let t=Number.isFinite(e)?e/1e3:null;if(null==t){const e=this.netflix.getVideoElement();t=e?.currentTime||0}const n=this.netflix.getVideoElement(),o=!n||!n.paused;this.state.safeSendMessage({type:"HOST_HEARTBEAT",currentTime:t,isPlaying:o,eventTimestamp:Date.now()})},3e3))}stopHostHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}}(a,s),l=new class{constructor(e,t){this.stateManager=e,this.uiManager=t,this.peerConnections=new Map,this.remoteStreams=this.uiManager.getRemoteStreams(),this.remoteVideos=this.uiManager.getRemoteVideos(),this.peersThatLeft=new Set,this.localStream=null;const o=function(e){function t(){if(document.getElementById("tandem-spinner-styles"))return;const e=document.createElement("style");e.id="tandem-spinner-styles",e.textContent="\n      @keyframes tandem-spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n      @keyframes tandem-pulse {\n        0%, 100% { opacity: 0.3; }\n        50% { opacity: 1; }\n      }\n      @keyframes tandem-dot {\n        0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }\n        40% { transform: scale(1); opacity: 1; }\n      }\n      .tandem-dots {\n        display: inline-flex;\n        gap: 4px;\n        align-items: center;\n        justify-content: center;\n      }\n      .tandem-dot {\n        width: 6px;\n        height: 6px;\n        border-radius: 50%;\n        background: #38bdf8;\n        animation: tandem-dot 1.2s infinite ease-in-out;\n      }\n      .tandem-dot:nth-child(2) { animation-delay: 0.2s; }\n      .tandem-dot:nth-child(3) { animation-delay: 0.4s; }\n    ",document.head.appendChild(e)}function n(){t();const e=document.createElement("div");return e.className="tandem-spinner",e.style.cssText="\n      width: 40px;\n      height: 40px;\n      border: 4px solid rgba(255, 255, 255, 0.3);\n      border-top: 4px solid #00aaff;\n      border-radius: 50%;\n      animation: tandem-spin 1s linear infinite;\n      margin-bottom: 12px;\n    ",e}function o(e){let t,n,o,a,i=!1;e.addEventListener("mousedown",function(t){window.getComputedStyle(e);const n=e.getBoundingClientRect();e.style.left=n.left+"px",e.style.top=n.top+"px",e.style.bottom="auto",e.style.right="auto",o=t.clientX-n.left,a=t.clientY-n.top,i=!0,e.style.opacity="0.8"}),e.addEventListener("mouseup",function(s){o=t,a=n,i=!1,e.style.opacity="1"}),e.addEventListener("mousemove",function(s){if(i){s.preventDefault(),t=s.clientX-o,n=s.clientY-a;const i=window.innerWidth-e.offsetWidth,r=window.innerHeight-e.offsetHeight;t=Math.max(0,Math.min(t,i)),n=Math.max(0,Math.min(n,r)),e.style.left=t+"px",e.style.top=n+"px"}}),e.style.cursor="move"}function a(t){console.log("[RemoteVideoManager] Removing remote video for peer:",t);const n=e.get(t);if(n){try{n.srcObject&&(n.srcObject.getTracks().forEach(e=>e.stop()),n.srcObject=null)}catch(e){console.warn("[RemoteVideoManager] Error cleaning up stream:",e)}const o=n.parentElement;o&&o.id==="tandem-container-"+t?o.remove():n.remove(),e.delete(t)}const o=document.getElementById("tandem-container-"+t);o&&(console.log("[RemoteVideoManager] Found orphaned container, removing"),o.remove());const a=document.getElementById("tandem-remote-"+t);if(a&&a!==n){console.log("[RemoteVideoManager] Found orphaned video element, removing");try{a.srcObject&&(a.srcObject=null)}catch(e){}a.remove()}const i=document.getElementById("tandem-overlay-"+t);i&&i.remove()}function i(){const e=document.getElementById("tandem-waiting-indicator");e&&(console.log("[RemoteVideoManager] Hiding waiting indicator"),e.remove())}return{add:function(i,s){console.log("[RemoteVideoManager] Adding remote video for peer:",i,"stream:",s,"tracks:",s.getTracks()),console.log("[RemoteVideoManager] Current remoteVideos map size:",e.size,"peers:",Array.from(e.keys()));const r=document.getElementById("tandem-remote-"+i);if(r){if(console.log("[RemoteVideoManager] Video already exists in DOM for peer:",i,"skipping duplicate creation"),r.srcObject!==s){console.log("[RemoteVideoManager] Updating stream on existing video element"),r.srcObject=s;const e=document.getElementById("tandem-overlay-"+i);e&&e.remove()}return void(e.has(i)||e.set(i,r))}let l=document.getElementById("tandem-container-"+i);l?console.log("[RemoteVideoManager] Using existing placeholder container for peer:",i):(a(i),l=document.createElement("div"),l.id="tandem-container-"+i,l.style.position="fixed",l.style.bottom="145px",l.style.right=20+180*e.size+"px",l.style.width="240px",l.style.height="160px",l.style.zIndex=999999,l.style.border="2px solid #00aaff",l.style.borderRadius="4px",l.style.backgroundColor="#000");const c=document.createElement("video");c.id="tandem-remote-"+i,c.autoplay=!0,c.playsInline=!0,c.muted=!0,c.style.width="100%",c.style.height="100%",c.style.border="2px solid #00aaff",c.style.borderRadius="4px",c.style.backgroundColor="#000";let d=document.getElementById("tandem-overlay-"+i);if(!d){d=document.createElement("div"),d.id="tandem-overlay-"+i,d.style.position="absolute",d.style.top="0",d.style.left="0",d.style.width="100%",d.style.height="100%",d.style.backgroundColor="rgba(0, 0, 0, 0.85)",d.style.display="flex",d.style.flexDirection="column",d.style.alignItems="center",d.style.justifyContent="center",d.style.color="#fff",d.style.fontSize="14px",d.style.fontFamily="Arial, sans-serif",d.style.borderRadius="4px",d.style.pointerEvents="none";const e=n(),t=document.createElement("div");t.textContent="Connecting...",t.style.fontWeight="500",d.appendChild(e),d.appendChild(t)}t(),l.appendChild(c),d.parentElement||l.appendChild(d),l.parentElement||(document.body.appendChild(l),o(l)),console.log("[RemoteVideoManager] Added video to container:",l.id);const g=s.getTracks().filter(e=>"live"===e.readyState);console.log("[RemoteVideoManager] Stream has",g.length,"active tracks:",g.map(e=>`${e.kind}:${e.id.substring(0,8)}`).join(", "));try{c.srcObject=s,console.log("[RemoteVideoManager] Set srcObject successfully")}catch(e){console.warn("[RemoteVideoManager] srcObject failed:",e)}e.set(i,c);const m=()=>{c.play().then(()=>{console.log("[RemoteVideoManager] Video playing, unmuting and removing overlay"),c.muted=!1,c.volume=1,d.remove()}).catch(e=>{console.warn("[RemoteVideoManager] Play failed:",e.name,e.message),c.muted=!1,d.remove()})};if(g.length>0)m();else{console.log("[RemoteVideoManager] Waiting for stream tracks to become active"),d.innerHTML='<div style="text-align: center;"><div style="margin-bottom: 8px;">●</div><div>Waiting for stream...</div></div>';const e=setInterval(()=>{s.getTracks().filter(e=>"live"===e.readyState).length>0&&(clearInterval(e),console.log("[RemoteVideoManager] Tracks now active, playing video"),m())},100);setTimeout(()=>{clearInterval(e),d.parentNode&&(console.log("[RemoteVideoManager] Timeout waiting for tracks, removing overlay"),d.remove())},5e3)}},remove:a,showReconnecting:function(e){console.log("[RemoteVideoManager] Showing reconnecting overlay for peer:",e);let t=document.getElementById("tandem-overlay-"+e);if(t){t.innerHTML="";const e=n(),o=document.createElement("div");return o.textContent="Reconnecting...",o.style.fontWeight="500",t.appendChild(e),t.appendChild(o),void(t.style.display="flex")}const o=document.getElementById("tandem-container-"+e);if(!o)return void console.warn("[RemoteVideoManager] Cannot show reconnecting - container not found");t=document.createElement("div"),t.id="tandem-overlay-"+e,t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.85)",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.color="#fff",t.style.fontSize="14px",t.style.fontFamily="Arial, sans-serif",t.style.borderRadius="4px",t.style.pointerEvents="none";const a=n(),i=document.createElement("div");i.textContent="Reconnecting...",i.style.fontWeight="500",t.appendChild(a),t.appendChild(i),o.appendChild(t)},hideOverlay:function(e){const t=document.getElementById("tandem-overlay-"+e);t&&(console.log("[RemoteVideoManager] Hiding overlay for peer:",e),t.remove())},showPlaceholder:function(t){console.log("[RemoteVideoManager] Showing placeholder for peer:",t),i();let a=document.getElementById("tandem-container-"+t);if(a)return void console.log("[RemoteVideoManager] Placeholder already exists for peer:",t,"- reusing it");console.log("[RemoteVideoManager] Creating NEW placeholder container for peer:",t),a=document.createElement("div"),a.id="tandem-container-"+t,a.style.position="fixed",a.style.bottom="145px",a.style.right=20+180*e.size+"px",a.style.width="240px",a.style.height="160px",a.style.zIndex=999999,a.style.border="2px solid #00aaff",a.style.borderRadius="4px",a.style.backgroundColor="#000";const s=document.createElement("div");s.id="tandem-overlay-"+t,s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="rgba(0, 0, 0, 0.85)",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="center",s.style.color="#fff",s.style.fontSize="14px",s.style.fontFamily="Arial, sans-serif",s.style.borderRadius="4px",s.style.pointerEvents="none";const r=n(),l=document.createElement("div");l.textContent="Connecting...",l.style.fontWeight="500",s.appendChild(r),s.appendChild(l),a.appendChild(s),document.body.appendChild(a),o(a),console.log("[RemoteVideoManager] Created placeholder container:",a.id)},showWaitingIndicator:function(){i(),console.log("[RemoteVideoManager] Showing waiting indicator");const e=document.createElement("div");e.id="tandem-waiting-indicator",e.style.position="fixed",e.style.bottom="24px",e.style.right="20px",e.style.padding="8px 12px",e.style.zIndex=999999,e.style.border="1px solid rgba(56, 189, 248, 0.4)",e.style.borderRadius="999px",e.style.backgroundColor="rgba(15, 23, 42, 0.9)",e.style.display="flex",e.style.alignItems="center",e.style.gap="8px",e.style.color="#e2e8f0",e.style.fontSize="12px",e.style.fontFamily="Arial, sans-serif",e.style.pointerEvents="none",e.style.boxShadow="0 6px 18px rgba(0, 0, 0, 0.35)";const n=function(){t();const e=document.createElement("div");return e.className="tandem-dots",e.innerHTML='<span class="tandem-dot"></span><span class="tandem-dot"></span><span class="tandem-dot"></span>',e}(),o=document.createElement("div");o.textContent="Party started • waiting for others",o.style.fontWeight="500",o.style.letterSpacing="0.2px",e.appendChild(n),e.appendChild(o),document.body.appendChild(e)},hideWaitingIndicator:i}}(this.remoteVideos),a={},i=function({stateManager:e,sendSignal:t,remoteStreams:n,remoteVideos:o,addRemoteVideo:a,attemptReconnection:i,clearReconnection:s,removeRemoteVideo:r,peersThatLeft:l,showReconnecting:c,hideOverlay:d,showPlaceholder:g}){return function(m){console.log("[PeerConnection] Creating peer connection for peerId:",m),r(m),n.delete(m),g(m);const h=e.getState(),p=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return p.onicecandidate=e=>{e.candidate&&(console.log("[PeerConnection] ICE candidate for peer:",m,e.candidate),t({type:"ICE_CANDIDATE",from:h.userId,to:m,candidate:e.candidate}))},p.ontrack=e=>{console.log("[PeerConnection] ontrack fired for peer:",m,"track:",e.track,"streams:",e.streams);let t=e.streams&&e.streams[0]||n.get(m);if(t||(console.log("[PeerConnection] Creating new MediaStream for peer:",m),t=new MediaStream,n.set(m,t)),e.track){console.log("[PeerConnection] Adding track to stream:",e.track.kind,e.track.id);try{t.getTracks().find(t=>t.id===e.track.id)?console.log("[PeerConnection] Track already in stream, skipping"):t.addTrack(e.track)}catch(e){console.warn("[PeerConnection] Error adding track:",e)}}const i=o.has(m),s=!!document.getElementById("tandem-remote-"+m);if(i||s){console.log("[PeerConnection] Video already exists for peer:",m,"inMap:",i,"inDom:",s);const e=o.get(m)||document.getElementById("tandem-remote-"+m);e&&e.srcObject!==t&&(console.log("[PeerConnection] Updating existing video element with new stream"),e.srcObject=t,i||o.set(m,e))}else{const e=t.getTracks(),n=e.some(e=>"audio"===e.kind),o=e.some(e=>"video"===e.kind);console.log("[PeerConnection] Stream status - audio:",n,"video:",o,"total tracks:",e.length),n&&o?(console.log("[PeerConnection] Both tracks present, adding remote video for peer:",m),a(m,t)):console.log("[PeerConnection] Waiting for more tracks before creating video element")}},p.onconnectionstatechange=()=>{console.log("[PeerConnection] Connection state changed for peer:",m,"→",p.connectionState),"connected"===p.connectionState?(s(m),d(m)):"disconnected"===p.connectionState?l.has(m)?(r(m),s(m)):(console.log("[PeerConnection] Connection disconnected, attempting reconnection while keeping video visible"),c(m),i(m)):"failed"===p.connectionState?(console.log("[PeerConnection] Connection failed for peer:",m),l.has(m)?(r(m),s(m)):(r(m),i(m))):"closed"===p.connectionState&&(r(m),s(m))},p}}({stateManager:this.stateManager,sendSignal:e=>this._sendSignal(e),remoteStreams:this.remoteStreams,remoteVideos:this.remoteVideos,addRemoteVideo:o.add,attemptReconnection:e=>a.attempt(e),clearReconnection:e=>a.clear(e),removeRemoteVideo:e=>{o.remove(e),this.remoteStreams.delete(e)},peersThatLeft:this.peersThatLeft,showReconnecting:o.showReconnecting,hideOverlay:o.hideOverlay,showPlaceholder:o.showPlaceholder});Object.assign(a,function({stateManager:e,peerConnections:t,peersThatLeft:n,localStream:o,createPeer:a,sendSignal:i,addOrReplaceTrack:s}){const r=new Map,l=new Map;function c(e){r.delete(e);const t=l.get(e);t&&(clearTimeout(t),l.delete(e))}return{attempt:async function d(g){if(!e.isInParty())return;if(n.has(g))return void c(g);const m=r.get(g)||0,h=Math.min(500*Math.pow(2,m),1e4);if(m>=5)return console.log("[Reconnection] Max attempts reached for peer:",g),void c(g);console.log("[Reconnection] Attempting reconnection for peer:",g,"attempt:",m+1,"delay:",h+"ms"),r.set(g,m+1);const p=l.get(g);p&&clearTimeout(p);const u=setTimeout(async()=>{const n=t.get(g);if(n){try{n.close()}catch(e){}t.delete(g)}try{const n=a(g);t.set(g,n);const r="function"==typeof o?o():o;r&&r.getTracks().forEach(e=>s(n,e,r));const l=await n.createOffer();await n.setLocalDescription(l);const c=e.getState();i({type:"OFFER",from:c.userId,to:g,offer:n.localDescription})}catch(e){console.error("[WebRTCManager] Reconnection failed:",e),d(g)}},h);l.set(g,u)},clear:c}}({stateManager:this.stateManager,peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,localStream:()=>this.localStream,createPeer:i,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:n})),this.reconnectionManager=a,this.createPeer=i,this.videoManager=o,this.signalingHandlers=function({getState:e,peerConnections:t,peersThatLeft:n,getLocalStream:o,createPeer:a,sendSignal:i,addOrReplaceTrack:s,clearReconnection:r,removeRemoteVideo:l}){return{async handleJoin(c){console.log("[Signaling] Handling JOIN from",c);const d=e();if(c===d.userId)return void console.log("[Signaling] Ignoring JOIN from self");r(c),n.delete(c);let g=t.get(c);if(g){const e=g.connectionState;if(console.log("[Signaling] Already have peer connection for",c,"state:",e),"connected"===e||"connecting"===e){console.log("[Signaling] Reusing existing connection - ensuring tracks are present");const e=o();if(e){let t=!1;if(e.getTracks().forEach(n=>{const o=g.getSenders().find(e=>e.track&&e.track.kind===n.kind);o&&o.track.id===n.id||(console.log("[Signaling] Track changed, replacing:",n.kind,n.id),s(g,n,e),t=!0)}),t&&"stable"===g.signalingState){console.log("[Signaling] Renegotiating due to track changes");const e=await g.createOffer();await g.setLocalDescription(e),i({type:"OFFER",from:d.userId,to:c,offer:g.localDescription})}}return}console.log("[Signaling] Cleaning up existing connection in state:",e),r(c),l(c);try{g.close()}catch(e){}t.delete(c),g=null}if(!g)try{console.log("[Signaling] Creating new peer connection for",c),g=a(c),t.set(c,g);const e=o();console.log("[Signaling] Local stream:",e,"tracks:",e?e.getTracks().length:0),e?e.getTracks().forEach(t=>{console.log("[Signaling] Adding local track to peer:",t.kind,t.id),s(g,t,e)}):console.warn("[Signaling] No local stream available when handling JOIN"),console.log("[Signaling] Creating and sending OFFER to",c);const n=await g.createOffer();await g.setLocalDescription(n),i({type:"OFFER",from:d.userId,to:c,offer:g.localDescription})}catch(e){console.error("[Signaling] Error handling JOIN:",e),t.delete(c)}},async handleOffer(l,c){console.log("[Signaling] Handling OFFER from",l);const d=e();if(l===d.userId)return void console.log("[Signaling] Ignoring OFFER from self");let g=t.get(l);if(g)if(console.log("[Signaling] Existing peer connection state:",g.signalingState),"closed"!==g.signalingState&&"stable"!==g.signalingState){console.log("[Signaling] Closing existing peer connection in state:",g.signalingState);try{g.close()}catch(e){}t.delete(l),g=null}else if("stable"===g.signalingState){console.log("[Signaling] Closing stable peer connection for renegotiation");try{g.close()}catch(e){}t.delete(l),g=null}g||(console.log("[Signaling] Creating new peer connection for",l),r(l),n.delete(l),g=a(l),t.set(l,g));try{console.log("[Signaling] Setting remote description, current state:",g.signalingState),await g.setRemoteDescription(new RTCSessionDescription(c));const e=o();console.log("[Signaling] Local stream:",e,"tracks:",e?e.getTracks().length:0),e?e.getTracks().forEach(t=>{console.log("[Signaling] Adding local track to peer:",t.kind,t.id),s(g,t,e)}):console.warn("[Signaling] No local stream available when handling OFFER"),console.log("[Signaling] Creating and sending ANSWER to",l);const t=await g.createAnswer();await g.setLocalDescription(t),i({type:"ANSWER",from:d.userId,to:l,answer:g.localDescription})}catch(e){console.error("[Signaling] Error handling offer:",e.name,e.message),console.error("[Signaling] Full error:",e),t.delete(l);try{g.close()}catch(e){}}},async handleAnswer(e,n){console.log("[Signaling] Handling ANSWER from",e);const o=t.get(e);if(o)if(console.log("[Signaling] Peer connection state:",{signalingState:o.signalingState,connectionState:o.connectionState,iceConnectionState:o.iceConnectionState}),"have-local-offer"===o.signalingState){console.log("[Signaling] Setting remote description from ANSWER");try{await o.setRemoteDescription(new RTCSessionDescription(n)),console.log("[Signaling] Remote description set successfully")}catch(n){if(console.error("[Signaling] Error handling answer:",n.name,n.message),console.error("[Signaling] Full error:",n),"InvalidStateError"===n.name||"OperationError"===n.name){console.log("[Signaling] Closing peer connection due to state error");try{o.close()}catch(e){}t.delete(e)}}}else"stable"===o.signalingState?console.log("[Signaling] Received ANSWER but already in stable state (connection:",o.connectionState+") - likely duplicate, ignoring"):"have-remote-offer"===o.signalingState?console.warn("[Signaling] Received ANSWER but expecting to send one (have-remote-offer) - might be glare, ignoring"):"closed"===o.signalingState?console.warn("[Signaling] Received ANSWER but peer connection is closed - ignoring"):console.warn("[Signaling] Cannot handle ANSWER - unexpected state:",o.signalingState);else console.warn("[Signaling] Cannot handle ANSWER - no peer connection found for",e)},async handleIceCandidate(e,n){console.log("[Signaling] Handling ICE_CANDIDATE from",e);const o=t.get(e);if(o)try{await o.addIceCandidate(new RTCIceCandidate(n)),console.log("[Signaling] ICE candidate added successfully")}catch(e){console.warn("[Signaling] Error adding ICE candidate",e)}else console.warn("[Signaling] No peer connection found for ICE candidate from",e)},handleLeave(e){console.log("[Signaling] Handling LEAVE from",e),n.add(e);const o=t.get(e);if(o){try{o.close()}catch(e){}t.delete(e)}r(e),l(e)}}}({getState:()=>this.stateManager.getState(),peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,getLocalStream:()=>this.localStream,createPeer:i,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:n,clearReconnection:a.clear,removeRemoteVideo:e=>{o.remove(e),this.remoteStreams.delete(e)}})}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}onLocalStreamAvailable(e){this.localStream=e,this.peerConnections.forEach(t=>{try{e.getTracks().forEach(o=>n(t,o,e))}catch(e){}})}async handleSignal(e){if(console.log("[WebRTCManager] handleSignal called with:",e),!e||!e.type)return void console.warn("[WebRTCManager] Invalid message:",e);const t=e.type,n=e.userId||e.from,o=e.to,a=this.stateManager.getState();console.log("[WebRTCManager] Processing signal type:",t,"from:",n,"to:",o,"myId:",a.userId),"OFFER"!==t&&"ANSWER"!==t&&"ICE_CANDIDATE"!==t&&"SYNC_RESPONSE"!==t||!o||o===a.userId?"JOIN"===t&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleJoin"),await this.signalingHandlers.handleJoin(n)):"OFFER"===t&&e.offer&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleOffer"),await this.signalingHandlers.handleOffer(n,e.offer)):"ANSWER"===t&&e.answer&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleAnswer"),await this.signalingHandlers.handleAnswer(n,e.answer)):"ICE_CANDIDATE"===t&&e.candidate&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleIceCandidate"),await this.signalingHandlers.handleIceCandidate(n,e.candidate)):"LEAVE"===t&&n?(console.log("[WebRTCManager] Dispatching to handleLeave"),this.signalingHandlers.handleLeave(n)):console.log("[WebRTCManager] Signal not handled - type:",t,"from:",n,"fromSelf:",n===a.userId,"reasons:",{JOIN:"JOIN"===t?`from=${!!n}, notSelf=${n!==a.userId}`:"N/A",OFFER:"OFFER"===t?`hasOffer=${!!e.offer}, from=${!!n}, notSelf=${n!==a.userId}`:"N/A",ANSWER:"ANSWER"===t?`hasAnswer=${!!e.answer}, from=${!!n}, notSelf=${n!==a.userId}`:"N/A",ICE:"ICE_CANDIDATE"===t?`hasCandidate=${!!e.candidate}, from=${!!n}, notSelf=${n!==a.userId}`:"N/A",LEAVE:"LEAVE"===t?`from=${!!n}`:"N/A"}):console.log("[WebRTCManager] Ignoring targeted message not meant for me")}attemptReconnection(e){return this.reconnectionManager.attempt(e)}_sendSignal(e){this.stateManager.safeSendMessage({type:"SIGNAL_SEND",message:e},function(){})}showWaitingIndicator(){console.log("[WebRTCManager] Showing waiting indicator"),this.videoManager.showWaitingIndicator()}hideWaitingIndicator(){console.log("[WebRTCManager] Hiding waiting indicator"),this.videoManager.hideWaitingIndicator()}clearAll(){console.log("[WebRTCManager] Clearing all connections and videos"),this.hideWaitingIndicator(),this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.peersThatLeft.clear(),this.remoteVideos.forEach((e,t)=>{try{e.srcObject&&(e.srcObject.getTracks().forEach(e=>e.stop()),e.srcObject=null)}catch(e){}const n=document.getElementById("tandem-container-"+t);n?(console.log("[WebRTCManager] Removing container for peer:",t),n.remove()):e.parentElement?e.parentElement.remove():e.remove()}),this.remoteVideos.clear(),this.remoteStreams.clear(),document.querySelectorAll('[id^="tandem-container-"]').forEach(e=>{console.log("[WebRTCManager] Removing orphaned container:",e.id),e.remove()}),document.querySelectorAll('[id^="tandem-remote-"]').forEach(e=>{console.log("[WebRTCManager] Removing orphaned video:",e.id),e.remove()}),document.querySelectorAll('[id^="tandem-overlay-"]').forEach(e=>{console.log("[WebRTCManager] Removing orphaned overlay:",e.id),e.remove()}),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}}(a,i),c=new class{constructor(e,t,n,o,a){this.stateManager=e,this.netflixController=a,this.urlMonitorInterval=null,this.lastUrl=null,this.lastNormalizedUrl=null,this.lastVideoEndedTime=0,this.videoEndListener=null,this.recentAutoAdvanceUrl=null,this.recentAutoAdvanceTime=0,this.pendingAutoAdvanceUrl=null,this.pendingAutoAdvanceTime=0,this.nextEpisodeObserver=null,this.onWatchPageChange=t||(()=>{}),this.onNavigateToWatch=n||(()=>{}),this.onLeaveWatch=o||(()=>{}),this.handleUrlChange=this.handleUrlChange.bind(this)}handleUrlChange(){const e=window.location.href,t=this.normalizeUrl(e),n=this.lastNormalizedUrl;if(t!==n){const o=this.lastUrl;console.log("[URLSync] URL changed from",o,"to",e);const a=n?new URL(n).pathname:"",i=new URL(t).pathname,s=a.startsWith("/watch"),r=a.startsWith("/browse"),l=i.startsWith("/watch"),c=s&&l&&a!==i,d=!s&&l,g=r&&l,m=s&&!l;if(this.lastUrl=e,this.lastNormalizedUrl=t,g&&(console.log("[URLSync] Navigated from browse to /watch - setting auto-play flag"),sessionStorage.setItem("tandem_from_browse","true")),c){console.log("[URLSync] Watch page changed - triggering sync reinitialization");try{sessionStorage.setItem("tandem_watch_transition",JSON.stringify({from:n||o,to:t||e,timestamp:Date.now()}))}catch(e){console.warn("[URLSync] Failed to record watch transition:",e)}this.onWatchPageChange()}d&&(console.log("[URLSync] Navigated to /watch page - triggering sync initialization"),this.onNavigateToWatch()),m&&(console.log("[URLSync] Left /watch page - triggering sync teardown"),this.onLeaveWatch());const h=this.stateManager.getState(),p=Date.now()-this.lastVideoEndedTime<5e3,u=this.pendingAutoAdvanceUrl===n&&Date.now()-this.pendingAutoAdvanceTime<6e4;let y=p||u;!y&&c&&this.netflixController&&this.netflixController.getPlayerState().then(e=>{if(e&&e.duration&&e.currentTime){const t=e.currentTime/e.duration;t>.9&&(console.log("[URLSync] URL changed at",(100*t).toFixed(1)+"% of video - likely auto-advance"),this.lastVideoEndedTime=Date.now(),this.recentAutoAdvanceUrl=n||o,this.recentAutoAdvanceTime=Date.now())}}).catch(()=>{}),y&&(this.recentAutoAdvanceUrl=n||o,this.recentAutoAdvanceTime=Date.now());let f=!c||c&&!y;c&&y&&console.log("[URLSync] Auto-advance detected, not broadcasting"),h.partyActive&&f&&(console.log("[URLSync] Broadcasting URL change to party:",i),this.stateManager.safeSendMessage({type:"URL_CHANGE",url:t||e})),h.partyActive&&m&&(console.log("[URLSync] Left /watch page - sending pause to all clients"),this.stateManager.safeSendMessage({type:"PLAY_PAUSE",control:"pause",timestamp:0}))}}start(){this.lastUrl=window.location.href,this.lastNormalizedUrl=this.normalizeUrl(this.lastUrl),console.log("[URLSync] Starting URL monitoring, current URL:",this.lastUrl),this.stop(),window.addEventListener("popstate",this.handleUrlChange);const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.handleUrlChange()},history.replaceState=(...e)=>{t.apply(history,e),this.handleUrlChange()},this.urlMonitorInterval=setInterval(()=>{this.handleUrlChange()},500);const n=()=>{const e=document.querySelector("video");e?(this.videoEndListener&&e.removeEventListener("ended",this.videoEndListener),this.videoEndListener=()=>{console.log("[URLSync] Video ended - recording timestamp for auto-advance detection"),this.lastVideoEndedTime=Date.now()},e.addEventListener("ended",this.videoEndListener),console.log("[URLSync] Attached ended listener to video element")):setTimeout(n,1e3)};n();const o=()=>{if(!document.querySelector('[data-uia="next-episode-seamless-button"]'))return;const e=Date.now();e-this.pendingAutoAdvanceTime<2e3||(this.pendingAutoAdvanceUrl=this.lastNormalizedUrl||this.lastUrl,this.pendingAutoAdvanceTime=e,console.log("[URLSync] Next episode prompt detected - marking pending auto-advance"))};this.nextEpisodeObserver&&this.nextEpisodeObserver.disconnect(),this.nextEpisodeObserver=new MutationObserver(()=>o()),document.body&&this.nextEpisodeObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0}),o()}stop(){console.log("[URLSync] Stopping URL monitoring"),this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null),this.videoEndListener&&(document.querySelectorAll("video").forEach(e=>e.removeEventListener("ended",this.videoEndListener)),this.videoEndListener=null),this.nextEpisodeObserver&&(this.nextEpisodeObserver.disconnect(),this.nextEpisodeObserver=null),window.removeEventListener("popstate",this.handleUrlChange),this.lastUrl=null,this.lastNormalizedUrl=null}normalizeUrl(e){if(!e)return null;try{const t=new URL(e),n=t.pathname;if(!n.startsWith("/watch"))return t.origin+n;const o=t.searchParams.get("trackId"),a=o?`${n}?trackId=${encodeURIComponent(o)}`:n;return t.origin+a}catch(t){return e}}saveState(){const e=this.stateManager.getState();if(!e.partyActive)return;const t=this.getRestorationState()||{},n={roomId:e.roomId,currentTime:t.currentTime||null,isPlaying:"boolean"==typeof t.isPlaying?t.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("tandem_restore",JSON.stringify(n))}clearState(){sessionStorage.removeItem("tandem_restore")}getRestorationState(){const e=sessionStorage.getItem("tandem_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[tandem] Failed to parse restoration state:",e)}return null}shouldSuppressSyncResponse(e){if(!this.recentAutoAdvanceUrl||!e)return!1;const t=Date.now()-this.recentAutoAdvanceTime;if(t>3e4)return!1;const n=this.extractEpisodeId(e);return n===this.extractEpisodeId(this.recentAutoAdvanceUrl)&&(console.log(`[URLSync] Suppressing sync response - would revert auto-advance from ${n} (${t}ms old)`),!0)}extractEpisodeId(e){if(!e)return null;try{const t=new URL(e);return t.searchParams.get("trackId")||t.pathname}catch(e){return null}}}(a,()=>{console.log("[Content Script] Watch page changed - reinitializing sync manager"),a.getState().partyActive?(console.log("[Content Script] Party is active, reinitializing sync manager"),r.teardown(),r.setup().catch(e=>{console.error("[Content Script] Failed to reinitialize sync manager:",e)})):console.log("[Content Script] Party not active, skipping sync manager reinitialization")},()=>{console.log("[Content Script] Navigated to /watch page"),a.getState().partyActive&&(console.log("[Content Script] Party is active, initializing sync manager"),r.teardown(),r.setup().catch(e=>{console.error("[Content Script] Failed to initialize sync manager:",e)}))},()=>{console.log("[Content Script] Left /watch page"),r.teardown()},s);r.setUrlSync(c),console.log("[Content Script] Managers initialized");let d=null,g=null;function m(){g||(g=setInterval(()=>{a.getState().partyActive&&(d&&!document.getElementById("tandem-local-preview")&&(console.log("[Content Script] Local preview missing, re-attaching"),i.attachLocalPreview(d)),i.getRemoteVideos(),i.getRemoteStreams().forEach((e,t)=>{const n="tandem-remote-"+t;if(!document.getElementById(n)){console.log("[Content Script] Remote video missing for peer:",t,"re-adding");const n=l.videoManager;n&&n.add&&n.add(t,e)}}))},250),console.log("[Content Script] Started video element monitoring"))}o&&(console.log("[Content Script] Party was active, checking for restoration state..."),setTimeout(()=>{a.getState().partyActive&&d&&(console.log("[Content Script] Restoring local preview video after navigation"),document.getElementById("tandem-local-preview")||i.attachLocalPreview(d))},100)),function(){if(!a.getState().partyActive)try{const e=new URL(window.location.href),t=e.searchParams.get("tandemRoom");if(!t)return;console.log("[Content Script] Found tandemRoom in URL, joining room:",t),e.searchParams.delete("tandemRoom"),history.replaceState({},document.title,e.toString()),chrome.runtime.sendMessage({type:"START_PARTY",roomId:t},e=>{e&&e.success?console.log("[Content Script] Joined party from link successfully"):console.error("[Content Script] Failed to join party from link:",e?e.error:"Unknown error")})}catch(e){console.error("[Content Script] Failed to process tandemRoom in URL:",e)}}(),function(){const e=c.getRestorationState();e&&(console.log("[Content Script] Restoring party state for room:",e.roomId),c.clearState(),a.setRestoringFlag(!0),setTimeout(function(){console.log("[Content Script] Sending RESTORE_PARTY message"),chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:e.roomId},e=>{e&&e.success?(console.log("[Content Script] Party restoration successful - setting state with userId:",e.userId),a.startParty(e.userId,e.roomId),console.log("[Content Script] Re-obtaining media stream after navigation"),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{console.log("[Content Script] Media stream obtained after restoration"),d=e,l.setLocalStream(e),l.onLocalStreamAvailable(e),i.attachLocalPreview(e),r.teardown(),r.setup().catch(e=>{console.error("[Content Script] Failed to setup sync manager after restoration:",e)}),c.start(),m()}).catch(e=>{console.error("[Content Script] Failed to get media stream after restoration:",e)})):console.error("[Content Script] Party restoration failed:",e?e.error:"Unknown error"),setTimeout(function(){a.setRestoringFlag(!1)},2e3)})},1e3))}(),chrome.runtime.onMessage.addListener((e,t,n)=>{if(console.log("[Content Script] Received message:",e.type),"GET_MEDIA_STATE"===e.type){const e=d?d.getAudioTracks()[0]:null,t=d?d.getVideoTracks()[0]:null;return n({success:!0,state:{audioEnabled:!!e&&e.enabled,videoEnabled:!!t&&t.enabled,hasStream:!!d}}),!0}if("TOGGLE_MIC"===e.type){if(!d)return n({success:!1,error:"No local stream"}),!0;const e=d.getAudioTracks();if(!e.length)return n({success:!1,error:"No audio track"}),!0;const t=!e[0].enabled;return e.forEach(e=>{e.enabled=t}),n({success:!0,state:{audioEnabled:t,videoEnabled:d.getVideoTracks()[0]?.enabled??!1,hasStream:!0}}),!0}if("TOGGLE_CAMERA"===e.type){if(!d)return n({success:!1,error:"No local stream"}),!0;const e=d.getVideoTracks();if(!e.length)return n({success:!1,error:"No video track"}),!0;const t=!e[0].enabled;return e.forEach(e=>{e.enabled=t}),n({success:!0,state:{audioEnabled:d.getAudioTracks()[0]?.enabled??!1,videoEnabled:t,hasStream:!0}}),!0}if("REQUEST_MEDIA_STREAM"===e.type)return console.log("[Content Script] Processing REQUEST_MEDIA_STREAM"),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{console.log("[Content Script] Media stream obtained, tracks:",e.getTracks().length),d=e,console.log("[Content Script] Setting local stream on WebRTC manager"),l.setLocalStream(e),l.onLocalStreamAvailable(e),console.log("[Content Script] Attaching local preview to UI"),i.attachLocalPreview(e),console.log("[Content Script] Local preview attached, sending success response"),n({success:!0})}).catch(e=>{console.error("[Content Script] Failed to get media stream:",e),n({success:!1,error:e.message})}),!0;if("PARTY_STARTED"===e.type&&(console.log("[Content Script] Party started:",e.userId,e.roomId),a.startParty(e.userId,e.roomId),i.showConnectionIndicator(),setTimeout(()=>{s.setVolume(.15).then(()=>{console.log("[Content Script] Set Netflix volume to 15%")}).catch(e=>{console.warn("[Content Script] Failed to set volume:",e)})},1e3),r.teardown(),r.setup().catch(e=>{console.error("[Content Script] Failed to setup sync manager:",e)}),c.start(),m(),n({success:!0})),"ROOM_STATE"===e.type&&e.hostUserId&&(console.log("[Content Script] Room state received - hostUserId:",e.hostUserId),r.setHostUserId(e.hostUserId)),"PARTY_STOPPED"===e.type&&(console.log("[Content Script] Stopping party"),g&&(clearInterval(g),g=null,console.log("[Content Script] Stopped video element monitoring")),a.stopParty(),r.teardown(),c.stop(),c.clearState(),l.clearAll(),i.removeLocalPreview(),i.removeConnectionIndicator(),d&&(d.getTracks().forEach(e=>e.stop()),d=null),n({success:!0})),"SIGNAL"===e.type&&(console.log("[Content Script] Handling SIGNAL:",e.message?.type),l.handleSignal(e.message)),"APPLY_PLAYBACK_CONTROL"===e.type){if(!window.location.pathname.startsWith("/watch"))return void console.log("[Content Script] Ignoring playback control - not on /watch page");console.log("[Content Script] Applying playback control:",e.control,"at",e.currentTime,"from",e.fromUserId),r.handlePlaybackControl(e.control,e.currentTime,e.fromUserId,e.eventTimestamp)}if("APPLY_SEEK"===e.type){if(!window.location.pathname.startsWith("/watch"))return void console.log("[Content Script] Ignoring seek - not on /watch page");r.handleSeek(e.currentTime,e.isPlaying,e.fromUserId,e.eventTimestamp)}if("APPLY_SEEK_PAUSE"===e.type){if(!window.location.pathname.startsWith("/watch"))return void console.log("[Content Script] Ignoring seek-pause - not on /watch page");r.handleSeekPause(e.currentTime,e.fromUserId)}if("APPLY_URL_CHANGE"===e.type){if(console.log("[Content Script] Received URL change request:",e.url,"from",e.fromUserId),a.restoringPartyState)return void console.log("[Content Script] Ignoring URL change - currently restoring party state");new URL(e.url);const t=window.location.href;if(window.location.pathname.startsWith("/watch"))try{const n=sessionStorage.getItem("tandem_watch_transition");if(n){const o=JSON.parse(n),a=Date.now()-o.timestamp<15e3,i=o.from===e.url&&o.to===t;if(a&&i)return void console.log("[Content Script] Ignoring URL change back to previous episode during auto-advance")}}catch(e){console.warn("[Content Script] Failed to check watch transition state:",e)}if(t===e.url)return void console.log("[Content Script] Already on this URL, skipping navigation");console.log("[Content Script] Navigating to:",e.url,"using SPA navigation"),window.location.pathname.startsWith("/watch")&&c.saveState();try{window.history.pushState({},"",e.url),window.dispatchEvent(new PopStateEvent("popstate",{state:{}})),console.log("[Content Script] SPA navigation triggered")}catch(t){console.error("[Content Script] Failed to navigate via pushState, falling back to full reload:",t),window.location.href=e.url}}if("HANDLE_REQUEST_SYNC"===e.type){if(!window.location.pathname.startsWith("/watch"))return void console.log("[Content Script] Ignoring sync request - not on /watch page");r.handleRequestSync(e.fromUserId,e.respectAutoPlay)}if("APPLY_SYNC_RESPONSE"===e.type){if(!window.location.pathname.startsWith("/watch"))return void console.log("[Content Script] Ignoring sync response - not on /watch page");console.log("[Content Script] Applying sync response from",e.fromUserId,"URL:",e.url,e.respectAutoPlay?"(respecting auto-play)":""),r.handleSyncResponse(e.currentTime,e.isPlaying,e.fromUserId,e.url,e.respectAutoPlay)}if("HOST_HEARTBEAT"===e.type){if(!window.location.pathname.startsWith("/watch"))return;r.handleHostHeartbeat(e.currentTime,e.isPlaying,e.fromUserId,e.eventTimestamp)}"REQUEST_INITIAL_SYNC_AND_PLAY"===e.type&&(console.log("[Content Script] Requesting initial sync and will auto-play when synced"),a.safeSendMessage({type:"REQUEST_SYNC"})),"CONNECTION_STATUS"===e.type&&(console.log("[Content Script] Connection status changed:",e.status),i.updateConnectionIndicator(e.status)),"RECONNECTED"===e.type&&console.log("[Content Script] WebSocket reconnected, userId:",e.userId),"REQUEST_SYNC_AFTER_RECONNECT"===e.type&&window.location.pathname.startsWith("/watch")&&a.isActive()&&(console.log("[Content Script] Requesting sync after reconnection"),a.safeSendMessage({type:"REQUEST_SYNC"}))}),window.addEventListener("beforeunload",()=>{a.isActive()&&c.saveState()})})();
//# sourceMappingURL=content-script.js.map